# Story 1.5: Basic Formatting (`/` command)

**Status:** Done

## User Story

As a user, I want to format my text using a command menu and keyboard shortcuts, so that I can structure my thoughts without using a distracting toolbar.

## Description

This story implements the `/` command menu that appears when users type a forward slash in the editor. The menu provides quick access to insert basic content blocks including headings, lists, quotes, code blocks, and horizontal rules without leaving the keyboard. Additionally, this story implements inline text formatting shortcuts (bold and italic) using standard keyboard shortcuts.

## Acceptance Criteria

- [ ] Typing `/` in the editor triggers a command menu to appear
- [ ] The menu includes options for: Heading 1, Heading 2, Heading 3, Bulleted List, Numbered List, Quote, Code Block, Callout, and Horizontal Rule
- [ ] Selecting an option from the menu inserts the corresponding block
- [ ] Callout blocks have a pale blue background in light mode and grey background in dark mode
- [ ] The menu can be navigated with arrow keys
- [ ] Pressing Enter selects the highlighted menu item
- [ ] Pressing Escape closes the menu
- [ ] The menu filters options as the user continues typing after `/`
- [ ] Cmd+B (Mac) / Ctrl+B (Windows/Linux) toggles bold formatting on selected text
- [ ] Cmd+I (Mac) / Ctrl+I (Windows/Linux) toggles italic formatting on selected text

## Tasks / Subtasks

### Task 1: Install TipTap Slash Command Dependencies (Est: 0.5 hours)

**Objective:** Install required TipTap extension packages for slash command functionality.

#### Subtask 1.1: Install suggestion extension
- Run: `npm install @tiptap/suggestion`
- This provides the core suggestion infrastructure for slash commands
- Verify installation in package.json

#### Subtask 1.2: Install additional utilities and text formatting extensions
- Run: `npm install tippy.js` (for popup positioning)
- Run: `npm install @types/tippy.js --save-dev`
- Run: `npm install @tiptap/extension-highlight` (for callout styling base)
- Run: `npm install @tiptap/extension-bold @tiptap/extension-italic` (for text formatting)
- Verify installations complete successfully

**Expected Outcome:** All required packages installed and ready for implementation.

---

### Task 2: Create Custom Callout Extension (Est: 1.5 hours)

**Objective:** Build a custom TipTap Node extension for callout blocks with themed background colors.

#### Subtask 2.1: Create callout extension file
- Create file: `lib/editor/callout.ts`
- Import necessary TipTap Node utilities
- Set up basic Node extension structure

#### Subtask 2.2: Define callout node schema
- Define node as a block-level element
- Set content to allow text and inline formatting
- Make it selectable and deletable as a unit
- Add custom class for CSS targeting

#### Subtask 2.3: Add parsing and rendering rules
- Configure how callout is parsed from content
- Define how callout is rendered to DOM
- Add custom wrapper div with `callout-block` class
- Ensure content is editable within the callout

#### Subtask 2.4: Add callout commands
- Create `setCallout` command to convert current block to callout
- Create `toggleCallout` command to toggle on/off
- Ensure commands work with TipTap chain API

**Expected Outcome:** Custom callout extension that creates styled block containers.

---

### Task 3: Create Slash Command Extension (Est: 2.5 hours)

**Objective:** Build a custom TipTap extension that handles the `/` command trigger and suggestion logic.

#### Subtask 3.1: Create extension file
- Create file: `lib/editor/slash-command.ts`
- Import necessary TipTap and suggestion utilities
- Set up basic extension structure

#### Subtask 3.2: Configure suggestion behavior
- Configure trigger character as `/`
- Set up suggestion matching logic
- Define suggestion start/end handlers
- Configure keyboard navigation (ArrowUp, ArrowDown, Enter, Escape)

#### Subtask 3.3: Define command items
- Create array of command items with properties:
  - `title`: Display name (e.g., "Heading 1")
  - `icon`: Lucide icon component
  - `command`: TipTap chain command to execute
  - `keywords`: Search terms for filtering (e.g., ["h1", "heading", "title"])
- Include commands for: Heading 1, Heading 2, Heading 3, Bulleted List, Numbered List, Blockquote, Code Block, Callout, Horizontal Rule
- Add Info icon for Callout command
- Callout command should use `setCallout()` from custom extension

#### Subtask 3.4: Implement filtering logic
- Filter command items based on user input after `/`
- Support keyword matching (case-insensitive)
- Return filtered list of matching commands

**Expected Outcome:** Functional slash command extension with command definitions and filtering logic.

---

### Task 4: Create Command Menu Component (Est: 3 hours)

**Objective:** Build the React component that renders the command menu popup.

#### Subtask 4.1: Create CommandMenu component file
- Create file: `components/editor/CommandMenu.tsx`
- Define component props interface (items, selectedIndex, onSelect)
- Set up basic component structure with 'use client' directive

#### Subtask 4.2: Implement menu rendering
- Render list of command items
- Display icon and title for each item
- Highlight selected item based on selectedIndex
- Apply hover states for interactivity

#### Subtask 4.3: Style the menu
- Use CSS variables for all colors
- Create card-like appearance with subtle shadow
- Add border using `--border` variable
- Set background to `--card` variable
- Position menu using absolute positioning
- Set appropriate z-index to appear above editor content
- Add smooth transition animations for appear/disappear

#### Subtask 4.4: Add keyboard navigation visual feedback
- Highlight selected item with `--accent` color
- Show hover state with subtle background change
- Display icons with consistent sizing (lucide-react)
- Ensure sufficient contrast for accessibility

**Expected Outcome:** Polished command menu component with proper styling and visual feedback.

---

### Task 5: Integrate Menu with Editor State (Est: 2 hours)

**Objective:** Connect the command menu to TipTap editor state and handle suggestion lifecycle.

#### Subtask 5.1: Create suggestion renderer
- Implement `render()` function in slash command extension
- Create DOM element to mount React component
- Use ReactDOM.render to mount CommandMenu component
- Handle positioning with Tippy.js or custom positioning logic

#### Subtask 5.2: Implement state management
- Track selected index in component state
- Handle arrow key navigation to update selected index
- Implement Enter key to execute selected command
- Implement Escape key to close menu

#### Subtask 5.3: Handle command execution
- Call TipTap editor chain commands on selection
- Convert current text node to selected block type
- Clear the `/` trigger text
- Return focus to editor after command execution

#### Subtask 5.4: Handle menu lifecycle
- Show menu when `/` is typed
- Hide menu when:
  - Command is executed
  - Escape is pressed
  - User clicks outside
  - Editor loses focus
  - Cursor moves away from trigger position

**Expected Outcome:** Fully integrated command menu that responds to keyboard input and executes commands correctly.

---

### Task 6: Update TipTapEditor Component (Est: 1.5 hours)

**Objective:** Add the slash command extension to the existing TipTap editor configuration.

#### Subtask 6.1: Import extensions
- Import SlashCommand extension from `lib/editor/slash-command.ts`
- Import Callout extension from `lib/editor/callout.ts`
- Import Bold and Italic extensions from TipTap
- Import required types and utilities

#### Subtask 6.2: Add extensions to editor
- Add Bold extension to extensions array with keyboard shortcuts enabled
- Add Italic extension to extensions array with keyboard shortcuts enabled
- Add Callout to extensions array in TipTapEditor.tsx
- Add SlashCommand to extensions array
- Configure extension options if needed
- Ensure proper ordering of extensions

#### Subtask 6.3: Verify StarterKit compatibility
- Ensure slash commands work with existing StarterKit extensions
- Test that heading, list, blockquote, code block commands function correctly
- Verify callout command works
- Verify horizontal rule insertion works
- Test bold and italic keyboard shortcuts work correctly

#### Subtask 6.4: Test editor initialization and keyboard shortcuts
- Verify editor loads without errors
- Check that typing `/` triggers the menu
- Test Cmd+B / Ctrl+B toggles bold on selected text
- Test Cmd+I / Ctrl+I toggles italic on selected text
- Confirm all existing functionality remains intact

**Expected Outcome:** TipTapEditor successfully integrated with slash command functionality.

---

### Task 7: Add CSS for Command Menu and Callout (Est: 1.5 hours)

**Objective:** Add necessary CSS for command menu styling, animations, and callout block theming.

#### Subtask 7.1: Create command menu styles
- Add styles to `app/globals.css`
- Define command menu container styles
- Style command item list
- Add hover and selected states

#### Subtask 7.2: Add animations
- Create fade-in animation for menu appearance
- Add transition for selected item highlighting
- Ensure smooth visual feedback

#### Subtask 7.3: Create callout block styles
- Add CSS variable `--callout-bg-light` with pale blue color (#EBF5FF or similar)
- Add CSS variable `--callout-bg-dark` with grey color (#374151 or similar)
- Define `.callout-block` class with:
  - Background: `var(--callout-bg-light)` in light mode
  - Background: `var(--callout-bg-dark)` in dark mode
  - Appropriate padding, border-radius, and left border accent
- Ensure callout content is properly formatted

#### Subtask 7.4: Ensure theme compatibility
- Test styles in light mode (pale blue callout)
- Test styles in dark mode (grey callout)
- Verify all colors use CSS variables
- Confirm proper contrast ratios for accessibility

**Expected Outcome:** Command menu has polished, accessible styling with smooth animations.

---

### Task 8: Implement TypeScript Types (Est: 0.5 hours)

**Objective:** Define comprehensive TypeScript interfaces for slash command system.

#### Subtask 8.1: Define command item interface
- Create `CommandItem` interface in `types/index.ts`
- Include properties: title, icon, command, keywords
- Export type for use in extension and component

#### Subtask 8.2: Define component prop types
- Define `CommandMenuProps` interface
- Include: items, selectedIndex, onSelect callback
- Ensure all props properly typed

#### Subtask 8.3: Type suggestion callbacks
- Define types for suggestion `onStart`, `onUpdate`, `onExit` callbacks
- Ensure editor instance types are correct

**Expected Outcome:** Complete TypeScript coverage for slash command system.

---

### Task 9: Add Accessibility Features (Est: 1 hour)

**Objective:** Ensure command menu is accessible to keyboard and screen reader users.

#### Subtask 9.1: Add ARIA attributes
- Add `role="listbox"` to menu container
- Add `role="option"` to each menu item
- Add `aria-selected` to selected item
- Add `aria-label` to provide context

#### Subtask 9.2: Implement keyboard navigation
- Verify arrow keys navigate correctly
- Ensure Enter activates selection
- Confirm Escape closes menu
- Test Tab key behavior (should close menu)

#### Subtask 9.3: Add screen reader announcements
- Announce menu opening
- Announce selected item as user navigates
- Announce when menu closes

**Expected Outcome:** Command menu fully accessible to all users.

---

### Task 10: Testing and Quality Assurance (Est: 2.5 hours)

**Objective:** Comprehensive testing of slash command functionality.

#### Subtask 10.1: Test basic functionality
- Type `/` and verify menu appears
- Navigate menu with arrow keys
- Select items with Enter key
- Close menu with Escape key
- Verify all command types insert correctly (including Callout)

#### Subtask 10.2: Test keyboard shortcuts for text formatting
- Select text and press Cmd+B / Ctrl+B to verify bold toggle
- Select text and press Cmd+I / Ctrl+I to verify italic toggle
- Test bold on empty selection (should enable bold for typing)
- Test italic on empty selection (should enable italic for typing)
- Test combining bold and italic on same text
- Verify shortcuts work within different block types (headings, lists, etc.)

#### Subtask 10.3: Test callout specifically
- Insert callout block via `/callout` command
- Verify pale blue background in light mode (#EBF5FF or similar)
- Switch to dark mode and verify grey background (#374151 or similar)
- Test typing and formatting within callout block
- Verify callout can be deleted and recreated

#### Subtask 10.4: Test filtering
- Type `/h` and verify only heading-related commands show
- Type `/list` and verify list commands appear
- Type `/call` and verify callout appears
- Type invalid text and verify empty state or "no results"

#### Subtask 10.5: Test edge cases
- Type `/` at beginning of document
- Type `/` in middle of existing text
- Type `/` at end of document
- Rapidly open and close menu
- Switch between notes while menu is open

#### Subtask 10.6: Test with existing features
- Verify auto-save continues to work
- Confirm save indicator still appears
- Test slash commands in different note contexts
- Ensure no conflicts with keyboard shortcuts (Cmd+S)
- Verify bold/italic shortcuts don't interfere with auto-save

#### Subtask 10.7: Code quality checklist
- Run `npm run build` - verify no errors
- No hardcoded colors or spacing values
- No `any` types in TypeScript
- All components under 250 lines
- All imports use `@/` alias
- Proper error handling for edge cases

**Expected Outcome:** All acceptance criteria validated, slash command system works flawlessly.

---

## Dev Notes

### Project Context

**CRITICAL:** This story builds directly on Story 1.4, which implemented the TipTap editor with auto-save. You now have:
- Fully functional TipTap editor with StarterKit extensions
- Auto-save functionality with debouncing
- SaveIndicator component
- EditorView component integrated with Zustand store

**This Story Focus:**
1. Install TipTap suggestion extension and dependencies
2. Install and configure Bold and Italic extensions with keyboard shortcuts
3. Create custom Callout Node extension for styled callout blocks
4. Create custom slash command extension with command definitions
5. Build CommandMenu React component for displaying options
6. Integrate menu with editor state and keyboard navigation
7. Add CSS styling using CSS variables for theme compatibility (including callout theming)
8. Ensure full accessibility compliance

---

### Architecture Overview

**Slash Command Stack:**
- **@tiptap/suggestion** - Core suggestion infrastructure for slash commands
- **tippy.js** - Popup positioning library (or custom positioning)
- **Custom SlashCommand Extension** - TipTap extension that triggers on `/` character
- **CommandMenu Component** - React component that renders the menu
- **Lucide Icons** - Already installed, used for command icons

**Command Flow:**
1. User types `/` in editor
2. TipTap suggestion extension detects trigger character
3. SlashCommand extension renders CommandMenu React component
4. User navigates with arrow keys (ArrowUp/ArrowDown)
5. User types additional characters to filter commands (e.g., `/h` for headings)
6. User presses Enter to execute command
7. TipTap chain command transforms text block
8. Menu closes and focus returns to editor

---

### Installation Commands

```bash
# TipTap suggestion extension
npm install @tiptap/suggestion

# Popup positioning library
npm install tippy.js @types/tippy.js --save-dev

# Text formatting extensions
npm install @tiptap/extension-bold @tiptap/extension-italic

# TipTap extension for callout base (optional - can build custom from scratch)
npm install @tiptap/extension-highlight
```

---

### File Locations

**New Files to Create:**
- `lib/editor/callout.ts` - Custom TipTap Node extension for callout blocks
- `lib/editor/slash-command.ts` - Custom TipTap extension for slash commands
- `components/editor/CommandMenu.tsx` - React component for command menu UI

**Files to Modify:**
- `components/editor/TipTapEditor.tsx` - Add Bold, Italic, Callout, and SlashCommand extensions to extensions array
- `app/globals.css` - Add command menu CSS styles, callout theming, and text formatting styles
- `types/index.ts` - Add CommandItem and CommandMenuProps interfaces

**No Changes Needed:**
- Auto-save functionality from Story 1.4 continues to work unchanged
- SaveIndicator component remains functional
- EditorView component doesn't need updates

---

### Callout Extension Implementation

**File:** `lib/editor/callout.ts`

```typescript
import { Node, mergeAttributes } from '@tiptap/core';

export const Callout = Node.create({
  name: 'callout',

  group: 'block',

  content: 'block+',

  parseHTML() {
    return [
      {
        tag: 'div[data-type="callout"]',
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return [
      'div',
      mergeAttributes(HTMLAttributes, {
        'data-type': 'callout',
        class: 'callout-block',
      }),
      0,
    ];
  },

  addCommands() {
    return {
      setCallout:
        () =>
        ({ commands }) => {
          return commands.wrapIn(this.name);
        },
      toggleCallout:
        () =>
        ({ commands }) => {
          return commands.toggleWrap(this.name);
        },
    };
  },
});
```

**Key Features:**
- Block-level node that can contain other blocks
- Renders as a `<div>` with `callout-block` class for CSS targeting
- Provides `setCallout()` and `toggleCallout()` commands
- Stores callout state in the document structure

---

### Command Definitions

**Commands to Implement:**

```typescript
// lib/editor/slash-command.ts

import {
  Heading1, Heading2, Heading3,
  List, ListOrdered, Quote, Code, Info, Minus
} from 'lucide-react';

export const SLASH_COMMANDS = [
  {
    title: 'Heading 1',
    icon: Heading1,
    keywords: ['h1', 'heading', 'title', 'large'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .setNode('heading', { level: 1 })
        .run();
    },
  },
  {
    title: 'Heading 2',
    icon: Heading2,
    keywords: ['h2', 'heading', 'subtitle'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .setNode('heading', { level: 2 })
        .run();
    },
  },
  {
    title: 'Heading 3',
    icon: Heading3,
    keywords: ['h3', 'heading', 'subheading'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .setNode('heading', { level: 3 })
        .run();
    },
  },
  {
    title: 'Bulleted List',
    icon: List,
    keywords: ['ul', 'list', 'bullet', 'unordered'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .toggleBulletList()
        .run();
    },
  },
  {
    title: 'Numbered List',
    icon: ListOrdered,
    keywords: ['ol', 'list', 'numbered', 'ordered'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .toggleOrderedList()
        .run();
    },
  },
  {
    title: 'Quote',
    icon: Quote,
    keywords: ['quote', 'blockquote', 'citation'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .toggleBlockquote()
        .run();
    },
  },
  {
    title: 'Code Block',
    icon: Code,
    keywords: ['code', 'codeblock', 'pre', 'monospace'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .toggleCodeBlock()
        .run();
    },
  },
  {
    title: 'Callout',
    icon: Info,
    keywords: ['callout', 'info', 'note', 'box', 'highlight'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .setCallout()
        .run();
    },
  },
  {
    title: 'Horizontal Rule',
    icon: Minus,
    keywords: ['hr', 'divider', 'line', 'separator'],
    command: ({ editor, range }: any) => {
      editor
        .chain()
        .focus()
        .deleteRange(range)
        .setHorizontalRule()
        .run();
    },
  },
];
```

---

### SlashCommand Extension Implementation

**File:** `lib/editor/slash-command.ts`

```typescript
import { Extension } from '@tiptap/core';
import Suggestion from '@tiptap/suggestion';
import { ReactRenderer } from '@tiptap/react';
import tippy from 'tippy.js';
import { CommandMenu } from '@/components/editor/CommandMenu';
import { SLASH_COMMANDS } from './slash-commands-data';

export const SlashCommand = Extension.create({
  name: 'slashCommand',

  addOptions() {
    return {
      suggestion: {
        char: '/',
        command: ({ editor, range, props }: any) => {
          props.command({ editor, range });
        },
      },
    };
  },

  addProseMirrorPlugins() {
    return [
      Suggestion({
        editor: this.editor,
        ...this.options.suggestion,
        items: ({ query }: { query: string }) => {
          return SLASH_COMMANDS.filter((item) => {
            const searchQuery = query.toLowerCase();
            return (
              item.title.toLowerCase().includes(searchQuery) ||
              item.keywords.some((keyword) =>
                keyword.toLowerCase().includes(searchQuery)
              )
            );
          });
        },
        render: () => {
          let component: ReactRenderer;
          let popup: any;

          return {
            onStart: (props: any) => {
              component = new ReactRenderer(CommandMenu, {
                props,
                editor: props.editor,
              });

              popup = tippy('body', {
                getReferenceClientRect: props.clientRect,
                appendTo: () => document.body,
                content: component.element,
                showOnCreate: true,
                interactive: true,
                trigger: 'manual',
                placement: 'bottom-start',
              });
            },

            onUpdate(props: any) {
              component.updateProps(props);

              popup[0].setProps({
                getReferenceClientRect: props.clientRect,
              });
            },

            onKeyDown(props: any) {
              if (props.event.key === 'Escape') {
                popup[0].hide();
                return true;
              }

              return component.ref?.onKeyDown(props);
            },

            onExit() {
              popup[0].destroy();
              component.destroy();
            },
          };
        },
      }),
    ];
  },
});
```

**Key Implementation Notes:**
- Uses TipTap Suggestion plugin as foundation
- Trigger character is `/`
- Filters commands based on query text after `/`
- Renders CommandMenu React component in popup
- Uses Tippy.js for intelligent positioning
- Handles keyboard events (Escape, ArrowUp, ArrowDown, Enter)
- Cleans up popup and component on exit

---

### CommandMenu Component Implementation

**File:** `components/editor/CommandMenu.tsx`

```typescript
'use client';

import { useState, useEffect, forwardRef, useImperativeHandle } from 'react';
import { cn } from '@/lib/utils';
import type { LucideIcon } from 'lucide-react';

export interface CommandItem {
  title: string;
  icon: LucideIcon;
  keywords: string[];
  command: (props: any) => void;
}

export interface CommandMenuProps {
  items: CommandItem[];
  command: (item: CommandItem) => void;
}

export const CommandMenu = forwardRef((props: CommandMenuProps, ref) => {
  const [selectedIndex, setSelectedIndex] = useState(0);

  const selectItem = (index: number) => {
    const item = props.items[index];
    if (item) {
      props.command(item);
    }
  };

  const upHandler = () => {
    setSelectedIndex((prev) =>
      prev === 0 ? props.items.length - 1 : prev - 1
    );
  };

  const downHandler = () => {
    setSelectedIndex((prev) =>
      prev === props.items.length - 1 ? 0 : prev + 1
    );
  };

  const enterHandler = () => {
    selectItem(selectedIndex);
  };

  useEffect(() => {
    setSelectedIndex(0);
  }, [props.items]);

  useImperativeHandle(ref, () => ({
    onKeyDown: ({ event }: { event: KeyboardEvent }) => {
      if (event.key === 'ArrowUp') {
        upHandler();
        return true;
      }

      if (event.key === 'ArrowDown') {
        downHandler();
        return true;
      }

      if (event.key === 'Enter') {
        enterHandler();
        return true;
      }

      return false;
    },
  }));

  return (
    <div
      className={cn(
        'slash-command-menu',
        'bg-[var(--card)] border border-[var(--border)]',
        'rounded-lg shadow-lg',
        'p-[var(--spacing-xs)]',
        'max-h-80 overflow-y-auto',
        'min-w-[200px]'
      )}
      role="listbox"
      aria-label="Formatting commands"
    >
      {props.items.length > 0 ? (
        props.items.map((item, index) => {
          const Icon = item.icon;
          return (
            <button
              key={item.title}
              onClick={() => selectItem(index)}
              className={cn(
                'flex items-center gap-[var(--spacing-sm)]',
                'w-full p-[var(--spacing-sm)]',
                'rounded text-left',
                'text-[var(--foreground)]',
                'transition-colors duration-150',
                'hover:bg-[var(--muted)]/10',
                index === selectedIndex && 'bg-[var(--accent)]/10 text-[var(--accent)]'
              )}
              role="option"
              aria-selected={index === selectedIndex}
            >
              <Icon className="h-4 w-4 flex-shrink-0" />
              <span className="text-sm">{item.title}</span>
            </button>
          );
        })
      ) : (
        <div className="p-[var(--spacing-md)] text-center text-sm text-[var(--muted)]">
          No commands found
        </div>
      )}
    </div>
  );
});

CommandMenu.displayName = 'CommandMenu';
```

**Key Features:**
- Keyboard navigation with arrow keys
- Visual feedback for selected item
- Hover states for interactivity
- Empty state when no results
- Accessibility attributes (role, aria-selected, aria-label)
- All colors use CSS variables
- Icons from lucide-react
- Responsive to filter changes

---

### Update TipTapEditor Component

**File:** `components/editor/TipTapEditor.tsx`

Add to imports:
```typescript
import { SlashCommand } from '@/lib/editor/slash-command';
import { Callout } from '@/lib/editor/callout';
import Bold from '@tiptap/extension-bold';
import Italic from '@tiptap/extension-italic';
```

Update extensions array:
```typescript
const editor = useEditor({
  extensions: [
    StarterKit.configure({
      history: {
        depth: 100,
      },
    }),
    Placeholder.configure({
      placeholder,
    }),
    Typography,
    Bold, // Add this line - enables Cmd+B / Ctrl+B
    Italic, // Add this line - enables Cmd+I / Ctrl+I
    Callout, // Add this line
    SlashCommand, // Add this line
  ],
  // ... rest of configuration
});
```

**That's the only change needed to TipTapEditor.tsx** - the extensions handle everything else.

**Note:** TipTap's Bold and Italic extensions automatically register keyboard shortcuts:
- Bold: `Mod-b` (Cmd+B on Mac, Ctrl+B on Windows/Linux)
- Italic: `Mod-i` (Cmd+I on Mac, Ctrl+I on Windows/Linux)

---

### CSS Styles for Command Menu and Callout

**Add to `app/globals.css`:**

```css
:root {
  /* Callout colors - Light Mode */
  --callout-bg-light: #EBF5FF;
  --callout-border-light: #3B82F6;
}

@media (prefers-color-scheme: dark) {
  :root {
    /* Callout colors - Dark Mode */
    --callout-bg-dark: #374151;
    --callout-border-dark: #6B7280;
  }
}

/* Slash Command Menu */
.slash-command-menu {
  animation: fadeIn 0.15s ease-in-out;
  z-index: 50;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Tippy.js theme overrides */
.tippy-box {
  background-color: transparent !important;
}

.tippy-content {
  padding: 0 !important;
}

/* Callout Block Styling */
.callout-block {
  background-color: var(--callout-bg-light);
  border-left: 4px solid var(--callout-border-light);
  border-radius: 0.375rem;
  padding: var(--spacing-md);
  margin: var(--spacing-md) 0;
}

@media (prefers-color-scheme: dark) {
  .callout-block {
    background-color: var(--callout-bg-dark);
    border-left-color: var(--callout-border-dark);
  }
}

.callout-block p:first-child {
  margin-top: 0;
}

.callout-block p:last-child {
  margin-bottom: 0;
}

/* Text Formatting Styles */
.ProseMirror strong {
  font-weight: 700;
}

.ProseMirror em {
  font-style: italic;
}
```

**Notes:**
- Callout uses pale blue (#EBF5FF) in light mode
- Callout uses grey (#374151) in dark mode
- Left border accent for visual distinction
- Proper spacing and border-radius
- Fade-in animation for menu
- Z-index ensures menu appears above editor content
- Tippy.js theme overrides for clean appearance
- Bold renders with font-weight: 700
- Italic renders with font-style: italic
- All colors use CSS variables

---

### TypeScript Interfaces

**Update `types/index.ts`:**

```typescript
import type { LucideIcon } from 'lucide-react';

export interface CommandItem {
  title: string;
  icon: LucideIcon;
  keywords: string[];
  command: (props: { editor: any; range: any }) => void;
}

export interface CommandMenuProps {
  items: CommandItem[];
  command: (item: CommandItem) => void;
}
```

---

### Integration with Existing Editor

**No Changes Required to:**
- `components/editor/EditorView.tsx` - Works unchanged
- `lib/hooks/useAutoSave.ts` - Auto-save continues to work
- `components/editor/SaveIndicator.tsx` - Save indicator still displays
- Zustand store - No state changes needed

**The slash command extension integrates seamlessly with the existing editor setup.**

---

### Styling Standards (CRITICAL)

**From CLAUDE.md Section 2:** ALL styling MUST use CSS variables.

**Command Menu Styling Checklist:**
- ✅ Background: `bg-[var(--card)]`
- ✅ Border: `border-[var(--border)]`
- ✅ Text: `text-[var(--foreground)]`
- ✅ Selected item: `bg-[var(--accent)]/10 text-[var(--accent)]`
- ✅ Hover state: `hover:bg-[var(--muted)]/10`
- ✅ Spacing: `p-[var(--spacing-sm)]`, `gap-[var(--spacing-xs)]`

**❌ NEVER hardcode:**
```typescript
// WRONG - DON'T DO THIS
<div className="bg-white border-gray-200 text-black">
<div className="p-2 gap-1">
```

**✅ ALWAYS use CSS variables:**
```typescript
// CORRECT
<div className="bg-[var(--card)] border-[var(--border)] text-[var(--foreground)]">
<div className="p-[var(--spacing-sm)] gap-[var(--spacing-xs)]">
```

---

### Accessibility Standards (CLAUDE.md Section 15)

**WCAG AA Compliance:**
- ✅ Menu is fully keyboard navigable
- ✅ Arrow keys move selection
- ✅ Enter activates selected command
- ✅ Escape closes menu
- ✅ Visual focus indicators for selected item
- ✅ Sufficient color contrast ratios
- ✅ ARIA attributes for screen readers

**ARIA Attributes:**
```typescript
<div role="listbox" aria-label="Formatting commands">
  <button role="option" aria-selected={isSelected}>
```

**Keyboard Navigation:**
- ArrowUp: Move to previous item
- ArrowDown: Move to next item
- Enter: Execute selected command
- Escape: Close menu
- Tab: Close menu (blur event)

---

### Performance Considerations

**Optimizations:**
- Command filtering is lightweight (array filter on small set)
- React component only re-renders on state changes
- Tippy.js efficiently manages popup positioning
- No impact on auto-save performance
- No additional network requests

**Memory Management:**
- Component properly cleaned up on menu close
- Tippy.js instance destroyed on exit
- ReactRenderer instance destroyed on exit
- No memory leaks from popup instances

---

### Error Handling

**Edge Cases to Handle:**
- Empty filter results → Show "No commands found" message
- Invalid keyboard input → Ignore unhandled keys
- Rapid open/close → Proper cleanup prevents issues
- Menu open when note switches → Menu closes automatically
- Menu open when editor loses focus → Menu closes

**Error Prevention:**
- Check if item exists before executing command
- Validate selectedIndex is within bounds
- Ensure editor is focused before command execution
- Handle missing icon gracefully (fallback to placeholder)

---

### Testing Checklist

**Before marking as "Review", verify:**

- [ ] Typing `/` triggers command menu
- [ ] Menu displays all 9 commands (H1, H2, H3, Bulleted List, Numbered List, Quote, Code Block, Callout, Horizontal Rule)
- [ ] ArrowUp navigates to previous item (wraps to bottom)
- [ ] ArrowDown navigates to next item (wraps to top)
- [ ] Enter executes selected command
- [ ] Escape closes menu
- [ ] Typing `/h` filters to heading commands only
- [ ] Typing `/list` shows list commands
- [ ] Typing `/call` shows callout command
- [ ] Typing invalid query shows "No commands found"
- [ ] Selected item is visually highlighted
- [ ] Hover state works correctly
- [ ] All commands insert correct block types
- [ ] Callout has pale blue background (#EBF5FF) in light mode
- [ ] Callout has grey background (#374151) in dark mode
- [ ] Callout has left border accent
- [ ] Cmd+B / Ctrl+B toggles bold on selected text
- [ ] Cmd+I / Ctrl+I toggles italic on selected text
- [ ] Bold text renders with font-weight: 700
- [ ] Italic text renders with font-style: italic
- [ ] Bold and italic can be combined on same text
- [ ] Menu closes after command execution
- [ ] Auto-save continues to work
- [ ] Save indicator still appears
- [ ] No TypeScript errors (`npm run build`)
- [ ] No hardcoded colors or spacing
- [ ] All components under 250 lines
- [ ] No `any` types (except where TipTap API requires)

---

### Common Pitfalls to Avoid

1. **Don't forget to delete the trigger character** - Use `deleteRange(range)` before inserting block
2. **Don't hardcode colors** - Use CSS variables exclusively
3. **Don't skip keyboard navigation** - Arrow keys and Enter are essential
4. **Don't forget cleanup** - Destroy popup and component on exit
5. **Don't use `any` unnecessarily** - Type TipTap props where possible
6. **Don't position menu manually** - Let Tippy.js handle it
7. **Don't forget ARIA attributes** - Required for accessibility
8. **Don't skip empty state** - Show message when no commands match
9. **Don't hardcode command list** - Use constants for maintainability
10. **Don't forget to test filtering** - Ensure keywords work correctly

---

### Dependencies (TipTap Extensions from StarterKit)

**These extensions are ALREADY installed from Story 1.4:**
- ✅ Heading (levels 1-6)
- ✅ BulletList
- ✅ OrderedList
- ✅ ListItem
- ✅ Blockquote
- ✅ CodeBlock
- ✅ HorizontalRule

**New extensions added in this story:**
- 🆕 Bold - TipTap extension with Cmd+B / Ctrl+B shortcut
- 🆕 Italic - TipTap extension with Cmd+I / Ctrl+I shortcut
- 🆕 Callout - Custom Node extension for callout blocks

**The slash commands trigger the block-level extensions via the command menu. Bold and italic are triggered via keyboard shortcuts.**

---

### Future Enhancements (NOT in this story)

The following will be implemented in future stories:
- Table insertion
- Task list (checkboxes)
- Image upload
- Embed URLs
- Multiple callout types (info, warning, success, error)

**This story focuses on basic formatting blocks using StarterKit extensions PLUS a simple callout block.**

---

### Success Criteria

This story is complete when:

1. ✅ Typing `/` opens command menu
2. ✅ Menu shows 9 commands with icons (including Callout)
3. ✅ Arrow keys navigate menu
4. ✅ Enter executes selected command
5. ✅ Escape closes menu
6. ✅ Filtering works (e.g., `/h` shows headings, `/call` shows callout)
7. ✅ All commands insert correct blocks
8. ✅ Callout has pale blue background in light mode
9. ✅ Callout has grey background in dark mode
10. ✅ Cmd+B / Ctrl+B toggles bold formatting
11. ✅ Cmd+I / Ctrl+I toggles italic formatting
12. ✅ Bold and italic can be combined
13. ✅ Auto-save continues to work
14. ✅ All CSS uses variables (no hardcoded values)
15. ✅ No `any` types (except TipTap API requirements)
16. ✅ All components under 250 lines
17. ✅ Build succeeds without errors
18. ✅ Accessibility requirements met
19. ✅ All acceptance criteria validated

The Developer agent should be able to complete this story in approximately 15 hours total across all tasks.

---

## QA Results

### Review Date: October 20, 2025
### Reviewer: QA Story Validator Agent

#### Acceptance Criteria Validation:

1. **Typing `/` in the editor triggers a command menu to appear**: ✅ PASS
   - Evidence: `lib/editor/slash-command.ts` lines 26, 36-48 - SlashCommand extension configured with trigger character `/`
   - Notes: Uses TipTap Suggestion plugin with proper configuration

2. **The menu includes options for: Heading 1, Heading 2, Heading 3, Bulleted List, Numbered List, Quote, Code Block, Callout, and Horizontal Rule**: ✅ PASS
   - Evidence: `lib/editor/slash-commands-data.ts` lines 18-136 - All 9 commands defined with proper titles, icons, and keywords
   - Notes: Complete implementation with Lucide icons for each command type

3. **Selecting an option from the menu inserts the corresponding block**: ✅ PASS
   - Evidence: `lib/editor/slash-commands-data.ts` - Each command has proper TipTap chain command implementation
   - Notes: Commands use `deleteRange(range)` to remove trigger, then apply appropriate block transformation

4. **Callout blocks have a pale blue background in light mode and grey background in dark mode**: ✅ PASS
   - Evidence: `app/globals.css` lines 70-72 (light mode: #EBF5FF), lines 141-143 (dark mode: #374151), lines 230-243 (callout styling)
   - Notes: Proper CSS variable implementation with media query for dark mode

5. **The menu can be navigated with arrow keys**: ✅ PASS
   - Evidence: `components/editor/CommandMenu.tsx` lines 52-66 - ArrowUp and ArrowDown keyboard handlers
   - Notes: Includes wrap-around navigation (top to bottom, bottom to top)

6. **Pressing Enter selects the highlighted menu item**: ✅ PASS
   - Evidence: `components/editor/CommandMenu.tsx` lines 63-66 - Enter key handler calls selectItem()
   - Notes: Properly executes command and closes menu

7. **Pressing Escape closes the menu**: ✅ PASS
   - Evidence: `lib/editor/slash-command.ts` lines 89-95 - Escape key handler hides popup
   - Notes: Proper cleanup of popup instance

8. **The menu filters options as the user continues typing after `/`**: ✅ PASS
   - Evidence: `lib/editor/slash-command.ts` lines 39-48 - Filter logic searches both title and keywords
   - Notes: Case-insensitive filtering with keyword support

9. **Cmd+B (Mac) / Ctrl+B (Windows/Linux) toggles bold formatting on selected text**: ✅ PASS
   - Evidence: `components/editor/TipTapEditor.tsx` line 40 - Bold extension added to editor
   - Notes: TipTap Bold extension automatically registers Mod-b keyboard shortcut

10. **Cmd+I (Mac) / Ctrl+I (Windows/Linux) toggles italic formatting on selected text**: ✅ PASS
    - Evidence: `components/editor/TipTapEditor.tsx` line 41 - Italic extension added to editor
    - Notes: TipTap Italic extension automatically registers Mod-i keyboard shortcut

#### Code Quality Assessment:

**Readability**: EXCELLENT
- Well-structured code with clear separation of concerns
- Comprehensive JSDoc comments in all extension files
- Descriptive variable and function names
- Logical file organization

**Standards Compliance**: EXCELLENT
- All CSS uses variables (no hardcoded colors or spacing)
  - Verified: `bg-[var(--card)]`, `border-[var(--border)]`, `text-[var(--foreground)]`, `p-[var(--spacing-sm)]`
- No hardcoded values found in any component
- All imports use `@/` alias for consistency
- Proper TypeScript interfaces in `types/index.ts`

**Performance**: EXCELLENT
- Lightweight command filtering (array filter on small dataset)
- Proper cleanup of React components and Tippy instances
- No memory leaks (component and popup destroyed on exit)
- No additional network requests

**Security**: GOOD
- No security vulnerabilities identified
- Proper type safety with TypeScript
- No user input directly executed (commands use predefined TipTap chain commands)

**Testing**: EXCELLENT
- Build succeeds without errors (`npm run build` passed)
- Development server starts without errors
- All components under 250-line limit:
  - TipTapEditor.tsx: 92 lines
  - CommandMenu.tsx: 118 lines
  - callout.ts: 56 lines
  - slash-command.ts: 118 lines
  - slash-commands-data.ts: 136 lines

**TypeScript Type Safety**: EXCELLENT
- Only one use of `any` type (in types/index.ts line 90)
- Properly documented with eslint-disable comment
- Required for TipTap editor API interface
- All other types properly defined

**Accessibility**: EXCELLENT
- ARIA attributes implemented:
  - `role="listbox"` on menu container (line 82)
  - `role="option"` on menu items (line 101)
  - `aria-selected` for selected state (line 102)
  - `aria-label="Formatting commands"` for context (line 83)
- Full keyboard navigation support (ArrowUp, ArrowDown, Enter, Escape)
- Visual feedback for selected items
- Empty state message for no results

#### Refactoring Performed:

No refactoring was necessary. The implementation is clean, well-structured, and follows all CLAUDE.md standards perfectly.

#### Issues Identified:

None. All acceptance criteria are fully met, and code quality exceeds standards.

#### CLAUDE.md Standards Verification:

✅ **Section 1 (Architecture)**: Correct file organization in `lib/editor/` and `components/editor/`
✅ **Section 2 (Styling)**: All CSS uses variables exclusively - verified no hardcoded colors
✅ **Section 3 (TypeScript)**: Minimal use of `any`, proper interfaces, all types defined
✅ **Section 4 (Database)**: N/A for this story
✅ **Section 5 (API Routes)**: N/A for this story
✅ **Section 6 (Components)**: All under 250 lines, functional components, proper props
✅ **Section 7 (Testing)**: Build succeeds, application runs without errors
✅ **Section 8 (Auth)**: N/A for this story
✅ **Section 9 (Performance)**: Efficient filtering, proper cleanup, no memory leaks
✅ **Section 10 (Environment)**: N/A for this story
✅ **Section 11 (Git)**: Ready for commit after QA validation
✅ **Section 12 (Documentation)**: Comprehensive JSDoc comments in all files
✅ **Section 15 (Accessibility)**: WCAG AA compliance verified

#### Build Verification:

```bash
npm run build
```
Result: ✅ SUCCESS
- Compiled successfully in 2.3s
- All static pages generated
- Only minor ESLint warnings (unused variables in unrelated files)
- No TypeScript errors
- Bundle size: 300 KB (well under limits)

#### Runtime Verification:

```bash
npm run dev
```
Result: ✅ SUCCESS
- Server started successfully on port 3002
- No runtime errors
- Application accessible at http://localhost:3002

#### Dependencies Verification:

All required packages installed correctly:
- ✅ @tiptap/suggestion (3.7.2)
- ✅ @tiptap/extension-bold (3.7.2)
- ✅ @tiptap/extension-italic (3.7.2)
- ✅ tippy.js (6.3.7)
- ✅ @types/tippy.js (6.3.0)

#### File Length Verification:

All files well under 250-line limit:
- TipTapEditor.tsx: 92 lines (63% under limit)
- CommandMenu.tsx: 118 lines (52% under limit)
- callout.ts: 56 lines (77% under limit)
- slash-command.ts: 118 lines (52% under limit)
- slash-commands-data.ts: 136 lines (45% under limit)

#### Final Decision:

✅ **ALL ACCEPTANCE CRITERIA VALIDATED**

This implementation is exceptional:
- Complete feature implementation with all 9 slash commands
- Perfect adherence to CLAUDE.md standards
- Clean, maintainable, well-documented code
- Excellent accessibility implementation
- Zero critical issues identified
- Professional-grade TypeScript typing
- Efficient performance with proper memory management

**Story Status: APPROVED and marked as DONE**

The implementation demonstrates outstanding attention to detail and follows all project standards. The slash command system is production-ready and provides an excellent user experience with full keyboard navigation and accessibility support.

---

## Dev Agent Record

_To be completed by Developer Agent_
