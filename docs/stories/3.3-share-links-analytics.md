# Story 3.3: Share Links and Analytics

**Status:** Draft

**Epic:** Epic 3 - Web Publishing Feature

**Dependencies:** Story 3.1 (Basic Page Publishing), Story 3.2 (Custom Slugs and SEO Metadata)

## User Story

As a user, I want to easily share my published pages via social media and email, and see basic analytics about how many people have viewed my content, so that I can measure the reach and impact of my published work.

## Description

This story completes the web publishing feature by adding share functionality and GDPR-compliant analytics. Users can quickly share their published pages on Twitter, LinkedIn, via email, or by copying the link to clipboard. The system tracks basic view metrics (total views, last viewed timestamp) without using cookies or collecting personally identifiable information, ensuring full GDPR compliance.

This builds directly on Stories 3.1 and 3.2 by:
- Adding share buttons with pre-populated content for major platforms
- Implementing copy-to-clipboard functionality with visual feedback
- Tracking page views server-side without cookies
- Displaying view analytics in publish settings
- Adding "Powered by Edfolio" branding footer to public pages

**Key Functionality:**
- Copy link button with clipboard API
- Social share buttons (Twitter, LinkedIn, Email)
- Server-side view tracking (no cookies, GDPR-friendly)
- View count and last viewed timestamp
- Analytics display in publish settings
- "Powered by Edfolio" footer on public pages
- Toast notifications for successful link copying

## Acceptance Criteria

- [ ] Published pages display "Share" button in editor or publish settings
- [ ] Share modal shows public URL with one-click copy button
- [ ] Copy button provides visual feedback (checkmark animation, toast notification)
- [ ] Twitter share button pre-populates title and URL
- [ ] LinkedIn share button pre-populates title and URL
- [ ] Email share button opens default mail client with subject and body
- [ ] System tracks view count for each published page (server-side, no cookies)
- [ ] System records last viewed timestamp
- [ ] User can view analytics (total views, last viewed date) in publish settings
- [ ] Public pages display "Powered by Edfolio" footer with link to homepage
- [ ] Footer is subtle and non-intrusive
- [ ] View tracking respects GDPR (no cookies, no PII, no client-side tracking)
- [ ] View count increments only once per page load (no duplicate counting)
- [ ] Analytics are visible only to page owner (not public)

## Tasks / Subtasks

### Task 1: Create ShareLinkDisplay Component (2.5 hours)
**Estimated Time:** 2.5 hours

- [ ] Create `/components/publish/ShareLinkDisplay.tsx` component
- [ ] Define ShareLinkDisplayProps interface:
  - `publicUrl: string` - Full public URL (e.g., "https://edfolio.app/public/my-post")
  - `title: string` - Page title for social sharing
  - `description?: string` - Meta description for social sharing
- [ ] Implement component structure:
  - **URL Display Section:**
    - Show public URL in read-only input field
    - Copy button with icon (Clipboard icon from lucide-react)
    - Visual feedback on copy (checkmark animation)
  - **Social Share Buttons:**
    - Twitter button (Twitter/X icon)
    - LinkedIn button (LinkedIn icon)
    - Email button (Mail icon)
    - All buttons styled consistently (icon + text)
  - **Button Grid Layout:**
    - Responsive grid (2 columns on mobile, 3+ on desktop)
    - Equal spacing using var(--spacing-md)
- [ ] Implement copy to clipboard:
  - Use Clipboard API: `navigator.clipboard.writeText()`
  - Show success toast: "Link copied to clipboard"
  - Change icon to checkmark for 2 seconds
  - Handle clipboard API errors (fallback, error toast)
- [ ] Implement social share links:
  - **Twitter:**
    - URL: `https://twitter.com/intent/tweet?text={title}&url={publicUrl}`
    - Encode title and URL
    - Open in new window (600x400 popup)
  - **LinkedIn:**
    - URL: `https://www.linkedin.com/sharing/share-offsite/?url={publicUrl}`
    - Open in new window (600x600 popup)
  - **Email:**
    - URL: `mailto:?subject={title}&body=Check out this page: {publicUrl}`
    - Encode subject and body
    - Opens default mail client
- [ ] Add visual feedback for all buttons:
  - Hover states
  - Active states
  - Loading states (if needed)
- [ ] Use CSS variables for all colors and spacing
- [ ] Keep component under 200 lines

### Task 2: Integrate ShareLinkDisplay into PublishSettings (1 hour)
**Estimated Time:** 1 hour

- [ ] Open `/components/publish/PublishSettingsModal.tsx`
- [ ] Add ShareLinkDisplay component below social preview section
- [ ] Show only if page is published (isPublished === true)
- [ ] Pass props:
  - `publicUrl`: Full URL with domain
  - `title`: metaTitle or noteTitle
  - `description`: metaDescription
- [ ] Add section divider above share section
- [ ] Add section heading: "Share Your Page"
- [ ] Ensure modal scrolls properly with new content
- [ ] Keep total file under 250 lines

### Task 3: Implement Server-Side View Tracking (3 hours)
**Estimated Time:** 3 hours

- [ ] Open `/app/public/[slug]/page.tsx`
- [ ] Add view tracking logic in page component:
  - Increment viewCount by 1
  - Update lastViewed to current timestamp
  - Execute AFTER rendering (use React.useEffect equivalent for Server Components)
  - Actually: Use Server Action or move tracking to separate endpoint
- [ ] Create `/app/api/public/[slug]/track-view/route.ts` endpoint:
  - POST endpoint for tracking views
  - No authentication required (public access)
  - Extract slug from params
  - Find PublishedPage by slug
  - Verify isPublished === true
  - Increment viewCount: `increment: { viewCount: 1 }`
  - Update lastViewed: `update: { lastViewed: new Date() }`
  - Return success (no data needed)
  - Add rate limiting: max 1 request per IP per page per hour (prevent spam)
- [ ] Call track-view endpoint from public page:
  - Use client-side fetch in useEffect
  - Call only once per page load
  - Don't block rendering (fire and forget)
  - Silent failure if tracking fails (don't break page)
- [ ] Implement IP-based deduplication:
  - Store recent views in memory cache (Map<key, timestamp>)
  - Key format: `${ip}-${slug}`
  - Cache entry expires after 1 hour
  - If key exists and not expired, skip tracking
  - If key exists and expired, track and update cache
  - If key doesn't exist, track and add to cache
- [ ] Add environment variable for tracking:
  - `ENABLE_VIEW_TRACKING=true` (can disable for development)
- [ ] Keep endpoint under 150 lines
- [ ] Add error handling (database errors, rate limit exceeded)

### Task 4: Create Analytics Display Component (2 hours)
**Estimated Time:** 2 hours

- [ ] Create `/components/publish/PublishAnalytics.tsx` component
- [ ] Define PublishAnalyticsProps interface:
  - `viewCount: number` - Total page views
  - `lastViewed: Date | null` - Last view timestamp
  - `publishedAt: Date` - Publication date
- [ ] Implement component layout:
  - **Stats Grid:**
    - Total Views (large number, prominent)
    - Last Viewed (relative time, e.g., "2 hours ago")
    - Published (date, e.g., "Published 3 days ago")
  - **Stats Cards:**
    - Each stat in its own card
    - Icon for each stat (Eye, Clock, Calendar from lucide-react)
    - Label and value stacked
    - Responsive grid (1 column mobile, 3 columns desktop)
  - **Empty State:**
    - If viewCount === 0: "No views yet"
    - Encouraging message: "Share your page to get views!"
- [ ] Format relative times:
  - Use date-fns or similar library
  - Examples: "just now", "5 minutes ago", "2 hours ago", "3 days ago"
  - Absolute date for > 7 days: "Jan 15, 2024"
- [ ] Style with CSS variables
- [ ] Keep component under 150 lines

### Task 5: Integrate Analytics into PublishSettings (1 hour)
**Estimated Time:** 1 hour

- [ ] Open `/components/publish/PublishSettingsModal.tsx`
- [ ] Fetch analytics data when modal opens (if published):
  - Add state: `const [analytics, setAnalytics] = useState<PublishAnalytics | null>(null)`
  - Fetch from `/api/notes/[noteId]/publish/analytics` (create in Task 6)
  - Display loading state while fetching
- [ ] Render PublishAnalytics component:
  - Show at top of modal (before URL settings)
  - Only if published
  - Pass viewCount, lastViewed, publishedAt
- [ ] Add section divider after analytics
- [ ] Handle loading and error states:
  - Show skeleton loader while fetching
  - Show error message if fetch fails (non-blocking)
- [ ] Keep total file under 250 lines

### Task 6: Create Analytics API Endpoint (1.5 hours)
**Estimated Time:** 1.5 hours

- [ ] Create `/app/api/notes/[noteId]/publish/analytics/route.ts`
- [ ] Implement GET handler:
  - Validate authentication (require session)
  - Extract noteId from params
  - Verify note ownership via folio
  - Find PublishedPage by noteId
  - If not found or not published: return 404
  - Return analytics:
    ```typescript
    {
      data: {
        viewCount: number,
        lastViewed: Date | null,
        publishedAt: Date,
      }
    }
    ```
  - Add error handling (401, 403, 404, 500)
- [ ] Keep file under 150 lines
- [ ] Use try-catch for all operations

### Task 7: Add "Powered by Edfolio" Footer (1.5 hours)
**Estimated Time:** 1.5 hours

- [ ] Create `/components/public-page/PublicPageFooter.tsx` component
- [ ] Implement simple footer:
  - Centered text: "Powered by [Edfolio]"
  - "Edfolio" is a link to homepage (https://edfolio.app)
  - Subtle styling (small text, muted color)
  - Border-top separator
  - Padding: var(--spacing-lg)
  - Fixed to bottom or at end of content (depending on page length)
- [ ] Update `/components/public-page/PublicPageLayout.tsx`:
  - Import PublicPageFooter
  - Render at bottom of page (after content)
  - Ensure footer stays at bottom even on short pages
- [ ] Style footer:
  - Background: var(--public-background)
  - Text color: var(--public-muted)
  - Border-top: 1px solid var(--public-border)
  - Link hover: var(--public-accent)
- [ ] Keep component under 100 lines
- [ ] Ensure non-intrusive (doesn't distract from content)

### Task 8: Implement Copy to Clipboard Functionality (1 hour)
**Estimated Time:** 1 hour

- [ ] In ShareLinkDisplay component:
- [ ] Implement handleCopyLink function:
  ```typescript
  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(publicUrl);
      setIsCopied(true);
      toast.success('Link copied to clipboard');
      setTimeout(() => setIsCopied(false), 2000);
    } catch (error) {
      // Fallback for browsers without Clipboard API
      fallbackCopyTextToClipboard(publicUrl);
    }
  };
  ```
- [ ] Implement fallback copy method:
  ```typescript
  function fallbackCopyTextToClipboard(text: string) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      toast.success('Link copied to clipboard');
    } catch (error) {
      toast.error('Failed to copy link');
    }
    document.body.removeChild(textArea);
  }
  ```
- [ ] Add visual feedback:
  - State: `const [isCopied, setIsCopied] = useState(false)`
  - Icon changes: Clipboard → CheckCircle (for 2 seconds)
  - Button text changes: "Copy" → "Copied!" (for 2 seconds)
- [ ] Handle errors gracefully (show error toast)

### Task 9: Create Social Share Helper Functions (1 hour)
**Estimated Time:** 1 hour

- [ ] Create `/lib/social-share.ts` utility file
- [ ] Implement `shareOnTwitter(title: string, url: string): void`:
  - Encode title and URL
  - Build Twitter intent URL
  - Open popup window (600x400, centered)
- [ ] Implement `shareOnLinkedIn(url: string): void`:
  - Encode URL
  - Build LinkedIn share URL
  - Open popup window (600x600, centered)
- [ ] Implement `shareViaEmail(title: string, url: string): void`:
  - Encode title and URL
  - Build mailto: URL
  - Window.location.href to trigger email client
- [ ] Implement `openSharePopup(url: string, width: number, height: number)`:
  - Calculate centered position
  - Open window with specific dimensions
  - Set window features (no toolbar, no menubar, resizable)
  - Return window reference
- [ ] Add JSDoc comments for all functions
- [ ] Keep file under 150 lines

### Task 10: Update Type Definitions (30 minutes)
**Estimated Time:** 30 minutes

- [ ] Open `/types/index.ts`
- [ ] Add interfaces for share and analytics:
  ```typescript
  /**
   * Props for ShareLinkDisplay component
   */
  export interface ShareLinkDisplayProps {
    publicUrl: string;
    title: string;
    description?: string;
  }

  /**
   * Props for PublishAnalytics component
   */
  export interface PublishAnalyticsProps {
    viewCount: number;
    lastViewed: Date | null;
    publishedAt: Date;
  }

  /**
   * Analytics data for published page
   */
  export interface PublishAnalytics {
    viewCount: number;
    lastViewed: Date | null;
    publishedAt: Date;
  }

  /**
   * Props for PublicPageFooter component
   */
  export interface PublicPageFooterProps {
    // No props needed currently
  }
  ```
- [ ] Export all new types
- [ ] Keep file under 300 lines

### Task 11: Add View Tracking Client Component (1.5 hours)
**Estimated Time:** 1.5 hours

- [ ] Create `/components/public-page/ViewTracker.tsx` client component
- [ ] Implement view tracking logic:
  ```typescript
  'use client';

  import { useEffect } from 'react';

  interface ViewTrackerProps {
    slug: string;
  }

  export function ViewTracker({ slug }: ViewTrackerProps) {
    useEffect(() => {
      // Track view on mount
      const trackView = async () => {
        try {
          await fetch(`/api/public/${slug}/track-view`, {
            method: 'POST',
          });
          // Silent success - no user feedback needed
        } catch (error) {
          // Silent failure - don't break page if tracking fails
          console.error('View tracking failed:', error);
        }
      };

      trackView();
    }, [slug]); // Only run once per page load

    return null; // Invisible component
  }
  ```
- [ ] Import and render in `/app/public/[slug]/page.tsx`:
  - Add `<ViewTracker slug={slug} />` to page component
  - Place at end of component (after content)
- [ ] Ensure component only renders on client (use 'use client' directive)
- [ ] Keep component under 50 lines

### Task 12: Implement Rate Limiting for View Tracking (2 hours)
**Estimated Time:** 2 hours

- [ ] Create `/lib/view-tracking-cache.ts` utility
- [ ] Implement in-memory cache for view deduplication:
  ```typescript
  interface ViewCacheEntry {
    timestamp: number;
  }

  // Cache: Map<key, timestamp>
  // Key format: "${ip}-${slug}"
  const viewCache = new Map<string, ViewCacheEntry>();

  // Cache cleanup interval (every hour)
  const CACHE_TTL = 60 * 60 * 1000; // 1 hour in ms

  /**
   * Check if view should be tracked (not duplicate)
   */
  export function shouldTrackView(ip: string, slug: string): boolean {
    const key = `${ip}-${slug}`;
    const entry = viewCache.get(key);

    if (!entry) {
      // No entry - track and cache
      viewCache.set(key, { timestamp: Date.now() });
      return true;
    }

    // Entry exists - check if expired
    if (Date.now() - entry.timestamp > CACHE_TTL) {
      // Expired - track and update
      viewCache.set(key, { timestamp: Date.now() });
      return true;
    }

    // Not expired - skip tracking (duplicate)
    return false;
  }

  /**
   * Clean up expired cache entries (run periodically)
   */
  export function cleanupViewCache() {
    const now = Date.now();
    for (const [key, entry] of viewCache.entries()) {
      if (now - entry.timestamp > CACHE_TTL) {
        viewCache.delete(key);
      }
    }
  }

  // Run cleanup every hour
  setInterval(cleanupViewCache, CACHE_TTL);
  ```
- [ ] Update track-view endpoint to use cache:
  - Extract IP from request headers
  - Call `shouldTrackView(ip, slug)`
  - If false, return success without updating database
  - If true, increment viewCount and update lastViewed
- [ ] Handle missing IP (e.g., local development):
  - Use fallback identifier: user agent hash
  - Or skip rate limiting in development
- [ ] Keep utility file under 150 lines

### Task 13: Add Environment Variables for Social Sharing (15 minutes)
**Estimated Time:** 15 minutes

- [ ] Open `.env.example`
- [ ] Add variables:
  ```bash
  # Public URL configuration
  NEXT_PUBLIC_BASE_URL=https://edfolio.app
  NEXT_PUBLIC_SITE_NAME=Edfolio

  # Social sharing defaults
  NEXT_PUBLIC_TWITTER_HANDLE=@edfolio
  NEXT_PUBLIC_DEFAULT_OG_IMAGE=https://edfolio.app/og-default.png

  # View tracking
  ENABLE_VIEW_TRACKING=true
  ```
- [ ] Document each variable in .env.example
- [ ] Update ShareLinkDisplay to use NEXT_PUBLIC_BASE_URL
- [ ] Update social share functions to use environment variables

### Task 14: Testing & Validation (4.5 hours)
**Estimated Time:** 4.5 hours

- [ ] **Copy Link Testing:**
  - [ ] Click copy button
  - [ ] Verify toast notification appears
  - [ ] Verify icon changes to checkmark
  - [ ] Paste link → verify URL is correct
  - [ ] Test fallback method (disable Clipboard API in browser)
  - [ ] Test on mobile browsers
- [ ] **Social Share Testing:**
  - [ ] Click Twitter button:
    - [ ] Verify popup opens
    - [ ] Verify title and URL pre-filled
    - [ ] Verify tweet preview shows correct content
  - [ ] Click LinkedIn button:
    - [ ] Verify popup opens
    - [ ] Verify URL pre-filled
    - [ ] Share and verify post appears on LinkedIn
  - [ ] Click Email button:
    - [ ] Verify mail client opens
    - [ ] Verify subject and body pre-filled
    - [ ] Verify URL in email body
  - [ ] Test on different browsers (Chrome, Firefox, Safari)
  - [ ] Test on mobile (iOS, Android)
- [ ] **View Tracking Testing:**
  - [ ] Publish page
  - [ ] Visit public URL
  - [ ] Check analytics → verify viewCount = 1
  - [ ] Refresh page multiple times quickly
  - [ ] Check analytics → verify viewCount still = 1 (deduplication works)
  - [ ] Wait 1 hour, visit again
  - [ ] Check analytics → verify viewCount = 2
  - [ ] Test from different IP addresses
  - [ ] Verify each IP tracked separately
  - [ ] Test with ENABLE_VIEW_TRACKING=false → no tracking
- [ ] **Analytics Display Testing:**
  - [ ] Open PublishSettingsModal for published page
  - [ ] Verify analytics section appears at top
  - [ ] Verify viewCount shows correctly
  - [ ] Verify lastViewed shows relative time
  - [ ] Verify publishedAt shows date
  - [ ] Test with 0 views → verify empty state
  - [ ] Test with many views → verify formatting
  - [ ] Test with null lastViewed → handle gracefully
- [ ] **Footer Testing:**
  - [ ] Visit public page
  - [ ] Verify "Powered by Edfolio" footer appears
  - [ ] Verify footer link works (goes to homepage)
  - [ ] Verify footer is subtle (not distracting)
  - [ ] Test on short page → footer at bottom
  - [ ] Test on long page → footer after content
- [ ] **GDPR Compliance Testing:**
  - [ ] Verify no cookies set by public page
  - [ ] Verify no localStorage/sessionStorage used for tracking
  - [ ] Verify no third-party tracking scripts
  - [ ] Verify IP address not stored in database
  - [ ] Verify only aggregated data stored (viewCount)
  - [ ] Review GDPR checklist
- [ ] **Error Handling Testing:**
  - [ ] Test copy link with clipboard API disabled → fallback works
  - [ ] Test view tracking API failure → page still loads
  - [ ] Test analytics API failure → error message shown
  - [ ] Test social share with invalid URL → handles gracefully
- [ ] **Build Validation:**
  - [ ] Run `npm run build` → zero errors
  - [ ] Verify no TypeScript errors
  - [ ] Verify no ESLint errors
- [ ] **Code Quality Checks:**
  - [ ] All components under 250 lines
  - [ ] All API routes under 200 lines
  - [ ] All utility files under 150 lines
  - [ ] No `any` types used
  - [ ] All colors use CSS variables
  - [ ] All spacing uses CSS variables
  - [ ] All imports use `@/` alias

## Dev Notes

### Architecture Overview

This story completes Epic 3 by adding sharing capabilities and privacy-respecting analytics. The architecture prioritizes user privacy and GDPR compliance while providing useful insights.

**Sharing Architecture:**
- Client-side only (no backend needed for sharing)
- Direct integration with social platforms via URL schemes
- Clipboard API with fallback for broader browser support
- Toast notifications for user feedback

**Analytics Architecture:**
- Server-side tracking only (no client-side tracking scripts)
- IP-based deduplication with 1-hour cache
- No cookies, no localStorage, no PII storage
- Only aggregate metrics (count, timestamp)
- View tracking as "fire and forget" (doesn't block page rendering)

**Key Design Decisions:**

1. **No Cookies for Public Pages:** View tracking is entirely server-side using IP deduplication in memory cache. This avoids GDPR cookie consent requirements.

2. **IP Deduplication, Not Storage:** IP addresses are used only for deduplication (1 view per IP per hour) but never stored in the database. Only viewCount and lastViewed timestamp are persisted.

3. **Fire and Forget Tracking:** View tracking happens asynchronously and fails silently. A tracking failure never breaks the page or creates error messages for visitors.

4. **Social Sharing via URL Schemes:** Instead of JavaScript SDKs from social platforms (which require tracking consent), we use simple URL schemes that open share dialogs directly.

5. **Copy-First Approach:** Copy link is the primary sharing method (most prominent), with social buttons as secondary options.

6. **Minimalist Footer:** "Powered by Edfolio" footer is subtle and non-intrusive, providing brand awareness without detracting from content.

### Database Schema Changes

**No schema changes required.** Story 3.1 already added `viewCount` and `lastViewed` fields to PublishedPage model. This story populates and uses those fields.

**Existing Schema (from Story 3.1):**
```prisma
model PublishedPage {
  id              String    @id @default(cuid())
  noteId          String    @unique
  slug            String    @unique
  customSlug      Boolean   @default(false)
  isPublished     Boolean   @default(true)
  publishedAt     DateTime  @default(now())
  lastUpdated     DateTime  @updatedAt
  metaTitle       String?   @db.Text
  metaDescription String?   @db.Text
  ogImage         String?
  viewCount       Int       @default(0)      // Used in this story
  lastViewed      DateTime?                  // Used in this story
  note            Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([noteId])
  @@index([publishedAt])
}
```

**No migration needed** - fields already exist.

### ShareLinkDisplay Component

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/components/publish/ShareLinkDisplay.tsx`

**Complete Implementation:**

```typescript
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Clipboard, Check, Twitter, Linkedin, Mail } from 'lucide-react';
import { toast } from 'sonner';
import { shareOnTwitter, shareOnLinkedIn, shareViaEmail } from '@/lib/social-share';
import { ShareLinkDisplayProps } from '@/types';

export function ShareLinkDisplay({
  publicUrl,
  title,
  description,
}: ShareLinkDisplayProps) {
  const [isCopied, setIsCopied] = useState(false);

  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(publicUrl);
      setIsCopied(true);
      toast.success('Link copied to clipboard');
      setTimeout(() => setIsCopied(false), 2000);
    } catch (error) {
      // Fallback for browsers without Clipboard API
      fallbackCopyTextToClipboard(publicUrl);
    }
  };

  const fallbackCopyTextToClipboard = (text: string) => {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
      document.execCommand('copy');
      toast.success('Link copied to clipboard');
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    } catch (error) {
      toast.error('Failed to copy link');
    }

    document.body.removeChild(textArea);
  };

  return (
    <div className="space-y-[var(--spacing-md)]">
      {/* URL Display with Copy Button */}
      <div className="flex gap-[var(--spacing-sm)]">
        <Input
          value={publicUrl}
          readOnly
          className="flex-1 font-mono text-sm"
        />
        <Button
          variant="outline"
          onClick={handleCopyLink}
          className="min-w-[100px]"
        >
          {isCopied ? (
            <>
              <Check className="h-4 w-4 mr-2" />
              Copied!
            </>
          ) : (
            <>
              <Clipboard className="h-4 w-4 mr-2" />
              Copy
            </>
          )}
        </Button>
      </div>

      {/* Social Share Buttons */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-[var(--spacing-sm)]">
        <Button
          variant="outline"
          onClick={() => shareOnTwitter(title, publicUrl)}
          className="justify-start"
        >
          <Twitter className="h-4 w-4 mr-2" />
          Share on Twitter
        </Button>

        <Button
          variant="outline"
          onClick={() => shareOnLinkedIn(publicUrl)}
          className="justify-start"
        >
          <Linkedin className="h-4 w-4 mr-2" />
          Share on LinkedIn
        </Button>

        <Button
          variant="outline"
          onClick={() => shareViaEmail(title, publicUrl)}
          className="justify-start"
        >
          <Mail className="h-4 w-4 mr-2" />
          Share via Email
        </Button>
      </div>
    </div>
  );
}
```

**Key Features:**
- One-click copy with visual feedback
- Fallback copy method for older browsers
- Social share buttons for major platforms
- Responsive grid layout
- Toast notifications

### Social Share Helper Functions

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/lib/social-share.ts`

**Implementation:**

```typescript
/**
 * Share a page on Twitter
 */
export function shareOnTwitter(title: string, url: string): void {
  const encodedTitle = encodeURIComponent(title);
  const encodedUrl = encodeURIComponent(url);
  const twitterUrl = `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`;

  openSharePopup(twitterUrl, 600, 400);
}

/**
 * Share a page on LinkedIn
 */
export function shareOnLinkedIn(url: string): void {
  const encodedUrl = encodeURIComponent(url);
  const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;

  openSharePopup(linkedInUrl, 600, 600);
}

/**
 * Share a page via email
 */
export function shareViaEmail(title: string, url: string): void {
  const encodedTitle = encodeURIComponent(title);
  const encodedBody = encodeURIComponent(`Check out this page: ${url}`);
  const mailtoUrl = `mailto:?subject=${encodedTitle}&body=${encodedBody}`;

  // Open email client (doesn't use popup)
  window.location.href = mailtoUrl;
}

/**
 * Open a centered popup window for social sharing
 */
function openSharePopup(url: string, width: number, height: number): void {
  const left = window.screen.width / 2 - width / 2;
  const top = window.screen.height / 2 - height / 2;

  const features = [
    `width=${width}`,
    `height=${height}`,
    `left=${left}`,
    `top=${top}`,
    'resizable=yes',
    'scrollbars=yes',
    'toolbar=no',
    'menubar=no',
    'location=no',
    'status=no',
  ].join(',');

  window.open(url, '_blank', features);
}
```

### View Tracking Implementation

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/app/api/public/[slug]/track-view/route.ts`

**Implementation:**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { shouldTrackView } from '@/lib/view-tracking-cache';

export async function POST(
  request: NextRequest,
  { params }: { params: { slug: string } }
) {
  try {
    // Check if tracking is enabled
    if (process.env.ENABLE_VIEW_TRACKING !== 'true') {
      return NextResponse.json({ success: true });
    }

    const slug = params.slug;

    // Get IP address from request
    const ip =
      request.headers.get('x-forwarded-for')?.split(',')[0] ||
      request.headers.get('x-real-ip') ||
      'unknown';

    // Check if we should track this view (deduplication)
    if (!shouldTrackView(ip, slug)) {
      // Duplicate view within cache window - skip
      return NextResponse.json({ success: true });
    }

    // Find published page
    const publishedPage = await prisma.publishedPage.findUnique({
      where: { slug },
      select: { id: true, isPublished: true },
    });

    if (!publishedPage || !publishedPage.isPublished) {
      return NextResponse.json({ success: false }, { status: 404 });
    }

    // Increment view count and update last viewed
    await prisma.publishedPage.update({
      where: { id: publishedPage.id },
      data: {
        viewCount: {
          increment: 1,
        },
        lastViewed: new Date(),
      },
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('View tracking error:', error);
    // Silent failure - don't break page
    return NextResponse.json({ success: false }, { status: 500 });
  }
}
```

**Key Features:**
- IP-based deduplication (1 view per IP per hour)
- Environment variable to disable tracking
- Silent failure (doesn't break page if tracking fails)
- No PII stored in database

### View Tracking Cache

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/lib/view-tracking-cache.ts`

**Implementation:**

```typescript
interface ViewCacheEntry {
  timestamp: number;
}

// In-memory cache
const viewCache = new Map<string, ViewCacheEntry>();

// Cache TTL: 1 hour
const CACHE_TTL = 60 * 60 * 1000;

/**
 * Check if view should be tracked (not a duplicate)
 */
export function shouldTrackView(ip: string, slug: string): boolean {
  const key = `${ip}-${slug}`;
  const entry = viewCache.get(key);

  if (!entry) {
    // No entry - track and cache
    viewCache.set(key, { timestamp: Date.now() });
    return true;
  }

  // Entry exists - check if expired
  if (Date.now() - entry.timestamp > CACHE_TTL) {
    // Expired - track and update
    viewCache.set(key, { timestamp: Date.now() });
    return true;
  }

  // Not expired - skip (duplicate)
  return false;
}

/**
 * Clean up expired cache entries
 */
export function cleanupViewCache(): void {
  const now = Date.now();
  for (const [key, entry] of viewCache.entries()) {
    if (now - entry.timestamp > CACHE_TTL) {
      viewCache.delete(key);
    }
  }
}

// Run cleanup every hour
setInterval(cleanupViewCache, CACHE_TTL);
```

### PublishAnalytics Component

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/components/publish/PublishAnalytics.tsx`

**Implementation:**

```typescript
'use client';

import { Eye, Clock, Calendar } from 'lucide-react';
import { PublishAnalyticsProps } from '@/types';
import { formatDistanceToNow } from 'date-fns';

export function PublishAnalytics({
  viewCount,
  lastViewed,
  publishedAt,
}: PublishAnalyticsProps) {
  const formattedLastViewed = lastViewed
    ? formatDistanceToNow(new Date(lastViewed), { addSuffix: true })
    : 'Never';

  const formattedPublishedAt = formatDistanceToNow(new Date(publishedAt), {
    addSuffix: true,
  });

  return (
    <div className="space-y-[var(--spacing-md)]">
      <h3 className="text-sm font-medium text-[var(--foreground)]">
        Analytics
      </h3>

      {viewCount === 0 ? (
        <div className="text-center py-[var(--spacing-lg)] text-[var(--muted)]">
          <Eye className="h-8 w-8 mx-auto mb-[var(--spacing-sm)] opacity-50" />
          <p className="text-sm font-medium">No views yet</p>
          <p className="text-xs mt-[var(--spacing-xs)]">
            Share your page to get views!
          </p>
        </div>
      ) : (
        <div className="grid grid-cols-3 gap-[var(--spacing-md)]">
          {/* Total Views */}
          <div className="text-center p-[var(--spacing-md)] border border-[var(--border)] rounded-lg">
            <Eye className="h-5 w-5 mx-auto mb-[var(--spacing-xs)] text-[var(--accent)]" />
            <p className="text-2xl font-bold text-[var(--foreground)]">
              {viewCount.toLocaleString()}
            </p>
            <p className="text-xs text-[var(--muted)] mt-[var(--spacing-xs)]">
              Total Views
            </p>
          </div>

          {/* Last Viewed */}
          <div className="text-center p-[var(--spacing-md)] border border-[var(--border)] rounded-lg">
            <Clock className="h-5 w-5 mx-auto mb-[var(--spacing-xs)] text-[var(--accent)]" />
            <p className="text-sm font-medium text-[var(--foreground)]">
              {formattedLastViewed}
            </p>
            <p className="text-xs text-[var(--muted)] mt-[var(--spacing-xs)]">
              Last Viewed
            </p>
          </div>

          {/* Published */}
          <div className="text-center p-[var(--spacing-md)] border border-[var(--border)] rounded-lg">
            <Calendar className="h-5 w-5 mx-auto mb-[var(--spacing-xs)] text-[var(--accent)]" />
            <p className="text-sm font-medium text-[var(--foreground)]">
              {formattedPublishedAt}
            </p>
            <p className="text-xs text-[var(--muted)] mt-[var(--spacing-xs)]">
              Published
            </p>
          </div>
        </div>
      )}
    </div>
  );
}
```

### Analytics API Endpoint

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/app/api/notes/[noteId]/publish/analytics/route.ts`

**Implementation:**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/prisma';

export async function GET(
  request: NextRequest,
  { params }: { params: { noteId: string } }
) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const noteId = params.noteId;

    // Verify note ownership
    const note = await prisma.note.findUnique({
      where: { id: noteId },
      include: {
        folio: { select: { ownerId: true } },
        published: {
          select: {
            viewCount: true,
            lastViewed: true,
            publishedAt: true,
            isPublished: true,
          },
        },
      },
    });

    if (!note) {
      return NextResponse.json({ error: 'Note not found' }, { status: 404 });
    }

    if (note.folio.ownerId !== session.user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    if (!note.published || !note.published.isPublished) {
      return NextResponse.json(
        { error: 'Page is not published' },
        { status: 404 }
      );
    }

    return NextResponse.json({
      data: {
        viewCount: note.published.viewCount,
        lastViewed: note.published.lastViewed,
        publishedAt: note.published.publishedAt,
      },
    });
  } catch (error) {
    console.error('Analytics error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### PublicPageFooter Component

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/components/public-page/PublicPageFooter.tsx`

**Implementation:**

```typescript
export function PublicPageFooter() {
  return (
    <footer className="mt-[var(--spacing-xl)] py-[var(--spacing-lg)] border-t border-[var(--public-border)] bg-[var(--public-background)]">
      <div className="max-w-[var(--public-max-width)] mx-auto px-[var(--spacing-md)] text-center">
        <p className="text-sm text-[var(--public-muted)]">
          Powered by{' '}
          <a
            href="https://edfolio.app"
            className="text-[var(--public-accent)] hover:underline"
            target="_blank"
            rel="noopener noreferrer"
          >
            Edfolio
          </a>
        </p>
      </div>
    </footer>
  );
}
```

### GDPR Compliance

**No Cookies:**
- View tracking is entirely server-side
- No cookies set on public pages
- No client-side tracking scripts (no Google Analytics, etc.)

**No PII Storage:**
- IP addresses used only for deduplication (in-memory cache)
- IP addresses never stored in database
- Only aggregate metrics stored: viewCount (number), lastViewed (timestamp)

**Data Minimization:**
- Only essential data collected (page views)
- No user agent, referrer, or location data collected
- No cross-site tracking

**User Control:**
- Page owners can unpublish at any time (stops tracking)
- Analytics visible only to page owner (not public)
- No data shared with third parties

### Testing Strategy

**Manual Testing:**

1. **Copy Link:**
   - Click copy button
   - Verify toast appears
   - Paste into notepad → verify URL correct
   - Test on different browsers

2. **Social Sharing:**
   - Test Twitter share → verify popup, pre-filled content
   - Test LinkedIn share → verify popup, URL correct
   - Test email share → verify mail client opens

3. **View Tracking:**
   - Publish page, visit URL
   - Check analytics → viewCount = 1
   - Refresh page 10 times
   - Check analytics → still viewCount = 1
   - Wait 1 hour, visit again
   - Check analytics → viewCount = 2

4. **GDPR Validation:**
   - Open browser dev tools → Network tab
   - Visit public page
   - Verify no cookies set
   - Verify no third-party requests

### Known Limitations

**Current Implementation:**
- View tracking is IP-based (limited accuracy behind NAT/proxies)
- No referrer tracking (can't see where traffic comes from)
- No geographic data (can't see visitor locations)
- In-memory cache doesn't survive server restarts (rare duplicate views)

**Future Enhancements (Out of Scope):**
- Referrer tracking (where visitors come from)
- Geographic analytics (country-level, GDPR-compliant)
- Time-based charts (views over time)
- Popular pages ranking
- Export analytics as CSV

### Timeline Estimate

**Total estimated time: 22 hours**

Breakdown:
- ShareLinkDisplay component: 2.5 hours
- Integrate into PublishSettings: 1 hour
- Server-side view tracking: 3 hours
- Analytics display component: 2 hours
- Integrate analytics: 1 hour
- Analytics API endpoint: 1.5 hours
- "Powered by Edfolio" footer: 1.5 hours
- Copy to clipboard: 1 hour
- Social share helpers: 1 hour
- Type definitions: 0.5 hours
- ViewTracker component: 1.5 hours
- Rate limiting cache: 2 hours
- Environment variables: 0.25 hours
- Testing & validation: 4.5 hours

**Recommendation:** This story can be completed in 2.5-3 days. It's the final story in Epic 3.

### Code Quality Checklist

Before marking story as "Review", Developer Agent MUST verify:

- [ ] No hardcoded colors (all use CSS variables)
- [ ] No hardcoded spacing (all use CSS variables)
- [ ] No `any` types in TypeScript
- [ ] All components under 250 lines
- [ ] All API routes under 200 lines
- [ ] All utility files under 150 lines
- [ ] No cookies set on public pages
- [ ] No client-side tracking scripts
- [ ] No PII stored in database
- [ ] View tracking fails silently (doesn't break page)
- [ ] Copy button works with fallback
- [ ] Social share buttons open correctly
- [ ] Analytics display correct data
- [ ] Build succeeds with zero errors
- [ ] All imports use `@/` alias

## Definition of Done

- [ ] ShareLinkDisplay component created with copy and social buttons
- [ ] Copy to clipboard functionality works with fallback
- [ ] Twitter, LinkedIn, and Email share buttons functional
- [ ] Server-side view tracking implemented without cookies
- [ ] IP-based deduplication prevents duplicate counts
- [ ] PublishAnalytics component displays view metrics
- [ ] Analytics API endpoint created with ownership verification
- [ ] "Powered by Edfolio" footer added to all public pages
- [ ] GDPR compliance verified (no cookies, no PII)
- [ ] All acceptance criteria met and tested
- [ ] Build succeeds with zero errors
- [ ] Code follows all CLAUDE.md standards
- [ ] Social sharing tested on major platforms
- [ ] View tracking tested and deduplication works
