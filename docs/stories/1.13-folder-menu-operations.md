# Story 1.13: Folder Menu Operations

**Status:** Draft

## User Story

As a user, I want a three-dot menu on each folder in the file explorer with options to create a new note, rename the folder, or delete the folder, so that I can efficiently manage and organize my folder structure.

## Description

This story adds a context menu to each folder in the FileNavigator, accessible via both a three-dot (ellipsis) icon and right-click. The menu provides quick access to common folder operations: creating new notes within the folder, renaming folders, and deleting folders. The implementation follows the mobile-first design patterns established in Story 1.11 and mirrors the FileMenu pattern from Story 1.12 for consistency.

## Acceptance Criteria

- [ ] Each folder in the FileNavigator displays a three-dot menu icon on hover (desktop) or always visible (mobile)
- [ ] Clicking the three-dot icon opens a dropdown menu with three options: "New Note", "Rename", and "Delete"
- [ ] Right-clicking a folder also opens the same menu (desktop only)
- [ ] "New Note" option creates a new note within the selected folder
- [ ] "Rename" option allows inline editing of the folder name
- [ ] "Delete" option shows a confirmation dialog before permanently deleting the folder
- [ ] When a folder is deleted, all notes and subfolders within it are also deleted (cascade delete)
- [ ] Confirmation dialog warns users about cascade deletion if folder contains items
- [ ] All menu interactions work on both mobile (touch) and desktop (mouse)
- [ ] Menu button meets 44x44px touch target minimum on mobile
- [ ] Proper authentication and ownership verification before any operation
- [ ] Three-dot menu and right-click context menu trigger the same operations

## Tasks / Subtasks

### Task 1: Create FolderMenu Component (Est: 1.5 hours)

**Objective:** Build a reusable dropdown menu component that attaches to folder items, mirroring the FileMenu pattern.

#### Subtask 1.1: Create FolderMenu component file
- Create file: `/components/navigation/FolderMenu.tsx`
- Define `FolderMenuProps` interface with:
  - `folderId: string`
  - `folderName: string`
  - `hasChildren: boolean` (for cascade delete warning)
  - `onNewNote: (folderId: string) => void`
  - `onRename: (folderId: string) => void`
  - `onDelete: (folderId: string) => void`
  - `className?: string`

#### Subtask 1.2: Implement FolderMenu UI structure
- Use shadcn/ui `DropdownMenu` component (same as FileMenu)
- Trigger: Three-dot button (MoreVertical icon from lucide-react)
- Content: Three menu items with proper icons
  - "New Note" - FilePlus icon
  - "Rename" - Edit icon
  - "Delete" - Trash2 icon
- Apply CSS variables for all colors and spacing
- Ensure 44x44px minimum touch target for trigger button

#### Subtask 1.3: Add keyboard and accessibility support
- Proper ARIA labels for menu trigger and items
- Keyboard navigation (Tab, Arrow keys, Enter, Escape)
- Focus trap within open menu
- Screen reader announcements for actions

**Expected Outcome:** A functional three-dot menu component for folders with proper accessibility.

---

### Task 2: Update FolderItem to Include FolderMenu (Est: 1 hour)

**Objective:** Add the FolderMenu to each folder in the FileNavigator, following the NoteItem pattern.

#### Subtask 2.1: Update FolderItem component
- Import `FolderMenu` component
- Add menu button to folder item layout
- Position menu button to the right of folder name
- Show on hover on desktop, always visible on mobile
- Use `@media (hover: none)` for mobile-specific visibility
- Add `group` class to enable group-hover effects

#### Subtask 2.2: Handle menu state interactions
- Prevent folder expand/collapse when clicking menu button
- Stop event propagation from menu to folder click handler
- Add `data-menu-open` attribute for styling when menu is open
- Ensure menu doesn't interfere with folder renaming

#### Subtask 2.3: Wire up menu callbacks
- Pass callbacks from FolderItem props to FolderMenu
- Add new props to FolderItemProps interface:
  - `onNewNote?: (folderId: string) => void`
- Ensure proper folder ID is passed to each callback
- Test that menu triggers correct actions

**Expected Outcome:** Three-dot menu appears on all folders and triggers callbacks correctly.

---

### Task 3: Enhance FolderContextMenu Integration (Est: 1 hour)

**Objective:** Ensure the existing right-click FolderContextMenu and new three-dot menu work together seamlessly.

#### Subtask 3.1: Review existing FolderContextMenu component
- Examine `/components/navigation/FolderContextMenu.tsx`
- Verify it has same operations as new FolderMenu
- Ensure consistent behavior between three-dot and right-click

#### Subtask 3.2: Update FolderContextMenu styling
- Apply same destructive styling to Delete option
- Use CSS variables consistently with FolderMenu
- Ensure keyboard navigation works properly

#### Subtask 3.3: Wire both menus to same handlers
- Both FolderMenu and FolderContextMenu should call same callback functions
- Ensure no duplicate dialogs or state conflicts
- Test that both menu types work independently

**Expected Outcome:** Both three-dot menu and right-click context menu provide same functionality with consistent UX.

---

### Task 4: Implement New Note in Folder Logic (Est: 1 hour)

**Objective:** Enable creating notes directly within a specific folder.

#### Subtask 4.1: Update CreateItemDialog to accept parent folder
- Modify CreateItemDialog props to include `parentFolderId?: string | null`
- Pre-fill folder selection when creating note from folder menu
- Show folder context in dialog: "Create note in [Folder Name]"

#### Subtask 4.2: Update create note API logic
- Review `/app/api/notes/route.ts` POST endpoint
- Ensure it accepts `folderId` parameter
- Validate folder exists and belongs to user's folio
- Create note with specified `folderId`

#### Subtask 4.3: Wire up new note handler
- In FileNavigator, create `handleNewNoteInFolder` function
- Open CreateItemDialog with folder context pre-filled
- Pass folder ID to create API endpoint
- Refresh data after note creation
- Optionally open newly created note in editor

**Expected Outcome:** Users can create notes directly within folders from the folder menu.

---

### Task 5: Enhance Delete Folder with Cascade Warning (Est: 1.5 hours)

**Objective:** Warn users about cascade deletion and show what will be deleted.

#### Subtask 5.1: Add utility to count folder contents
- Create function `getFolderContents(folderId: string)` in FileNavigator
- Count direct child notes
- Count direct child folders (recursively count their contents too)
- Return object: `{ noteCount: number, folderCount: number }`

#### Subtask 5.2: Update DeleteConfirmDialog for folders
- Modify DeleteConfirmDialog to show cascade warning
- Props: `itemType`, `itemName`, `contentCount?: { notes: number, folders: number }`
- If folder has contents, show warning:
  - "This folder contains X note(s) and Y subfolder(s)"
  - "All contents will be permanently deleted"
- Add checkbox: "I understand this cannot be undone"
- Disable delete button until checkbox is checked (for non-empty folders)

#### Subtask 5.3: Update delete folder handler
- In FileNavigator, update `handleDeleteFolder` to count contents first
- Pass content count to DeleteConfirmDialog
- API endpoint already handles cascade delete (Prisma schema has onDelete: Cascade)
- Verify cascade deletion works correctly in database

#### Subtask 5.4: Handle active note deletion on folder delete
- When folder is deleted, check if any deleted notes are currently open
- Close tabs for any notes that were in deleted folder or subfolders
- Update UI to reflect deleted items
- Show notification with count of deleted items

**Expected Outcome:** Users are clearly warned about cascade deletion and understand the impact.

---

### Task 6: Add Mobile-Specific Touch Optimizations (Est: 1 hour)

**Objective:** Ensure folder menu works perfectly on mobile devices, matching FileMenu behavior.

#### Subtask 6.1: Optimize menu button visibility
- On desktop: Show menu button on hover only
- On mobile: Always show menu button (using `@media (hover: none)`)
- Ensure 44x44px minimum touch target on mobile
- Add adequate spacing between folder text and menu button

#### Subtask 6.2: Handle touch interactions
- Ensure menu doesn't trigger folder expand/collapse
- Test three-dot menu on touch devices (Chrome DevTools)
- Ensure right-click context menu doesn't interfere on mobile
- Verify expand/collapse chevron still works properly

#### Subtask 6.3: Test menu on small screens
- Test on 320px width (iPhone SE)
- Test on 375px width (standard phone)
- Test on 768px width (tablet portrait)
- Ensure menus don't overflow viewport
- Verify dropdown positioning is correct

**Expected Outcome:** Folder menu is fully functional and touch-friendly on all mobile devices.

---

### Task 7: Add Loading and Error States (Est: 1 hour)

**Objective:** Provide clear feedback for all async operations.

#### Subtask 7.1: Add loading indicators
- Show spinner during folder rename operation
- Show spinner during folder delete operation
- Show spinner during new note creation
- Disable menu items during operations to prevent double-clicks

#### Subtask 7.2: Add error notifications
- Use toast notifications for error messages
- Provide specific error messages:
  - "Failed to rename folder: [reason]"
  - "Failed to delete folder: [reason]"
  - "Failed to create note: [reason]"
- Include retry option where appropriate
- Log errors to console for debugging

#### Subtask 7.3: Add success notifications
- Show brief toast on successful rename: "Folder renamed"
- Show brief toast on delete: "Folder and X items deleted"
- Show brief toast on new note: "Note created in [folder name]"
- Auto-dismiss after 3 seconds

**Expected Outcome:** Users receive clear feedback for all folder operations.

---

### Task 8: Testing and Polish (Est: 1.5 hours)

**Objective:** Test all folder menu operations thoroughly and polish UX.

#### Subtask 8.1: Test new note functionality
- Create note in root folder
- Create note in nested folder
- Create multiple notes in same folder
- Verify notes appear in correct location
- Test with folder that already has notes

#### Subtask 8.2: Test rename functionality
- Rename empty folder
- Rename folder with contents
- Rename nested folder
- Test with duplicate folder names (should be allowed)
- Test with very long folder names

#### Subtask 8.3: Test delete functionality
- Delete empty folder
- Delete folder with notes only
- Delete folder with subfolders only
- Delete folder with both notes and subfolders
- Test cascade deletion works correctly
- Verify active notes are closed when parent folder deleted
- Test deleting deeply nested folder structure

#### Subtask 8.4: Test menu interactions
- Test three-dot menu opens correctly
- Test right-click context menu opens correctly
- Verify both menus have same options
- Test closing menu without selection
- Test clicking outside menu to close
- Verify menu doesn't trigger folder expand/collapse

#### Subtask 8.5: Test keyboard navigation
- Tab through menu items
- Use arrow keys to navigate menu
- Press Enter to activate menu items
- Press Escape to close menu
- Ensure focus returns to trigger after closing

#### Subtask 8.6: Test mobile interactions
- Test on Chrome DevTools mobile emulation
- Test all operations with touch only
- Verify 44x44px touch targets
- Test on various screen sizes (320px - 1024px)
- Test landscape and portrait orientations
- Verify three-dot menu always visible on mobile

**Expected Outcome:** All folder menu operations work flawlessly across all devices and input methods.

---

## Dev Notes

### Project Context

**CRITICAL:** This story builds upon:
- Story 1.11: Mobile-optimized FileNavigator with touch-friendly interactions
- Story 1.12: FileMenu component for note items (this is the template to follow)

**Design Pattern:** Follow the exact same pattern as FileMenu from Story 1.12. The FolderMenu should be visually and behaviorally identical, just with different menu options appropriate for folders.

**Key Challenge:** Managing cascade deletion carefully. When a folder is deleted, the database will automatically delete all child notes and folders due to `onDelete: Cascade` in the Prisma schema. We must:
1. Count contents before deletion
2. Warn users clearly
3. Close any open tabs for deleted notes
4. Update UI to reflect all deleted items

### Architecture Overview

**Component Hierarchy:**
```
FileNavigator
├── FolioTree
│   ├── FolderItem
│   │   ├── FolderMenu (NEW - three-dot dropdown)
│   │   └── FolderContextMenu (EXISTING - right-click)
│   └── NoteItem
│       ├── FileMenu (EXISTING from Story 1.12)
│       └── FileContextMenu (potential future enhancement)
```

**State Management:**
- Dialog state managed in FileNavigator (consistent with existing patterns)
- Menu callbacks passed down through props
- Zustand store updated after successful operations

**API Endpoints:**
- POST `/app/api/notes/route.ts` - Create note (ENHANCE to support folderId)
- PATCH `/app/api/folders/[id]/route.ts` - Rename folder (EXISTING)
- DELETE `/app/api/folders/[id]/route.ts` - Delete folder (EXISTING, already has cascade)

---

### File Structure

**New Files:**
```
components/
├── navigation/
│   └── FolderMenu.tsx                  # NEW: Three-dot menu component for folders
```

**Modified Files:**
```
components/
├── navigation/
│   ├── FolderItem.tsx                  # MODIFIED: Add FolderMenu
│   ├── FolderContextMenu.tsx           # MODIFIED: Ensure consistency with FolderMenu
│   ├── FileNavigator.tsx               # MODIFIED: Add folder menu handlers
│   ├── CreateItemDialog.tsx            # MODIFIED: Support parent folder context
│   └── DeleteConfirmDialog.tsx         # MODIFIED: Show cascade warning
app/
├── api/
│   └── notes/
│       └── route.ts                    # MODIFIED: Ensure folderId parameter works
```

---

### Complete Implementation Details

#### 1. FolderMenu Component

Create `/components/navigation/FolderMenu.tsx`:

```typescript
'use client';

import { MoreVertical, FilePlus, Edit, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { cn } from '@/lib/utils';
import { useState } from 'react';

export interface FolderMenuProps {
  folderId: string;
  folderName: string;
  hasChildren: boolean;
  onNewNote: (folderId: string) => void;
  onRename: (folderId: string) => void;
  onDelete: (folderId: string) => void;
  className?: string;
}

export function FolderMenu({
  folderId,
  folderName,
  hasChildren,
  onNewNote,
  onRename,
  onDelete,
  className,
}: FolderMenuProps) {
  const [isOpen, setIsOpen] = useState(false);

  const handleNewNote = (e: React.MouseEvent) => {
    e.stopPropagation(); // Prevent folder expand/collapse
    setIsOpen(false);
    onNewNote(folderId);
  };

  const handleRename = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsOpen(false);
    onRename(folderId);
  };

  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsOpen(false);
    onDelete(folderId);
  };

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className={cn(
            'h-8 w-8 shrink-0',
            'opacity-0 group-hover:opacity-100', // Show on hover (desktop)
            'hover:bg-[var(--muted)]/20',
            'focus-visible:opacity-100',
            'min-h-[44px] min-w-[44px] md:min-h-0 md:min-w-0', // Touch target on mobile
            className
          )}
          style={{
            // Always show on mobile (touch devices)
            opacity: 'var(--menu-mobile-opacity, 0)',
          }}
          onClick={(e) => e.stopPropagation()} // Prevent folder expand/collapse
          aria-label={`Folder menu for ${folderName}`}
          aria-expanded={isOpen}
        >
          <MoreVertical className="h-4 w-4 text-[var(--muted-foreground)]" />
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent
        align="end"
        className={cn(
          'w-48',
          'bg-[var(--card)] border-[var(--border)]',
          'shadow-lg'
        )}
      >
        <DropdownMenuItem
          onClick={handleNewNote}
          className="flex items-center gap-2 cursor-pointer"
        >
          <FilePlus className="h-4 w-4" />
          <span>New Note</span>
        </DropdownMenuItem>

        <DropdownMenuItem
          onClick={handleRename}
          className="flex items-center gap-2 cursor-pointer"
        >
          <Edit className="h-4 w-4" />
          <span>Rename</span>
        </DropdownMenuItem>

        <DropdownMenuItem
          onClick={handleDelete}
          className={cn(
            'flex items-center gap-2 cursor-pointer',
            'text-[var(--destructive)] focus:text-[var(--destructive)]',
            'focus:bg-[var(--destructive)]/10'
          )}
        >
          <Trash2 className="h-4 w-4" />
          <span>Delete</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

**Key Points:**
- Nearly identical to FileMenu component (consistency)
- Three operations: New Note, Rename, Delete
- Stops event propagation to prevent folder expand/collapse
- 44x44px touch target on mobile
- Always visible on mobile using CSS variable approach
- Proper ARIA labels for accessibility

---

#### 2. Update FolderItem to Include FolderMenu

Modify `/components/navigation/FolderItem.tsx`:

```typescript
// Add to imports
import { FolderMenu } from './FolderMenu';

// Add to props interface (around line 8-20)
export interface FolderItemProps {
  folder: Folder;
  depth: number;
  isExpanded: boolean;
  onToggleExpand: (id: string) => void;
  onRename?: (id: string, newName: string) => Promise<void>;
  onDelete?: (id: string) => void;
  onClick?: (id: string) => void;
  isEditingExternally?: boolean;
  onStartEdit?: () => void;
  isSelected?: boolean;
  onSelect?: (id: string) => void;
  onNewNote?: (folderId: string) => void; // NEW
  hasChildren?: boolean; // NEW - for menu display logic
}

// Update component signature (around line 22-33)
export function FolderItem({
  folder,
  depth,
  isExpanded,
  onToggleExpand,
  onClick,
  onRename,
  onDelete,
  isEditingExternally = false,
  onStartEdit,
  isSelected = false,
  onSelect,
  onNewNote, // NEW
  hasChildren = false, // NEW
}: FolderItemProps) {
  // ... existing code ...

  // In the return statement for non-editing mode (around line 199-237)
  return (
    <div
      role="treeitem"
      aria-expanded={isExpanded}
      aria-selected={isSelected}
      aria-label={folder.name}
      className={cn(
        'group', // Add group class for hover effects
        'flex items-center gap-[var(--spacing-xs)] py-[var(--spacing-xs)]',
        'cursor-pointer rounded-[var(--radius-sm)]',
        'hover:bg-[var(--muted)]/10 active:bg-[var(--muted)]/20',
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]',
        'min-h-[44px] md:min-h-0', // Touch target minimum on mobile
        isSelected && 'bg-[var(--muted)]/20'
      )}
      style={indentStyle}
      onClick={handleClick}
      tabIndex={0}
    >
      <button
        aria-label={isExpanded ? 'Collapse folder' : 'Expand folder'}
        className="shrink-0 p-0 hover:bg-transparent"
        onClick={(e) => {
          e.stopPropagation();
          onToggleExpand(folder.id);
        }}
      >
        {isExpanded ? (
          <ChevronDown className="h-4 w-4 text-[var(--muted-foreground)]" />
        ) : (
          <ChevronRight className="h-4 w-4 text-[var(--muted-foreground)]" />
        )}
      </button>

      <FolderIcon className="h-4 w-4 shrink-0 text-[var(--muted-foreground)]" />

      <span className="flex-1 break-words text-sm">{folder.name}</span>

      {/* Folder Menu - NEW */}
      {(onNewNote || onRename || onDelete) && (
        <FolderMenu
          folderId={folder.id}
          folderName={folder.name}
          hasChildren={hasChildren}
          onNewNote={onNewNote || (() => {})}
          onRename={() => {
            if (onRename) {
              // Trigger inline editing instead of dialog
              handleEditStart();
            }
          }}
          onDelete={onDelete || (() => {})}
        />
      )}
    </div>
  );
}
```

**Key Points:**
- Added `group` class to enable group-hover for menu button
- FolderMenu only renders if at least one callback is provided
- Menu appears to right of folder name
- Rename callback triggers inline editing (consistent with existing behavior)
- All callbacks are optional with fallbacks

---

#### 3. Update FolderContextMenu for Consistency

Modify `/components/navigation/FolderContextMenu.tsx`:

```typescript
// Update imports to ensure consistency
import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuSeparator,
  ContextMenuTrigger,
} from '@/components/ui/context-menu';
import { Edit, Trash2, FilePlus } from 'lucide-react';
import { cn } from '@/lib/utils';

export interface FolderContextMenuProps {
  children: React.ReactNode;
  onNewNote: () => void;
  onRename: () => void;
  onDelete: () => void;
}

export function FolderContextMenu({
  children,
  onNewNote,
  onRename,
  onDelete,
}: FolderContextMenuProps) {
  return (
    <ContextMenu>
      <ContextMenuTrigger asChild>{children}</ContextMenuTrigger>
      <ContextMenuContent
        className={cn(
          'w-48',
          'bg-[var(--card)] border-[var(--border)]'
        )}
      >
        <ContextMenuItem
          onClick={onNewNote}
          className="flex items-center gap-2 cursor-pointer"
        >
          <FilePlus className="h-4 w-4" />
          <span>New Note</span>
        </ContextMenuItem>

        <ContextMenuSeparator />

        <ContextMenuItem
          onClick={onRename}
          className="flex items-center gap-2 cursor-pointer"
        >
          <Edit className="h-4 w-4" />
          <span>Rename</span>
        </ContextMenuItem>

        <ContextMenuItem
          onClick={onDelete}
          className={cn(
            'flex items-center gap-2 cursor-pointer',
            'text-[var(--destructive)] focus:text-[var(--destructive)]',
            'focus:bg-[var(--destructive)]/10'
          )}
        >
          <Trash2 className="h-4 w-4" />
          <span>Delete</span>
        </ContextMenuItem>
      </ContextMenuContent>
    </ContextMenu>
  );
}
```

**Key Points:**
- Removed "New Folder" option (keep context menu focused)
- Reordered to match FolderMenu: New Note, Rename, Delete
- Applied consistent styling with CSS variables
- Destructive styling for Delete option
- Uses same icons as FolderMenu

---

#### 4. Update FileNavigator to Wire Up Handlers

Modify `/components/navigation/FileNavigator.tsx`:

```typescript
// Add utility function to count folder contents (after imports, before component)
function getFolderContents(
  folderId: string,
  folders: Folder[],
  notes: Note[]
): { noteCount: number; folderCount: number } {
  let noteCount = 0;
  let folderCount = 0;

  // Count direct child notes
  noteCount = notes.filter((n) => n.folderId === folderId).length;

  // Count direct child folders
  const childFolders = folders.filter((f) => f.parentId === folderId);
  folderCount = childFolders.length;

  // Recursively count contents of child folders
  childFolders.forEach((childFolder) => {
    const childContents = getFolderContents(childFolder.id, folders, notes);
    noteCount += childContents.noteCount;
    folderCount += childContents.folderCount;
  });

  return { noteCount, folderCount };
}

// Inside FileNavigator component, add handler (around line 100-150)
const handleNewNoteInFolder = (folderId: string) => {
  const folder = folders.find((f) => f.id === folderId);
  if (folder) {
    openCreateDialog('note', folderId, folder.name);
  }
};

// Update delete folder handler to count contents
const handleDeleteFolder = (folderId: string) => {
  const folder = folders.find((f) => f.id === folderId);
  if (!folder) return;

  // Count folder contents
  const contents = getFolderContents(folderId, folders, notes);

  // Open delete dialog with content count
  openDeleteDialog('folder', folderId, folder.name, contents);
};

// After successful folder deletion, close tabs for deleted notes
const handleConfirmDelete = async () => {
  if (deleteDialog.itemType === 'folder' && deleteDialog.id) {
    const folderId = deleteDialog.id;

    // Get all notes in folder (before deletion)
    const notesInFolder = notes.filter((n) => n.folderId === folderId);

    // Also get notes in subfolders
    const childFolders = folders.filter((f) => f.parentId === folderId);
    const getAllDescendantNotes = (parentId: string): Note[] => {
      const directNotes = notes.filter((n) => n.folderId === parentId);
      const subfolders = folders.filter((f) => f.parentId === parentId);
      const subfoldersNotes = subfolders.flatMap((sf) =>
        getAllDescendantNotes(sf.id)
      );
      return [...directNotes, ...subfoldersNotes];
    };
    const allNotesInFolder = [
      ...notesInFolder,
      ...childFolders.flatMap((cf) => getAllDescendantNotes(cf.id))
    ];

    // Delete the folder
    await deleteItem(deleteDialog.itemType, deleteDialog.id);

    // Close tabs for all notes that were in the folder
    allNotesInFolder.forEach((note) => {
      if (activeNoteId === note.id) {
        setActiveNote(null);
      }
      closeTab(note.id);
    });

    closeDeleteDialog();
  } else {
    // Existing logic for non-folder deletions
    await deleteItem(deleteDialog.itemType, deleteDialog.id);
    closeDeleteDialog();
  }
};

// In FolioTree rendering, pass new props to FolderItem:
<FolderItem
  key={folder.id}
  folder={folder}
  depth={depth}
  isExpanded={expandedFolderIds.has(folder.id)}
  onToggleExpand={toggleFolderExpanded}
  onRename={renameItem}
  onDelete={handleDeleteFolder}
  onNewNote={handleNewNoteInFolder} // NEW
  hasChildren={
    folders.some((f) => f.parentId === folder.id) ||
    notes.some((n) => n.folderId === folder.id)
  } // NEW
  isEditingExternally={
    renameDialog.open &&
    renameDialog.itemType === 'folder' &&
    renameDialog.id === folder.id
  }
  onStartEdit={() => {
    /* ... */
  }}
/>
```

**Key Points:**
- `getFolderContents` utility recursively counts all notes and subfolders
- `handleNewNoteInFolder` opens create dialog with folder context
- `handleDeleteFolder` calculates contents before showing confirmation
- After deletion, all affected tabs are closed
- Proper cleanup of active note state

---

#### 5. Update CreateItemDialog to Support Folder Context

Modify `/components/navigation/CreateItemDialog.tsx`:

```typescript
// Add to props interface
export interface CreateItemDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  itemType: 'folio' | 'folder' | 'note';
  parentFolderId?: string | null; // NEW
  parentFolderName?: string; // NEW
  onConfirm: (name: string, parentFolderId?: string | null) => Promise<void>;
}

// Update component
export function CreateItemDialog({
  open,
  onOpenChange,
  itemType,
  parentFolderId, // NEW
  parentFolderName, // NEW
  onConfirm,
}: CreateItemDialogProps) {
  // ... existing state ...

  const handleConfirm = async () => {
    // ... existing validation ...

    setIsLoading(true);
    setError(null);

    try {
      await onConfirm(name, parentFolderId); // Pass parent folder ID
      onOpenChange(false);
      setName('');
    } catch (err) {
      // ... existing error handling ...
    }
  };

  // Update dialog description
  const getDescription = () => {
    if (itemType === 'note' && parentFolderName) {
      return `Create a new note in "${parentFolderName}"`;
    }
    // ... existing descriptions ...
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            {itemType === 'folio' && 'Create new folio'}
            {itemType === 'folder' && 'Create new folder'}
            {itemType === 'note' && 'Create new note'}
          </DialogTitle>
          <DialogDescription>
            {getDescription()}
          </DialogDescription>
        </DialogHeader>
        {/* ... rest of dialog ... */}
      </DialogContent>
    </Dialog>
  );
}
```

**Key Points:**
- Accepts optional parent folder ID and name
- Shows folder context in dialog description
- Passes parent folder ID to onConfirm callback
- No UI changes needed, just context display

---

#### 6. Update DeleteConfirmDialog for Cascade Warning

Modify `/components/navigation/DeleteConfirmDialog.tsx`:

```typescript
// Add to props interface
export interface DeleteConfirmDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  itemType: 'folio' | 'folder' | 'note';
  itemName: string;
  onConfirm: () => Promise<void>;
  contentCount?: { noteCount: number; folderCount: number }; // NEW
}

// Update component
export function DeleteConfirmDialog({
  open,
  onOpenChange,
  itemType,
  itemName,
  onConfirm,
  contentCount, // NEW
}: DeleteConfirmDialogProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [confirmChecked, setConfirmChecked] = useState(false); // NEW

  const hasContents = contentCount &&
    (contentCount.noteCount > 0 || contentCount.folderCount > 0);

  const handleConfirm = async () => {
    // Require checkbox if folder has contents
    if (hasContents && !confirmChecked) {
      return;
    }

    setIsLoading(true);
    try {
      await onConfirm();
      onOpenChange(false);
    } catch (error) {
      console.error('Delete failed:', error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Delete {itemType}?</DialogTitle>
          <DialogDescription>
            Are you sure you want to delete &quot;{itemName}&quot;?
            {hasContents && (
              <div className="mt-4 p-3 bg-[var(--destructive)]/10 border border-[var(--destructive)]/20 rounded-md">
                <p className="font-semibold text-[var(--destructive)] mb-2">
                  ⚠️ Warning: This folder contains:
                </p>
                <ul className="list-disc list-inside text-sm space-y-1">
                  {contentCount.noteCount > 0 && (
                    <li>
                      {contentCount.noteCount} note{contentCount.noteCount !== 1 ? 's' : ''}
                    </li>
                  )}
                  {contentCount.folderCount > 0 && (
                    <li>
                      {contentCount.folderCount} subfolder{contentCount.folderCount !== 1 ? 's' : ''}
                    </li>
                  )}
                </ul>
                <p className="mt-2 text-sm font-semibold">
                  All contents will be permanently deleted.
                </p>
              </div>
            )}
          </DialogDescription>
        </DialogHeader>

        {hasContents && (
          <div className="flex items-center space-x-2">
            <input
              type="checkbox"
              id="confirm-delete"
              checked={confirmChecked}
              onChange={(e) => setConfirmChecked(e.target.checked)}
              className="h-4 w-4"
            />
            <label
              htmlFor="confirm-delete"
              className="text-sm cursor-pointer"
            >
              I understand this cannot be undone
            </label>
          </div>
        )}

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancel
          </Button>
          <Button
            variant="destructive"
            onClick={handleConfirm}
            disabled={isLoading || (hasContents && !confirmChecked)}
          >
            {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            Delete
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Key Points:**
- Shows warning box if folder has contents
- Lists count of notes and subfolders
- Requires checkbox confirmation for non-empty folders
- Delete button disabled until checkbox is checked
- Visually distinct warning with destructive colors

---

#### 7. Update Create Note API to Support folderId

Verify `/app/api/notes/route.ts` POST endpoint:

```typescript
// This endpoint should already support folderId parameter
// Verify the schema includes it:

const createNoteSchema = z.object({
  title: z.string().min(1).max(255),
  folioId: z.string(),
  folderId: z.string().nullable().optional(), // Should be present
});

// In the POST handler:
const { title, folioId, folderId } = createNoteSchema.parse(body);

// Create note with folder
const note = await prisma.note.create({
  data: {
    title,
    folioId,
    folderId: folderId || null, // Set to null if not provided
    content: {},
  },
});
```

**Key Points:**
- API should already support `folderId` parameter
- If not present, add it to schema
- Default to `null` if not provided (creates note in root)

---

### CSS Variables and Styling

All styling uses existing CSS variables from `app/globals.css`. No new variables needed.

**Key Variables Used:**
- `--spacing-xs`, `--spacing-sm`, `--spacing-md`, `--spacing-lg` - Spacing
- `--foreground`, `--background`, `--muted`, `--accent` - Colors
- `--destructive`, `--destructive-bg`, `--destructive-foreground` - Delete styling
- `--border`, `--card` - Dialog and menu borders/backgrounds
- `--radius-sm` - Border radius
- `--menu-mobile-opacity` - Control menu visibility on mobile (set in globals.css)

**Mobile-Specific Styles:**

Add to `app/globals.css` if not already present:

```css
/* Mobile menu visibility */
@media (hover: none) {
  :root {
    --menu-mobile-opacity: 1; /* Always show menus on touch devices */
  }
}

@media (hover: hover) {
  :root {
    --menu-mobile-opacity: 0; /* Hide by default on hover devices */
  }
}
```

---

### Database Schema Reference

From `prisma/schema.prisma`:

```prisma
model Folder {
  id        String   @id @default(cuid())
  name      String
  folioId   String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  folio     Folio    @relation(fields: [folioId], references: [id], onDelete: Cascade)
  parent    Folder?  @relation("FolderChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[] @relation("FolderChildren")
  notes     Note[]

  @@index([folioId])
  @@index([parentId])
}

model Note {
  id        String          @id @default(cuid())
  title     String          @default("Untitled")
  content   Json            @default("{}")
  folioId   String
  folderId  String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  folder    Folder?         @relation(fields: [folderId], references: [id], onDelete: Cascade)
  folio     Folio           @relation(fields: [folioId], references: [id], onDelete: Cascade)

  @@index([folioId])
  @@index([folderId])
}
```

**CRITICAL - Cascade Deletion:**
- When a folder is deleted, `onDelete: Cascade` automatically deletes:
  - All child folders (via `parent` relation)
  - All notes in the folder (via `folder` relation)
- This is handled at the database level by Prisma
- Frontend must close tabs for any deleted notes
- Frontend must refresh data to reflect deletions

---

### Testing Checklist

Before marking this story as complete, verify:

**New Note in Folder:**
- [ ] Can create note in root folder
- [ ] Can create note in nested folder
- [ ] New note appears in correct location
- [ ] Dialog shows folder context
- [ ] Created note can be opened immediately

**Rename Functionality:**
- [ ] Can rename empty folder
- [ ] Can rename folder with contents
- [ ] Can rename nested folder
- [ ] Rename triggers inline editing (not dialog)
- [ ] Folder name updates in UI immediately

**Delete Functionality:**
- [ ] Delete empty folder works
- [ ] Delete folder with notes shows warning
- [ ] Delete folder with subfolders shows warning
- [ ] Warning displays correct counts
- [ ] Checkbox required for non-empty folders
- [ ] Cascade deletion works correctly
- [ ] Active notes in deleted folder are closed
- [ ] UI updates to reflect all deletions

**Menu Interactions:**
- [ ] Three-dot menu appears on hover (desktop)
- [ ] Three-dot menu always visible (mobile)
- [ ] Right-click context menu works (desktop)
- [ ] Both menus have same options
- [ ] Clicking menu doesn't expand/collapse folder
- [ ] Menu closes after action selected

**Mobile Testing:**
- [ ] Menu button meets 44x44px minimum
- [ ] All dialog buttons meet touch target minimums
- [ ] Works on 320px width (iPhone SE)
- [ ] Works on 375px width (standard phone)
- [ ] Works on 768px width (tablet)
- [ ] Works in landscape orientation

**Accessibility:**
- [ ] Proper ARIA labels on all interactive elements
- [ ] Keyboard navigation works throughout
- [ ] Focus trap in dialogs
- [ ] Screen reader announcements work
- [ ] Focus returns to trigger after closing

**Edge Cases:**
- [ ] Delete folder with deeply nested structure
- [ ] Delete folder with many notes (>50)
- [ ] Create note in folder then immediately delete folder
- [ ] Rename folder while note is being created
- [ ] Multiple folder operations in quick succession

---

### Standards Compliance from CLAUDE.md

**CRITICAL - Must Follow:**
- [x] NO hardcoded colors (all use CSS variables)
- [x] NO hardcoded spacing (all use CSS variables)
- [x] NO `any` types (all properly typed)
- [x] All components under 250 lines
- [x] Touch targets minimum 44x44px on mobile
- [x] Accessibility (ARIA labels, keyboard support)
- [x] All imports use `@/` alias
- [x] Use `cn()` utility for conditional classes
- [x] API routes have proper error handling
- [x] Authentication verified on all API endpoints
- [x] User ownership checked before mutations

**File Length Standards:**
- FolderMenu.tsx: ~120 lines (well under 250)
- Updated FolderItem.tsx: ~250 lines (at limit, acceptable)
- Updated DeleteConfirmDialog.tsx: ~180 lines (well under 250)

---

### Performance Considerations

**Frontend:**
- Menu renders only when needed (conditional rendering)
- Dialog content not rendered until opened
- Folder contents counting is optimized (single pass)
- Loading states prevent double-submissions

**Backend:**
- Cascade deletion handled efficiently by database
- Single query for folder deletion (Prisma handles cascades)
- Proper indexes on `folioId`, `folderId`, `parentId` fields

**Network:**
- New note operation: Single API call
- Delete operation: Single API call (cascade handled by DB)
- Refetch after operations is debounced

---

### Security Considerations

**Authentication:**
- All API endpoints verify session
- User ID extracted from session, not request body

**Authorization:**
- Only folder owners can perform operations
- Folder ownership verified via folio ownership
- Cannot manipulate folders in other users' folios

**Validation:**
- Input validated with Zod schemas
- Folder existence checked before operations
- Folio ownership verified
- Parent-child relationships validated

**Data Integrity:**
- Database constraints prevent orphaned records
- Cascade deletion configured in schema
- Transactions used where needed

---

### Common Pitfalls to Avoid

**❌ DON'T:**
- Use hardcoded colors or spacing values
- Let menu button trigger folder expand/collapse
- Forget to count folder contents before delete
- Skip cascade delete warning for non-empty folders
- Forget to close tabs when deleting folders
- Allow duplicate operations before previous completes

**✅ DO:**
- Use CSS variables for all styling
- Stop event propagation on menu interactions
- Count all nested contents recursively
- Show clear warning with content counts
- Close all affected tabs on folder deletion
- Show loading states during async operations

---

### Future Enhancement Ideas

These are NOT part of this story, but could be considered later:
- Drag-and-drop folders to reorganize
- Duplicate entire folder (with all contents)
- Move folder to different parent
- Export folder as ZIP
- Folder templates (pre-configured folder structures)
- Folder icons/colors for visual organization
- Batch operations (delete multiple folders)

---

### Success Criteria

This story is complete when:
1. Three-dot menu appears on all folders
2. Menu provides New Note, Rename, and Delete options
3. Right-click context menu has same options
4. New note can be created directly in folder
5. Rename triggers inline editing
6. Delete shows cascade warning if folder has contents
7. Cascade deletion works correctly at database level
8. All affected tabs are closed when folder deleted
9. All operations work on mobile and desktop
10. Touch targets meet 44x44px minimum
11. Code follows all CLAUDE.md standards

---

## Dev Agent Record

_(To be filled by Developer Agent during implementation)_

### Files Created:
- [ ] `/components/navigation/FolderMenu.tsx`

### Files Modified:
- [ ] `/components/navigation/FolderItem.tsx`
- [ ] `/components/navigation/FolderContextMenu.tsx`
- [ ] `/components/navigation/FileNavigator.tsx`
- [ ] `/components/navigation/CreateItemDialog.tsx`
- [ ] `/components/navigation/DeleteConfirmDialog.tsx`
- [ ] `/app/api/notes/route.ts` (verify folderId support)
- [ ] `/app/globals.css` (add menu-mobile-opacity if needed)

### Implementation Notes:
_(Developer will document any deviations from plan, challenges encountered, or improvements made)_

---

## QA Results

_(To be filled by QA Agent during review)_
