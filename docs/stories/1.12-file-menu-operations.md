# Story 1.12: File Menu Operations

**Status:** Draft

## User Story

As a user, I want a three-dot menu on each file in the file explorer with options to move files to a new folder, duplicate, or delete, so that I can efficiently manage and organize my notes.

## Description

This story adds a context menu to each note in the FileNavigator, accessible via a three-dot (ellipsis) icon. The menu provides quick access to common file operations: moving notes to different folders, duplicating notes, and deleting notes. The implementation follows the mobile-first design patterns established in Story 1.11, ensuring touch-friendly interactions on all devices.

## Acceptance Criteria

- [ ] Each note in the FileNavigator displays a three-dot menu icon on hover (desktop) or always visible (mobile)
- [ ] Clicking the three-dot icon opens a dropdown menu with three options: "Move to folder", "Duplicate", and "Delete"
- [ ] "Move to folder" option opens a dialog showing all available folders in a hierarchical tree structure
- [ ] User can select a destination folder (including root/no folder) and confirm the move
- [ ] Moving a note updates its location in the FileNavigator immediately
- [ ] "Duplicate" option creates a copy of the note with " (Copy)" appended to the title
- [ ] Duplicated note appears in the same folder as the original
- [ ] "Delete" option shows a confirmation dialog before permanently deleting the note
- [ ] All menu interactions work on both mobile (touch) and desktop (mouse)
- [ ] Menu button meets 44x44px touch target minimum on mobile
- [ ] Proper authentication and ownership verification before any operation
- [ ] If the currently active note is deleted, the editor closes gracefully

## Tasks / Subtasks

### Task 1: Create FileMenu Component (Est: 1.5 hours)

**Objective:** Build a reusable dropdown menu component that attaches to note items.

#### Subtask 1.1: Create FileMenu component file
- Create file: `/components/navigation/FileMenu.tsx`
- Define `FileMenuProps` interface with:
  - `noteId: string`
  - `noteTitle: string`
  - `folderId: string | null`
  - `onMove: (noteId: string) => void`
  - `onDuplicate: (noteId: string) => void`
  - `onDelete: (noteId: string) => void`
  - `className?: string`

#### Subtask 1.2: Implement FileMenu UI structure
- Use shadcn/ui `DropdownMenu` component
- Trigger: Three-dot button (MoreVertical icon from lucide-react)
- Content: Three menu items with proper icons
  - "Move to folder" - FolderInput icon
  - "Duplicate" - Copy icon
  - "Delete" - Trash2 icon
- Apply CSS variables for all colors and spacing
- Ensure 44x44px minimum touch target for trigger button

#### Subtask 1.3: Add keyboard and accessibility support
- Proper ARIA labels for menu trigger and items
- Keyboard navigation (Tab, Arrow keys, Enter, Escape)
- Focus trap within open menu
- Screen reader announcements for actions

**Expected Outcome:** A functional three-dot menu component with proper accessibility.

---

### Task 2: Integrate FileMenu into NoteItem (Est: 1 hour)

**Objective:** Add the FileMenu to each note in the FileNavigator.

#### Subtask 2.1: Update NoteItem component
- Import `FileMenu` component
- Add menu button to note item layout
- Position menu button to the right of note title
- Show on hover on desktop, always visible on mobile
- Use `@media (hover: none)` for mobile-specific visibility

#### Subtask 2.2: Handle menu state interactions
- Prevent note selection when clicking menu button
- Stop event propagation from menu to note click handler
- Add `data-menu-open` attribute for styling when menu is open
- Ensure menu doesn't interfere with note renaming

#### Subtask 2.3: Wire up menu callbacks
- Pass callbacks from NoteItem props to FileMenu
- Ensure proper note ID is passed to each callback
- Test that menu triggers correct actions

**Expected Outcome:** Three-dot menu appears on all notes and triggers callbacks correctly.

---

### Task 3: Create MoveFolderDialog Component (Est: 2 hours)

**Objective:** Build a dialog that displays a folder tree and allows selecting a destination.

#### Subtask 3.1: Create MoveFolderDialog component file
- Create file: `/components/navigation/MoveFolderDialog.tsx`
- Define `MoveFolderDialogProps` interface:
  - `open: boolean`
  - `onOpenChange: (open: boolean) => void`
  - `noteId: string`
  - `noteTitle: string`
  - `currentFolderId: string | null`
  - `folders: Folder[]`
  - `onConfirm: (noteId: string, targetFolderId: string | null) => Promise<void>`

#### Subtask 3.2: Implement folder tree UI
- Use shadcn/ui Dialog component
- Display hierarchical folder structure
- Expand/collapse folder tree nodes
- Highlight current folder location
- Include "Root (No folder)" option at top
- Show folder icons and names
- Apply proper indentation for nested folders

#### Subtask 3.3: Add folder selection logic
- Track selected destination folder in local state
- Allow clicking folder to select it
- Visually indicate selected folder (checkbox or highlight)
- Validate selection (can't move to current location)
- Disable/gray out current folder in the list

#### Subtask 3.4: Implement confirm/cancel actions
- "Move" button (primary) - executes move operation
- "Cancel" button (secondary) - closes dialog
- Show loading state during move operation
- Show error message if move fails
- Close dialog on successful move

**Expected Outcome:** Dialog displays folder tree and allows selecting a destination folder.

---

### Task 4: Implement Move Note API Endpoint (Est: 1.5 hours)

**Objective:** Create backend API to move notes between folders.

#### Subtask 4.1: Create API route file
- Create file: `/app/api/notes/[id]/move/route.ts`
- Implement POST endpoint for moving notes

#### Subtask 4.2: Implement move note logic
- Validate authentication (session required)
- Validate note exists and user is owner
- Parse request body: `{ folderId: string | null }`
- Validate target folder exists (if not null)
- Validate folder belongs to same folio as note
- Update note's `folderId` field
- Return updated note data

#### Subtask 4.3: Add error handling
- Handle unauthorized access (401)
- Handle note not found (404)
- Handle invalid folder ID (400)
- Handle folder ownership mismatch (403)
- Handle database errors (500)
- Log all errors for debugging

#### Subtask 4.4: Add validation
- Ensure folder and note are in same folio
- Check for duplicate note names in destination folder
- If duplicate found, append number to note title: "Note (2)"

**Expected Outcome:** API endpoint successfully moves notes between folders with proper validation.

---

### Task 5: Implement Duplicate Note Functionality (Est: 1.5 hours)

**Objective:** Create frontend and backend logic to duplicate notes.

#### Subtask 5.1: Create/enhance duplicate API endpoint
- File already exists: `/app/api/notes/[id]/clone/route.ts`
- Review existing implementation
- Ensure it creates copy in same folder (not just root)
- Modify to accept optional `folderId` parameter
- Ensure " (Copy)" is appended to title
- Handle duplicate title conflicts with numbers: "Note (Copy 2)"

#### Subtask 5.2: Update duplicate API logic
- Parse request body for optional `targetFolderId`
- If not provided, use source note's `folderId`
- Create new note with same content
- Set title to `${original.title} (Copy)`
- Set `folioId` and `folderId` to match source note
- Return new note ID and title

#### Subtask 5.3: Add frontend duplicate handler
- In FileNavigator or useFolioCrud hook
- Create `duplicateNote` function
- Call `/api/notes/[id]/clone` endpoint
- Pass current folder ID in request
- Refresh notes list after successful duplication
- Show success notification
- Optionally open duplicated note in new tab

#### Subtask 5.4: Handle duplicate errors
- Show error notification if duplication fails
- Handle case where duplicate name exists
- Ensure UI state remains consistent on error

**Expected Outcome:** Users can duplicate notes, which appear in the same folder with " (Copy)" appended.

---

### Task 6: Wire Up Move and Duplicate Dialogs (Est: 1.5 hours)

**Objective:** Connect FileMenu actions to dialogs and API calls.

#### Subtask 6.1: Add dialog state management to FileNavigator
- Extend `useDialogManagement` hook or create new state
- Add `moveFolderDialog` state:
  - `open: boolean`
  - `noteId: string | null`
  - `noteTitle: string`
  - `currentFolderId: string | null`
- Add actions: `openMoveFolderDialog`, `closeMoveFolderDialog`

#### Subtask 6.2: Implement move note handler
- Create `handleMoveNote` function in FileNavigator
- Call `/api/notes/[id]/move` endpoint
- Pass selected `folderId` (or null for root)
- Update local notes state after successful move
- Close MoveFolderDialog
- Show success notification
- Handle errors with user-friendly messages

#### Subtask 6.3: Implement duplicate note handler
- Create `handleDuplicateNote` function in FileNavigator
- Call duplicate API endpoint
- Refresh notes list to show duplicate
- Optionally open duplicated note in editor
- Show success notification with note title

#### Subtask 6.4: Pass handlers to FileMenu
- Wire `onMove` to open MoveFolderDialog with note info
- Wire `onDuplicate` to call duplicate handler directly
- Wire `onDelete` to open DeleteConfirmDialog (already exists)

**Expected Outcome:** All FileMenu actions trigger correct dialogs and API calls.

---

### Task 7: Handle Active Note Deletion (Est: 1 hour)

**Objective:** Gracefully handle deletion of the currently active note.

#### Subtask 7.1: Detect active note deletion
- In delete handler, check if deleted note ID matches `activeNoteId`
- If match found, close the editor/tab for that note

#### Subtask 7.2: Update tab state on deletion
- Use `closeTab` action from folios store
- Remove tab for deleted note
- If it was the only tab, show empty editor state
- If other tabs exist, switch to most recent tab

#### Subtask 7.3: Clear active note state
- Set `activeNoteId` to null if deleted note was active
- Ensure no stale references remain
- Update URL if using note ID in route

#### Subtask 7.4: Test edge cases
- Delete active note when multiple tabs open
- Delete active note when it's the only tab
- Delete inactive note (should not affect editor)
- Delete note then immediately create new one

**Expected Outcome:** Deleting the active note gracefully closes its editor without errors.

---

### Task 8: Add Mobile-Specific Touch Optimizations (Est: 1 hour)

**Objective:** Ensure file menu works perfectly on mobile devices.

#### Subtask 8.1: Optimize menu button visibility
- On desktop: Show menu button on hover only
- On mobile: Always show menu button (using `@media (hover: none)`)
- Ensure 44x44px minimum touch target on mobile
- Add adequate spacing between note text and menu button

#### Subtask 8.2: Optimize dialog touch interactions
- Ensure MoveFolderDialog is easy to use on mobile
- Increase touch target size for folder items (44x44px)
- Add proper spacing between folder items (12px minimum)
- Make dialog scrollable if folder list is long
- Ensure buttons are large enough for touch (44px height minimum)

#### Subtask 8.3: Handle mobile keyboard interactions
- Ensure dialogs don't get obscured by keyboard
- Test on iOS and Android (via Chrome DevTools)
- Add appropriate scroll padding
- Close dialogs smoothly when keyboard appears

#### Subtask 8.4: Test menu on small screens
- Test on 320px width (iPhone SE)
- Test on 375px width (standard phone)
- Test on 768px width (tablet portrait)
- Ensure menus don't overflow viewport
- Verify dropdown positioning is correct

**Expected Outcome:** File menu is fully functional and touch-friendly on all mobile devices.

---

### Task 9: Add Loading and Error States (Est: 1 hour)

**Objective:** Provide clear feedback for all async operations.

#### Subtask 9.1: Add loading indicators
- Show spinner in MoveFolderDialog during move operation
- Show spinner on duplicate menu item during duplication
- Disable menu items during operations to prevent double-clicks
- Show loading overlay on FileNavigator during refresh

#### Subtask 9.2: Add error notifications
- Use toast notifications for error messages
- Provide specific error messages:
  - "Failed to move note: [reason]"
  - "Failed to duplicate note: [reason]"
  - "Failed to delete note: [reason]"
- Include retry option where appropriate
- Log errors to console for debugging

#### Subtask 9.3: Add success notifications
- Show brief toast on successful move: "Note moved to [folder name]"
- Show brief toast on duplicate: "Note duplicated successfully"
- Show brief toast on delete: "Note deleted"
- Auto-dismiss after 3 seconds

#### Subtask 9.4: Handle network errors
- Detect offline state
- Show "You are offline" message
- Queue operations when offline (optional enhancement)
- Retry failed operations when back online (optional)

**Expected Outcome:** Users receive clear feedback for all file operations.

---

### Task 10: Testing and Polish (Est: 1.5 hours)

**Objective:** Test all file menu operations thoroughly and polish UX.

#### Subtask 10.1: Test move functionality
- Move note to different folder
- Move note to root (no folder)
- Move note to nested folder
- Attempt to move note to same folder (should show message)
- Move active note (should remain open in editor)
- Test with deeply nested folder structures

#### Subtask 10.2: Test duplicate functionality
- Duplicate note in root
- Duplicate note in folder
- Duplicate note multiple times (should append numbers)
- Duplicate note with very long title
- Test duplicate with large content (performance)

#### Subtask 10.3: Test delete functionality
- Delete inactive note
- Delete active note
- Delete note with active editor tab
- Delete multiple notes in sequence
- Test delete confirmation dialog UX

#### Subtask 10.4: Test keyboard navigation
- Tab through menu items
- Use arrow keys to navigate menu
- Press Enter to activate menu items
- Press Escape to close menu/dialogs
- Ensure focus returns to trigger after closing

#### Subtask 10.5: Test mobile interactions
- Test on Chrome DevTools mobile emulation
- Test all operations with touch only
- Verify 44x44px touch targets
- Test on various screen sizes (320px - 1024px)
- Test landscape and portrait orientations

#### Subtask 10.6: Polish animations and transitions
- Smooth menu open/close animation
- Smooth dialog open/close animation
- Fade in/out for loading states
- Respect `prefers-reduced-motion`

**Expected Outcome:** All file menu operations work flawlessly across all devices and input methods.

---

## Dev Notes

### Project Context

**CRITICAL:** This story builds upon the mobile-optimized FileNavigator from Story 1.11. The file menu must work seamlessly on both mobile (touch) and desktop (mouse) devices, with proper touch target sizes (44x44px minimum) and responsive behavior.

**Design Pattern:** The three-dot menu follows common file manager patterns (Notion, Google Drive, Dropbox) where each file has a context menu for quick actions. On mobile, the menu icon is always visible; on desktop, it appears on hover.

**Key Challenge:** Maintaining proper event handling so clicking the menu doesn't trigger note selection, while ensuring all interactions feel natural on both touch and pointer devices.

---

### Architecture Overview

**Component Hierarchy:**
```
FileNavigator
├── FolioTree
│   ├── FolderItem
│   └── NoteItem
│       └── FileMenu (NEW)
│           ├── DropdownMenu (shadcn/ui)
│           └── MoveFolderDialog (NEW)
```

**State Management:**
- Dialog state managed in FileNavigator (consistent with existing patterns)
- Menu callbacks passed down through props
- Zustand store updated after successful operations

**API Endpoints:**
- POST `/api/notes/[id]/move` - Move note to different folder (NEW)
- POST `/api/notes/[id]/clone` - Duplicate note (ENHANCE EXISTING)
- DELETE `/api/notes/[id]` - Delete note (EXISTING)

---

### File Structure

**New Files:**
```
components/
├── navigation/
│   ├── FileMenu.tsx                    # NEW: Three-dot menu component
│   └── MoveFolderDialog.tsx            # NEW: Folder selection dialog
app/
├── api/
│   ├── notes/
│   │   └── [id]/
│   │       └── move/
│   │           └── route.ts            # NEW: Move note endpoint
```

**Modified Files:**
```
components/
├── navigation/
│   ├── NoteItem.tsx                    # MODIFIED: Add FileMenu
│   └── FileNavigator.tsx               # MODIFIED: Add dialog state and handlers
lib/
├── hooks/
│   └── useFolioCrud.ts                 # MODIFIED: Add move and duplicate handlers
app/
├── api/
│   └── notes/
│       └── [id]/
│           └── clone/
│               └── route.ts            # MODIFIED: Accept targetFolderId param
```

---

### Complete Implementation Details

#### 1. FileMenu Component

Create `/components/navigation/FileMenu.tsx`:

```typescript
'use client';

import { MoreVertical, FolderInput, Copy, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { cn } from '@/lib/utils';
import { useState } from 'react';

export interface FileMenuProps {
  noteId: string;
  noteTitle: string;
  folderId: string | null;
  onMove: (noteId: string) => void;
  onDuplicate: (noteId: string) => void;
  onDelete: (noteId: string) => void;
  className?: string;
}

export function FileMenu({
  noteId,
  noteTitle,
  folderId,
  onMove,
  onDuplicate,
  onDelete,
  className,
}: FileMenuProps) {
  const [isOpen, setIsOpen] = useState(false);

  const handleMove = (e: React.MouseEvent) => {
    e.stopPropagation(); // Prevent note selection
    setIsOpen(false);
    onMove(noteId);
  };

  const handleDuplicate = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsOpen(false);
    onDuplicate(noteId);
  };

  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsOpen(false);
    onDelete(noteId);
  };

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className={cn(
            'h-8 w-8 shrink-0',
            'opacity-0 group-hover:opacity-100', // Show on hover (desktop)
            'hover:bg-[var(--muted)]/20',
            'focus-visible:opacity-100',
            '@media (hover: none) { opacity-100 }', // Always show on mobile
            'min-h-[44px] min-w-[44px] md:min-h-0 md:min-w-0', // Touch target on mobile
            className
          )}
          onClick={(e) => e.stopPropagation()} // Prevent note selection
          aria-label={`File menu for ${noteTitle}`}
          aria-expanded={isOpen}
        >
          <MoreVertical className="h-4 w-4 text-[var(--muted-foreground)]" />
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent
        align="end"
        className={cn(
          'w-48',
          'bg-[var(--card)] border-[var(--border)]',
          'shadow-lg'
        )}
      >
        <DropdownMenuItem
          onClick={handleMove}
          className="flex items-center gap-2 cursor-pointer"
        >
          <FolderInput className="h-4 w-4" />
          <span>Move to folder</span>
        </DropdownMenuItem>

        <DropdownMenuItem
          onClick={handleDuplicate}
          className="flex items-center gap-2 cursor-pointer"
        >
          <Copy className="h-4 w-4" />
          <span>Duplicate</span>
        </DropdownMenuItem>

        <DropdownMenuItem
          onClick={handleDelete}
          className={cn(
            'flex items-center gap-2 cursor-pointer',
            'text-[var(--destructive)] focus:text-[var(--destructive)]',
            'focus:bg-[var(--destructive-bg)]'
          )}
        >
          <Trash2 className="h-4 w-4" />
          <span>Delete</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

**Key Points:**
- Uses shadcn/ui DropdownMenu for accessibility
- 44x44px touch target on mobile (`min-h-[44px] min-w-[44px]`)
- Always visible on mobile using `@media (hover: none)`
- Stops event propagation to prevent note selection
- Proper ARIA labels for accessibility
- Destructive styling for delete option

---

#### 2. Update NoteItem to Include FileMenu

Modify `/components/navigation/NoteItem.tsx`:

```typescript
// Add to imports
import { FileMenu } from './FileMenu';

// Add to props interface
export interface NoteItemProps {
  // ... existing props
  onMove?: (id: string) => void;
  onDuplicate?: (id: string) => void;
  // onDelete already exists
}

// Add to component
export function NoteItem({
  // ... existing props
  onMove,
  onDuplicate,
  onDelete,
}: NoteItemProps) {
  // ... existing code

  return (
    <div
      role="treeitem"
      aria-label={note.title}
      aria-selected={isActive}
      className={cn(
        'group', // Add group class for hover effects
        'flex items-center gap-[var(--spacing-xs)] py-[var(--spacing-xs)]',
        'cursor-pointer rounded-[var(--radius-sm)]',
        'hover:bg-[var(--muted)]/10 active:bg-[var(--muted)]/20',
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]',
        'min-h-[44px] md:min-h-0',
        isActive && 'bg-[var(--accent)]/10 text-[var(--accent)]'
      )}
      style={indentStyle}
      onClick={handleClick}
      tabIndex={0}
    >
      <div className="w-4" />
      <FileText className="h-4 w-4 shrink-0 text-[var(--muted-foreground)]" />
      <span className="flex-1 break-words text-sm">{note.title}</span>

      {/* File Menu - NEW */}
      {(onMove || onDuplicate || onDelete) && (
        <FileMenu
          noteId={note.id}
          noteTitle={note.title}
          folderId={note.folderId}
          onMove={onMove || (() => {})}
          onDuplicate={onDuplicate || (() => {})}
          onDelete={onDelete || (() => {})}
        />
      )}
    </div>
  );
}
```

**Key Points:**
- Added `group` class to enable group-hover for menu button
- FileMenu only renders if at least one callback is provided
- Menu appears to right of note title
- All callbacks are optional with fallbacks

---

#### 3. MoveFolderDialog Component

Create `/components/navigation/MoveFolderDialog.tsx`:

```typescript
'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Folder as FolderType } from '@/types';
import { Folder, ChevronDown, ChevronRight, Home } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';

export interface MoveFolderDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  noteId: string;
  noteTitle: string;
  currentFolderId: string | null;
  folders: FolderType[];
  activeFolioId: string;
  onConfirm: (noteId: string, targetFolderId: string | null) => Promise<void>;
}

interface FolderTreeItemProps {
  folder: FolderType | null; // null = root
  depth: number;
  isSelected: boolean;
  isCurrent: boolean;
  isExpanded: boolean;
  onToggleExpand: () => void;
  onSelect: () => void;
  children?: React.ReactNode;
}

function FolderTreeItem({
  folder,
  depth,
  isSelected,
  isCurrent,
  isExpanded,
  onToggleExpand,
  onSelect,
  children,
}: FolderTreeItemProps) {
  const indentStyle = {
    paddingLeft: `calc(var(--spacing-md) + ${depth} * var(--spacing-lg))`,
  };

  return (
    <>
      <div
        className={cn(
          'flex items-center gap-2 py-2 px-3',
          'cursor-pointer rounded-[var(--radius-sm)]',
          'hover:bg-[var(--muted)]/10',
          'min-h-[44px]', // Touch target
          isSelected && 'bg-[var(--accent)]/10 text-[var(--accent)]',
          isCurrent && 'opacity-50 cursor-not-allowed'
        )}
        style={indentStyle}
        onClick={isCurrent ? undefined : onSelect}
        role="treeitem"
        aria-selected={isSelected}
        aria-disabled={isCurrent}
      >
        {folder && (
          <button
            onClick={(e) => {
              e.stopPropagation();
              onToggleExpand();
            }}
            className="w-4 h-4 shrink-0"
            aria-label={isExpanded ? 'Collapse folder' : 'Expand folder'}
          >
            {isExpanded ? (
              <ChevronDown className="h-4 w-4" />
            ) : (
              <ChevronRight className="h-4 w-4" />
            )}
          </button>
        )}

        {!folder && <Home className="h-4 w-4 shrink-0 text-[var(--muted-foreground)]" />}
        {folder && <Folder className="h-4 w-4 shrink-0 text-[var(--muted-foreground)]" />}

        <span className="flex-1 text-sm">
          {folder ? folder.name : 'Root (No folder)'}
        </span>

        {isCurrent && (
          <span className="text-xs text-[var(--muted)]">(current)</span>
        )}
      </div>

      {isExpanded && children}
    </>
  );
}

export function MoveFolderDialog({
  open,
  onOpenChange,
  noteId,
  noteTitle,
  currentFolderId,
  folders,
  activeFolioId,
  onConfirm,
}: MoveFolderDialogProps) {
  const [selectedFolderId, setSelectedFolderId] = useState<string | null>(currentFolderId);
  const [expandedFolderIds, setExpandedFolderIds] = useState<Set<string>>(new Set());
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Filter folders for current folio only
  const folioFolders = folders.filter((f) => f.folioId === activeFolioId);

  // Build folder hierarchy
  const buildFolderTree = (parentId: string | null, depth: number): React.ReactNode => {
    const childFolders = folioFolders.filter((f) => f.parentId === parentId);

    return childFolders.map((folder) => {
      const isExpanded = expandedFolderIds.has(folder.id);
      const isSelected = selectedFolderId === folder.id;
      const isCurrent = currentFolderId === folder.id;

      return (
        <FolderTreeItem
          key={folder.id}
          folder={folder}
          depth={depth}
          isSelected={isSelected}
          isCurrent={isCurrent}
          isExpanded={isExpanded}
          onToggleExpand={() => {
            setExpandedFolderIds((prev) => {
              const next = new Set(prev);
              if (next.has(folder.id)) {
                next.delete(folder.id);
              } else {
                next.add(folder.id);
              }
              return next;
            });
          }}
          onSelect={() => setSelectedFolderId(folder.id)}
        >
          {buildFolderTree(folder.id, depth + 1)}
        </FolderTreeItem>
      );
    });
  };

  const handleConfirm = async () => {
    // Prevent moving to current location
    if (selectedFolderId === currentFolderId) {
      setError('Note is already in this location');
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      await onConfirm(noteId, selectedFolderId);
      onOpenChange(false);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Failed to move note';
      setError(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent
        className={cn(
          'sm:max-w-[500px]',
          'bg-[var(--card)] border-[var(--border)]'
        )}
      >
        <DialogHeader>
          <DialogTitle>Move note</DialogTitle>
          <DialogDescription>
            Choose a new location for &quot;{noteTitle}&quot;
          </DialogDescription>
        </DialogHeader>

        <ScrollArea className="max-h-[400px] pr-4">
          <div className="space-y-1" role="tree">
            {/* Root option */}
            <FolderTreeItem
              folder={null}
              depth={0}
              isSelected={selectedFolderId === null}
              isCurrent={currentFolderId === null}
              isExpanded={false}
              onToggleExpand={() => {}}
              onSelect={() => setSelectedFolderId(null)}
            />

            {/* Folder tree */}
            {buildFolderTree(null, 0)}
          </div>
        </ScrollArea>

        {error && (
          <div className="text-sm text-[var(--destructive)] px-1">
            {error}
          </div>
        )}

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancel
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={isLoading || selectedFolderId === currentFolderId}
          >
            {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            Move
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Key Points:**
- Hierarchical folder tree with expand/collapse
- Root (no folder) option at top
- Current folder is disabled/grayed out
- 44px minimum touch targets
- Validation prevents moving to current location
- Loading state during move operation
- Error display for failed operations

---

#### 4. Move Note API Endpoint

Create `/app/api/notes/[id]/move/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { auth } from '@/lib/auth';
import { z, ZodError } from 'zod';

// Validation schema for move request
const moveNoteSchema = z.object({
  folderId: z.string().nullable(),
});

/**
 * POST /api/notes/[id]/move
 * Move a note to a different folder
 */
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id: noteId } = await params;

    // Verify authentication
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Parse and validate request body
    const body = await request.json();
    const { folderId } = moveNoteSchema.parse(body);

    // Fetch note with folio info
    const note = await prisma.note.findUnique({
      where: { id: noteId },
      include: {
        folio: {
          select: {
            id: true,
            ownerId: true,
          },
        },
      },
    });

    if (!note) {
      return NextResponse.json(
        { error: 'Note not found' },
        { status: 404 }
      );
    }

    // Verify user is owner (only owners can move notes)
    if (note.folio.ownerId !== session.user.id) {
      return NextResponse.json(
        { error: 'Access denied' },
        { status: 403 }
      );
    }

    // If moving to a folder, verify folder exists and belongs to same folio
    if (folderId) {
      const targetFolder = await prisma.folder.findUnique({
        where: { id: folderId },
        select: {
          id: true,
          folioId: true,
          name: true,
        },
      });

      if (!targetFolder) {
        return NextResponse.json(
          { error: 'Target folder not found' },
          { status: 404 }
        );
      }

      // Ensure folder belongs to same folio
      if (targetFolder.folioId !== note.folioId) {
        return NextResponse.json(
          { error: 'Cannot move note to folder in different folio' },
          { status: 400 }
        );
      }
    }

    // Check for duplicate note names in destination
    const siblingNotes = await prisma.note.findMany({
      where: {
        folioId: note.folioId,
        folderId: folderId,
        id: { not: noteId }, // Exclude current note
        title: note.title, // Check for same title
      },
    });

    // If duplicate exists, append number to title
    let newTitle = note.title;
    if (siblingNotes.length > 0) {
      let counter = 2;
      while (true) {
        const candidateTitle = `${note.title} (${counter})`;
        const exists = await prisma.note.findFirst({
          where: {
            folioId: note.folioId,
            folderId: folderId,
            title: candidateTitle,
          },
        });
        if (!exists) {
          newTitle = candidateTitle;
          break;
        }
        counter++;
      }
    }

    // Update note's folder and title if changed
    const updatedNote = await prisma.note.update({
      where: { id: noteId },
      data: {
        folderId: folderId,
        title: newTitle,
      },
    });

    return NextResponse.json({
      data: updatedNote,
      message: 'Note moved successfully',
    });
  } catch (error) {
    if (error instanceof ZodError) {
      return NextResponse.json(
        { error: 'Invalid input', details: error.issues },
        { status: 400 }
      );
    }

    console.error('Error moving note:', error);
    return NextResponse.json(
      { error: 'Failed to move note' },
      { status: 500 }
    );
  }
}

export const runtime = 'nodejs';
```

**Key Points:**
- Validates authentication and ownership
- Verifies target folder exists and is in same folio
- Handles duplicate titles by appending numbers
- Returns updated note data
- Proper error handling with specific status codes

---

#### 5. Update Clone/Duplicate API Endpoint

Modify `/app/api/notes/[id]/clone/route.ts`:

```typescript
// Update schema to accept targetFolderId
const cloneRequestSchema = z.object({
  targetFolderId: z.string().nullable().optional(),
});

// In POST handler, after line 23:
const body = await request.json();
const { targetFolderId } = cloneRequestSchema.parse(body);

// Replace lines 80-88 with:
// Determine target folder (use source note's folder if not specified)
const targetFolder = targetFolderId !== undefined ? targetFolderId : note.folderId;

// Handle duplicate title in destination folder
let duplicateTitle = `${note.title} (Copy)`;
let counter = 2;
while (true) {
  const exists = await prisma.note.findFirst({
    where: {
      folioId: userFolio.id,
      folderId: targetFolder,
      title: duplicateTitle,
    },
  });
  if (!exists) break;
  duplicateTitle = `${note.title} (Copy ${counter})`;
  counter++;
}

// Clone the note
const clonedNote = await prisma.note.create({
  data: {
    title: duplicateTitle,
    content: note.content as Parameters<typeof prisma.note.create>[0]['data']['content'],
    folioId: userFolio.id,
    folderId: targetFolder, // Use determined folder
  },
});
```

**Key Points:**
- Accepts optional `targetFolderId` parameter
- Defaults to source note's folder if not specified
- Handles duplicate titles with incrementing numbers
- Creates copy in same folder as original

---

#### 6. Wire Up Handlers in FileNavigator

Modify `/components/navigation/FileNavigator.tsx`:

```typescript
// Add to imports
import { MoveFolderDialog } from './MoveFolderDialog';

// Add dialog state (after line 58)
const [moveFolderDialog, setMoveFolderDialog] = useState<{
  open: boolean;
  noteId: string | null;
  noteTitle: string;
  currentFolderId: string | null;
}>({
  open: false,
  noteId: null,
  noteTitle: '',
  currentFolderId: null,
});

// Add handlers
const handleOpenMoveDialog = (noteId: string) => {
  const note = notes.find((n) => n.id === noteId);
  if (note) {
    setMoveFolderDialog({
      open: true,
      noteId: note.id,
      noteTitle: note.title,
      currentFolderId: note.folderId,
    });
  }
};

const handleMoveNote = async (noteId: string, targetFolderId: string | null) => {
  try {
    const response = await fetch(`/api/notes/${noteId}/move`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ folderId: targetFolderId }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to move note');
    }

    // Refresh data to show updated note location
    await refetchData();

    // Show success notification
    console.log('Note moved successfully');
  } catch (error) {
    console.error('Move note error:', error);
    throw error; // Re-throw for dialog to handle
  }
};

const handleDuplicateNote = async (noteId: string) => {
  try {
    const note = notes.find((n) => n.id === noteId);
    if (!note) return;

    const response = await fetch(`/api/notes/${noteId}/clone`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetFolderId: note.folderId }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to duplicate note');
    }

    const result = await response.json();

    // Refresh data to show duplicated note
    await refetchData();

    // Show success notification
    console.log(`Note duplicated: ${result.data.title}`);
  } catch (error) {
    console.error('Duplicate note error:', error);
    // Show error notification
  }
};

// In FolioTree component, pass new props to NoteItem:
<NoteItem
  // ... existing props
  onMove={handleOpenMoveDialog}
  onDuplicate={handleDuplicateNote}
  onDelete={(id) => openDeleteDialog('note', id, note.title)}
/>

// Add MoveFolderDialog before closing tag:
<MoveFolderDialog
  open={moveFolderDialog.open}
  onOpenChange={(open) =>
    setMoveFolderDialog((prev) => ({ ...prev, open }))
  }
  noteId={moveFolderDialog.noteId || ''}
  noteTitle={moveFolderDialog.noteTitle}
  currentFolderId={moveFolderDialog.currentFolderId}
  folders={folders}
  activeFolioId={activeFolioId || ''}
  onConfirm={handleMoveNote}
/>
```

**Key Points:**
- Move dialog state managed in FileNavigator
- API calls use fetch with proper error handling
- Data refetched after successful operations
- Notifications shown for success/error (implement with toast library)

---

#### 7. Handle Active Note Deletion

Modify delete handler in FileNavigator:

```typescript
const handleDeleteNote = async (noteId: string) => {
  try {
    const response = await fetch(`/api/notes/${noteId}`, {
      method: 'DELETE',
    });

    if (!response.ok) {
      throw new Error('Failed to delete note');
    }

    // If deleted note is currently active, close its tab
    if (activeNoteId === noteId) {
      closeTab(noteId);
      setActiveNote(null);
    }

    // Refresh data
    await refetchData();

    // Show success notification
    console.log('Note deleted successfully');
  } catch (error) {
    console.error('Delete note error:', error);
    // Show error notification
  }
};
```

**Key Points:**
- Checks if deleted note is active
- Closes tab and clears active note if match
- Prevents stale editor state
- Graceful handling without errors

---

### CSS Variables and Styling

All styling uses existing CSS variables from `app/globals.css`. No new variables needed.

**Key Variables Used:**
- `--spacing-xs`, `--spacing-sm`, `--spacing-md`, `--spacing-lg` - Spacing
- `--foreground`, `--background`, `--muted`, `--accent` - Colors
- `--destructive`, `--destructive-bg`, `--destructive-foreground` - Delete styling
- `--border`, `--card` - Dialog and menu borders/backgrounds
- `--radius-sm` - Border radius
- `--touch-target-min` (44px) - Mobile touch targets

**Mobile-Specific Styles:**
```css
/* In globals.css - already exists, just document usage */
@media (hover: none) {
  /* On touch devices, always show menu button */
  .file-menu-button {
    opacity: 1 !important;
  }
}

@media (max-width: 768px) {
  /* Ensure touch targets on mobile */
  .file-menu-button {
    min-height: 44px;
    min-width: 44px;
  }
}
```

---

### Testing Checklist

Before marking this story as complete, verify:

**Move Functionality:**
- [ ] Can move note to different folder
- [ ] Can move note to root (no folder)
- [ ] Can move note to nested folder
- [ ] Cannot move note to same folder (validation prevents)
- [ ] Moving note updates FileNavigator immediately
- [ ] Duplicate titles are handled (number appended)
- [ ] Active note remains open after move

**Duplicate Functionality:**
- [ ] Can duplicate note in same folder
- [ ] Duplicate has "(Copy)" appended to title
- [ ] Multiple duplicates get incremented numbers
- [ ] Duplicated note appears in FileNavigator
- [ ] Duplicate preserves all content
- [ ] Works with large content (performance test)

**Delete Functionality:**
- [ ] Delete confirmation dialog appears
- [ ] Can delete inactive note
- [ ] Deleting active note closes editor
- [ ] Multiple deletes work correctly
- [ ] FileNavigator updates immediately

**Menu Interactions:**
- [ ] Menu button appears on hover (desktop)
- [ ] Menu button always visible (mobile)
- [ ] Clicking menu doesn't select note
- [ ] Menu closes after action
- [ ] Keyboard navigation works (Tab, Arrow, Enter, Escape)

**Mobile Testing:**
- [ ] Menu button meets 44x44px minimum
- [ ] All dialog buttons meet touch target minimums
- [ ] Works on 320px width (iPhone SE)
- [ ] Works on 375px width (standard phone)
- [ ] Works on 768px width (tablet)
- [ ] Works in landscape orientation
- [ ] Dialogs not obscured by keyboard

**Accessibility:**
- [ ] Proper ARIA labels on all interactive elements
- [ ] Keyboard navigation works throughout
- [ ] Focus trap in dialogs
- [ ] Screen reader announcements work
- [ ] Focus returns to trigger after closing

**Error Handling:**
- [ ] Network errors show notification
- [ ] Validation errors show in UI
- [ ] Loading states display correctly
- [ ] Success notifications appear

---

### Standards Compliance from CLAUDE.md

**CRITICAL - Must Follow:**
- [x] NO hardcoded colors (all use CSS variables)
- [x] NO hardcoded spacing (all use CSS variables)
- [x] NO `any` types (all properly typed)
- [x] All components under 250 lines
- [x] Touch targets minimum 44x44px on mobile
- [x] Accessibility (ARIA labels, keyboard support)
- [x] All imports use `@/` alias
- [x] Use `cn()` utility for conditional classes
- [x] API routes have proper error handling
- [x] Authentication verified on all API endpoints
- [x] User ownership checked before mutations

**File Length Standards:**
- FileMenu.tsx: ~120 lines (well under 250)
- MoveFolderDialog.tsx: ~200 lines (well under 250)
- API route: ~150 lines (well under 200)

---

### Performance Considerations

**Frontend:**
- Menu renders only when needed (conditional rendering)
- Dialog content not rendered until opened
- Folder tree uses recursive rendering (efficient for typical depths)
- Loading states prevent double-submissions

**Backend:**
- Single database query for note ownership validation
- Efficient folder hierarchy queries
- Duplicate title checking optimized
- Proper indexes on `folioId`, `folderId`, `title` fields

**Network:**
- Move operation: Single API call
- Duplicate operation: Single API call
- Refetch after operations is debounced
- No unnecessary data transferred

---

### Security Considerations

**Authentication:**
- All API endpoints verify session
- User ID extracted from session, not request body

**Authorization:**
- Only note owners can move notes
- Only note owners can duplicate notes
- Folder ownership verified before move
- Cannot move notes between different folios

**Validation:**
- Input validated with Zod schemas
- Folder existence checked
- Folio ownership verified
- Duplicate titles handled safely

**Data Integrity:**
- Database constraints prevent orphaned records
- Transactions used where needed
- Cascading deletes configured in schema

---

### Common Pitfalls to Avoid

**❌ DON'T:**
- Use hardcoded colors or spacing values
- Let menu button trigger note selection
- Allow moving notes between different folios
- Skip touch target sizing on mobile
- Forget to close tabs when deleting active note
- Allow duplicate operations before previous completes

**✅ DO:**
- Use CSS variables for all styling
- Stop event propagation on menu interactions
- Validate folder and note are in same folio
- Ensure 44x44px touch targets on mobile
- Handle active note deletion gracefully
- Show loading states during async operations

---

### Future Enhancement Ideas

These are NOT part of this story, but could be considered later:
- Batch operations (move/delete multiple notes)
- Drag-and-drop to move notes
- Keyboard shortcuts (Cmd+D to duplicate, etc.)
- Undo move/delete operations
- Copy note link to clipboard
- Show note metadata in menu (created date, size, etc.)
- Export note as PDF/Markdown
- Pin/favorite notes

---

### Success Criteria

This story is complete when:
1. Three-dot menu appears on all notes
2. Menu provides Move, Duplicate, and Delete options
3. Move functionality works with folder tree dialog
4. Duplicate creates copy with "(Copy)" appended
5. Delete shows confirmation and removes note
6. All operations work on mobile and desktop
7. Touch targets meet 44x44px minimum
8. Active note deletion handled gracefully
9. All API endpoints secured with auth and ownership checks
10. Code follows all CLAUDE.md standards

---

## Dev Agent Record

_(To be filled by Developer Agent during implementation)_

### Files Created:
- [ ] `/components/navigation/FileMenu.tsx`
- [ ] `/components/navigation/MoveFolderDialog.tsx`
- [ ] `/app/api/notes/[id]/move/route.ts`

### Files Modified:
- [ ] `/components/navigation/NoteItem.tsx`
- [ ] `/components/navigation/FileNavigator.tsx`
- [ ] `/app/api/notes/[id]/clone/route.ts`

### Implementation Notes:
_(Developer will document any deviations from plan, challenges encountered, or improvements made)_

---

## QA Results

_(To be filled by QA Agent during review)_
