# Story 1.15: Image Resize Options

**Status:** Draft

## User Story

As a user, I want to resize images in my notes to small, medium, or full size using a three-dot menu at the top right of each image, so that I can control the visual layout and emphasis of images in my content.

## Description

This story adds image resize functionality to the Tiptap editor, allowing users to control image display size through an intuitive contextual menu. When a user hovers over (or taps on mobile) an image in the editor, a three-dot menu appears in the top-right corner. Clicking the menu reveals three size options: Small (33% width), Medium (66% width), and Full (100% width). This follows familiar patterns from tools like Notion, Google Docs, and Craft, providing users with precise control over image presentation without complex resize handles.

## Acceptance Criteria

- [ ] Images in the editor display a three-dot menu button in the top-right corner on hover (desktop) or always visible (mobile)
- [ ] Clicking the three-dot button opens a dropdown menu with three size options: "Small", "Medium", and "Full"
- [ ] Selecting "Small" resizes the image to 33% of editor width (max-width: 300px)
- [ ] Selecting "Medium" resizes the image to 66% of editor width (max-width: 600px)
- [ ] Selecting "Full" resizes the image to 100% of editor width (max-width: 100%)
- [ ] Selected size is visually indicated in the menu (checkmark or highlight)
- [ ] Image size persists when saving and reloading the note
- [ ] Size changes work smoothly without page flicker or layout jump
- [ ] Menu button meets 44x44px touch target minimum on mobile
- [ ] All interactions work on both mobile (touch) and desktop (mouse)
- [ ] Images maintain aspect ratio when resized
- [ ] Menu closes automatically after selecting a size

## Tasks / Subtasks

### Task 1: Extend Tiptap Image Extension for Size Attribute (Est: 2 hours)

**Objective:** Customize the Tiptap Image extension to support a `data-size` attribute for controlling display width.

#### Subtask 1.1: Create custom Image extension
- Create file: `/lib/editor/custom-image.ts`
- Extend Tiptap's base Image extension from `@tiptap/extension-image`
- Add custom attribute `dataSize` to schema with allowed values: `'small' | 'medium' | 'full'`
- Map `dataSize` attribute to HTML `data-size` attribute for persistence
- Configure default size as `'full'` for new images
- Parse existing images without `data-size` as `'full'`

#### Subtask 1.2: Implement size to width mapping
- Define size constants:
  - Small: `max-width: 300px` (33% of typical editor)
  - Medium: `max-width: 600px` (66% of typical editor)
  - Full: `max-width: 100%` (100% width, responsive)
- Add `renderHTML` method to apply size class based on `data-size`
- Ensure images maintain aspect ratio with `height: auto`

#### Subtask 1.3: Add setImageSize command
- Create editor command: `setImageSize(size: 'small' | 'medium' | 'full')`
- Command updates `dataSize` attribute of selected image node
- Command validates image node is currently selected
- Command returns boolean success/failure
- Add TypeScript type extension for editor commands

**Expected Outcome:** Tiptap editor can store and render image size attribute, with a command to update it.

---

### Task 2: Create ImageSizeMenu Component (Est: 2 hours)

**Objective:** Build a floating three-dot menu that appears on image hover/focus.

#### Subtask 2.1: Create ImageSizeMenu component file
- Create file: `/components/editor/ImageSizeMenu.tsx`
- Define `ImageSizeMenuProps` interface:
  - `isVisible: boolean`
  - `imageElement: HTMLImageElement | null`
  - `currentSize: 'small' | 'medium' | 'full'`
  - `onSizeChange: (size: 'small' | 'medium' | 'full') => void`
  - `position: { top: number; right: number }`

#### Subtask 2.2: Implement menu trigger button
- Render three-dot button (MoreVertical icon from lucide-react)
- Position: `absolute` top-right corner of image (8px padding)
- Size: 32x32px on desktop, 44x44px on mobile (meets touch target)
- Background: Semi-transparent with backdrop blur for visibility over images
- Hover state: Slightly darker background
- Show on image hover (desktop) or always visible (mobile via `@media (hover: none)`)
- Z-index: High enough to appear above image but below dialogs

#### Subtask 2.3: Implement dropdown menu
- Use shadcn/ui `DropdownMenu` component for accessibility
- Menu items:
  - "Small" - with checkmark if current size
  - "Medium" - with checkmark if current size
  - "Full" - with checkmark if current size
- Each item calls `onSizeChange` with corresponding size
- Menu closes automatically after selection
- Proper ARIA labels: "Image size menu", "Small size", etc.
- Keyboard navigation (Tab, Arrow keys, Enter, Escape)

#### Subtask 2.4: Position menu absolutely relative to image
- Use image element's bounding rect to calculate position
- Top-right corner with small offset (8px from edges)
- Handle edge cases where image is near viewport edge
- Ensure menu doesn't overflow viewport
- Update position on window resize/scroll (debounced)

**Expected Outcome:** A functional three-dot menu component that floats on images and allows size selection.

---

### Task 3: Integrate ImageSizeMenu into Editor (Est: 2.5 hours)

**Objective:** Wire the ImageSizeMenu component into TipTapEditor with proper state management.

#### Subtask 3.1: Add image interaction state to TipTapEditor
- Add state for focused/hovered image:
  - `focusedImage: { element: HTMLImageElement; size: string } | null`
- Track image hover/focus events using ProseMirror event handlers
- Detect when user hovers over or clicks on an image node
- Extract current `data-size` attribute from focused image
- Clear focused image when clicking outside image

#### Subtask 3.2: Add image event listeners
- In `useEffect`, attach event listeners to editor DOM:
  - `mouseover` on image elements → set `focusedImage`
  - `mouseout` on image elements → clear `focusedImage` (with delay)
  - `click` on image elements → set `focusedImage` (mobile)
  - `click` outside image → clear `focusedImage`
- Use event delegation on `.ProseMirror` container for efficiency
- Filter events to only `img` elements with class `.editor-image`
- Handle touch events separately for mobile

#### Subtask 3.3: Implement handleSizeChange callback
- Create function: `handleSizeChange(size: 'small' | 'medium' | 'full')`
- Get current editor selection position for focused image
- Call editor command: `editor.commands.setImageSize(size)`
- Update `focusedImage` state to reflect new size
- Maintain editor focus after size change
- Close menu after size change

#### Subtask 3.4: Render ImageSizeMenu conditionally
- Render `<ImageSizeMenu>` when `focusedImage !== null`
- Pass current size from `focusedImage.size`
- Pass image element for positioning
- Pass `handleSizeChange` callback
- Calculate menu position from image bounding rect
- Portal menu to document body for proper z-index layering

**Expected Outcome:** ImageSizeMenu appears on image hover/click and successfully changes image size.

---

### Task 4: Add CSS Styles for Image Sizes (Est: 1 hour)

**Objective:** Define CSS classes and styles for the three image size options.

#### Subtask 4.1: Add image size classes to globals.css
- Add to `app/globals.css` in TipTap editor section:
```css
/* Image size variants */
.tiptap-editor .ProseMirror img[data-size="small"] {
  max-width: min(300px, 33%);
  width: 100%;
}

.tiptap-editor .ProseMirror img[data-size="medium"] {
  max-width: min(600px, 66%);
  width: 100%;
}

.tiptap-editor .ProseMirror img[data-size="full"] {
  max-width: 100%;
  width: 100%;
}
```
- Ensure all images maintain aspect ratio with `height: auto`
- Default to full size if no `data-size` attribute present
- Use CSS variables for responsive breakpoints if needed

#### Subtask 4.2: Add image container styles for menu positioning
- Wrap images in relative-positioned container via `NodeView` (if needed)
- OR use `position: relative` on image itself
- Ensure menu button is absolutely positioned within image bounds
- Add subtle hover effect on image to indicate interactivity
- Ensure images remain clickable for other editor functions

#### Subtask 4.3: Style menu button and dropdown
- Menu button styles:
  - Background: `rgba(0, 0, 0, 0.6)` with `backdrop-blur-sm`
  - Hover: `rgba(0, 0, 0, 0.75)`
  - Border radius: `var(--radius-sm)`
  - Icon color: white for visibility on any image
  - Transition: smooth opacity fade on hover
- Dropdown styles:
  - Background: `var(--card)`
  - Border: `var(--border)`
  - Shadow: `var(--shadow-lg)` for elevation
  - Checkmark: `var(--accent)` color

#### Subtask 4.4: Add mobile-specific styles
- Menu button always visible on mobile: `@media (hover: none)`
- Increase touch target to 44x44px on mobile
- Adjust positioning for smaller viewports
- Ensure dropdown doesn't overflow on narrow screens
- Test on 320px width (iPhone SE)

**Expected Outcome:** Images resize correctly with proper visual styling and responsive behavior.

---

### Task 5: Update Image Upload to Set Default Size (Est: 0.5 hours)

**Objective:** Ensure newly uploaded images have the `data-size="full"` attribute by default.

#### Subtask 5.1: Modify image-commands.ts
- Update `/lib/editor/image-commands.ts` line 60
- Change `editor.chain().focus().setImage({ src: data.url }).run()`
- To: `editor.chain().focus().setImage({ src: data.url, dataSize: 'full' }).run()`
- Ensure custom Image extension is imported in TipTapEditor
- Test that new images have `data-size="full"` attribute in HTML

#### Subtask 5.2: Handle legacy images without size attribute
- In custom Image extension, add `parseHTML` method
- If `data-size` attribute missing, default to `'full'`
- Ensures backward compatibility with existing images
- Document behavior in code comments

**Expected Outcome:** All newly uploaded images default to full size, and legacy images are handled gracefully.

---

### Task 6: Replace Built-in Image Extension with Custom Extension (Est: 1 hour)

**Objective:** Swap out Tiptap's default Image extension with our custom one in the editor configuration.

#### Subtask 6.1: Update TipTapEditor.tsx imports
- Remove: `import { Image } from '@tiptap/extension-image';`
- Add: `import { CustomImage } from '@/lib/editor/custom-image';`

#### Subtask 6.2: Update editor extensions array
- Replace `Image.configure({ ... })` (line 96)
- With `CustomImage.configure({ inline: true, allowBase64: false })`
- Ensure all existing Image configuration options are supported
- Remove or preserve `HTMLAttributes.class` as needed

#### Subtask 6.3: Test backward compatibility
- Open existing notes with images
- Verify images display correctly without errors
- Check that images without `data-size` default to full width
- Ensure image upload still works via slash command

#### Subtask 6.4: Add TypeScript type extensions
- Extend editor command types to include `setImageSize`
- Add types for image node attributes (`dataSize`)
- Update `TipTapEditor` type definitions if needed
- Ensure no TypeScript errors in editor usage

**Expected Outcome:** Custom Image extension is active in editor with no breaking changes to existing functionality.

---

### Task 7: Add Keyboard Shortcuts for Image Sizing (Est: 1 hour)

**Objective:** Provide keyboard shortcuts for power users to quickly resize images.

#### Subtask 7.1: Add keyboard extension to editor
- Create `/lib/editor/image-keyboard-shortcuts.ts`
- Use Tiptap's `Extension.create()` to define keyboard shortcuts
- Shortcuts:
  - `Cmd/Ctrl + Shift + 1` → Small size
  - `Cmd/Ctrl + Shift + 2` → Medium size
  - `Cmd/Ctrl + Shift + 3` → Full size
- Only active when image node is selected

#### Subtask 7.2: Implement shortcut handlers
- Each shortcut calls `editor.commands.setImageSize(size)`
- Check if current selection is an image node
- If not image, shortcuts do nothing (no-op)
- Show visual feedback (brief highlight or toast) on size change

#### Subtask 7.3: Document shortcuts in UI
- Add tooltip to menu button: "Resize image (⌘⇧1/2/3)"
- Consider adding keyboard shortcut hints to menu items
- Update any user documentation or help text

#### Subtask 7.4: Test cross-platform shortcuts
- Test on macOS (Cmd key)
- Test on Windows/Linux (Ctrl key)
- Ensure no conflicts with existing editor shortcuts
- Verify shortcuts work when image is selected

**Expected Outcome:** Users can resize images using keyboard shortcuts when an image is selected.

---

### Task 8: Handle Edge Cases and Error States (Est: 1.5 hours)

**Objective:** Ensure robust behavior in unusual scenarios.

#### Subtask 8.1: Handle rapid size changes
- Debounce size change commands (100ms)
- Prevent menu flickering on rapid hover in/out
- Ensure only one size change command executes at a time
- Test clicking multiple sizes quickly

#### Subtask 8.2: Handle image deletion while menu is open
- If focused image is deleted, clear `focusedImage` state
- Close menu immediately
- Ensure no stale references to deleted DOM elements
- Test: Open menu, then delete image via keyboard (Backspace)

#### Subtask 8.3: Handle editor content updates
- If note content is replaced (switching notes), clear `focusedImage`
- Ensure menu doesn't persist across note switches
- Reattach event listeners after content updates
- Test: Open menu, then switch to different note

#### Subtask 8.4: Handle images in collaborative editing
- Ensure size changes propagate correctly in shared notes
- Handle case where another user changes image size while menu open
- Test with Story 3.2's collaborative sharing (if implemented)
- Graceful handling if conflicts occur

#### Subtask 8.5: Handle small viewport sizes
- On narrow screens (< 400px), adjust size percentages
- Ensure dropdown menu doesn't overflow on mobile
- Test all three sizes on iPhone SE (320px width)
- Consider disabling "small" size on very narrow screens (optional)

**Expected Outcome:** Image resize feature works reliably in all edge cases without errors or UI glitches.

---

### Task 9: Testing and Accessibility (Est: 2 hours)

**Objective:** Comprehensively test the feature across devices and ensure full accessibility.

#### Subtask 9.1: Test size functionality
- Upload new image, verify default is full size
- Resize image to small, verify max-width: 300px applied
- Resize image to medium, verify max-width: 600px applied
- Resize back to full, verify 100% width
- Save note, reload, verify size persists
- Test with multiple images in same note
- Test with images of different aspect ratios

#### Subtask 9.2: Test menu interactions
- Hover over image on desktop, verify menu appears
- Move mouse away, verify menu disappears (with delay)
- Click on image on mobile, verify menu appears
- Click outside image, verify menu closes
- Click menu button, verify dropdown opens
- Select size, verify menu closes automatically
- Test clicking very quickly (stress test)

#### Subtask 9.3: Test keyboard interactions
- Tab to image, verify menu can be focused
- Press Enter on menu button, verify dropdown opens
- Use arrow keys to navigate menu items
- Press Enter to select size, verify change applies
- Press Escape to close menu without changing size
- Test keyboard shortcuts (Cmd/Ctrl + Shift + 1/2/3)
- Verify focus returns to editor after closing menu

#### Subtask 9.4: Test accessibility with screen reader
- Use VoiceOver (macOS) or NVDA (Windows) to test
- Verify menu button announces: "Image size menu button"
- Verify menu items announce: "Small size, selected" etc.
- Verify size changes are announced: "Image resized to medium"
- Check all interactive elements have proper ARIA labels
- Ensure keyboard-only navigation works completely

#### Subtask 9.5: Test mobile responsiveness
- Test on Chrome DevTools mobile emulation
- Test on 320px width (iPhone SE)
- Test on 375px width (iPhone 13)
- Test on 768px width (iPad portrait)
- Test on 1024px width (iPad landscape)
- Verify touch targets are 44x44px minimum
- Test landscape and portrait orientations

#### Subtask 9.6: Test with real images
- Upload small image (100x100px)
- Upload large image (3000x2000px)
- Upload wide image (2000x500px)
- Upload tall image (500x2000px)
- Verify all maintain aspect ratio at all sizes
- Ensure no image distortion or stretching

**Expected Outcome:** Feature works flawlessly on all devices and input methods with full accessibility support.

---

### Task 10: Documentation and Polish (Est: 1 hour)

**Objective:** Finalize implementation with documentation and UX polish.

#### Subtask 10.1: Add code documentation
- Document custom Image extension with JSDoc comments
- Document `setImageSize` command parameters and return value
- Document ImageSizeMenu component props and behavior
- Add inline comments explaining complex logic (positioning, event handling)

#### Subtask 10.2: Add animation and transitions
- Smooth fade-in for menu button on hover (0.2s)
- Smooth width transition on image resize (0.3s ease-out)
- Dropdown menu fade-in animation (0.15s)
- Respect `prefers-reduced-motion` media query

#### Subtask 10.3: Add visual feedback
- Highlight image border when menu is open
- Show subtle loading state during size change (if needed)
- Add checkmark icon to currently selected size in menu
- Ensure menu styling is consistent with rest of editor

#### Subtask 10.4: Performance optimization
- Lazy load ImageSizeMenu component (React.lazy)
- Debounce scroll/resize event listeners
- Use `IntersectionObserver` for visibility detection (optional)
- Minimize re-renders on hover state changes

**Expected Outcome:** Polished, well-documented feature with smooth animations and optimal performance.

---

## Dev Notes

### Project Context

**EdFolio** is a note-taking application built with Next.js and Tiptap editor. This story adds image resize functionality following patterns established in Stories 1.11 (mobile UI optimization) and 1.12 (file menu operations). The implementation must work seamlessly on mobile (touch) and desktop (mouse) devices, with 44x44px minimum touch targets and proper accessibility.

**Key Design Principle:** The three-dot menu pattern is already established in the codebase (see FileMenu in Story 1.12). We're applying the same pattern to images within the editor content, providing a consistent UX across the application.

---

### Architecture Overview

**Component Hierarchy:**
```
TipTapEditor (EditorView)
├── CustomImage (Tiptap Extension)
│   └── Image nodes with data-size attribute
├── ImageSizeMenu (new component)
│   └── DropdownMenu (shadcn/ui)
└── Event handlers for image hover/focus
```

**State Management:**
- Image size state is stored directly in Tiptap document JSON as `dataSize` attribute
- No Zustand store needed (editor is source of truth)
- Focused image tracked in local component state
- Menu visibility controlled by hover/click events

**Data Flow:**
1. User hovers/clicks image → Event listener fires
2. TipTapEditor sets `focusedImage` state with current size
3. ImageSizeMenu renders with current size highlighted
4. User selects new size → `onSizeChange` callback fires
5. Editor executes `setImageSize` command
6. Tiptap updates node attribute → triggers re-render
7. CSS class changes → image resizes visually

---

### File Structure

**New Files:**
```
lib/
├── editor/
│   ├── custom-image.ts              # NEW: Extended Tiptap Image extension
│   └── image-keyboard-shortcuts.ts  # NEW: Keyboard shortcuts for sizing
components/
├── editor/
│   └── ImageSizeMenu.tsx            # NEW: Floating menu component
```

**Modified Files:**
```
components/
├── editor/
│   └── TipTapEditor.tsx             # MODIFIED: Add ImageSizeMenu integration
lib/
├── editor/
│   └── image-commands.ts            # MODIFIED: Set default size on upload
app/
├── globals.css                      # MODIFIED: Add image size CSS classes
```

---

### Technical Implementation Details

#### 1. Custom Image Extension (`/lib/editor/custom-image.ts`)

The custom Image extension extends Tiptap's built-in Image to add size attribute support:

```typescript
import Image from '@tiptap/extension-image';
import { mergeAttributes } from '@tiptap/core';

export interface CustomImageOptions {
  inline: boolean;
  allowBase64: boolean;
  HTMLAttributes: Record<string, unknown>;
}

declare module '@tiptap/core' {
  interface Commands<ReturnType> {
    customImage: {
      setImageSize: (size: 'small' | 'medium' | 'full') => ReturnType;
    };
  }
}

export const CustomImage = Image.extend<CustomImageOptions>({
  name: 'customImage',

  addAttributes() {
    return {
      ...this.parent?.(),
      dataSize: {
        default: 'full',
        parseHTML: (element) => element.getAttribute('data-size') || 'full',
        renderHTML: (attributes) => {
          if (!attributes.dataSize) {
            return {};
          }
          return {
            'data-size': attributes.dataSize,
          };
        },
      },
    };
  },

  addCommands() {
    return {
      ...this.parent?.(),
      setImageSize:
        (size: 'small' | 'medium' | 'full') =>
        ({ commands, state }) => {
          const { selection } = state;
          const { $from } = selection;
          const node = $from.node();

          // Check if current node is an image
          if (node.type.name !== 'customImage' && node.type.name !== 'image') {
            // Try to find parent image node
            const pos = selection.$from.pos;
            const resolvedPos = state.doc.resolve(pos);
            let imageNode = null;
            let imagePos = null;

            // Search for image node at current position or nearby
            state.doc.nodesBetween(pos - 1, pos + 1, (node, pos) => {
              if (node.type.name === 'customImage' || node.type.name === 'image') {
                imageNode = node;
                imagePos = pos;
                return false; // Stop iteration
              }
            });

            if (!imageNode || imagePos === null) {
              return false; // Not an image
            }

            // Update the found image node
            return commands.updateAttributes('customImage', { dataSize: size });
          }

          // Update current image node
          return commands.updateAttributes('customImage', { dataSize: size });
        },
    };
  },

  parseHTML() {
    return [
      {
        tag: 'img[src]',
        getAttrs: (element) => {
          if (typeof element === 'string') return false;
          const img = element as HTMLElement;
          return {
            src: img.getAttribute('src'),
            alt: img.getAttribute('alt'),
            title: img.getAttribute('title'),
            dataSize: img.getAttribute('data-size') || 'full',
          };
        },
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return [
      'img',
      mergeAttributes(this.options.HTMLAttributes, HTMLAttributes, {
        class: 'editor-image',
      }),
    ];
  },
});
```

**Key Points:**
- Extends base Image extension (preserves all existing functionality)
- Adds `dataSize` attribute with `'small' | 'medium' | 'full'` values
- `parseHTML` ensures legacy images without `data-size` default to `'full'`
- `renderHTML` applies `data-size` attribute to HTML for CSS styling
- `setImageSize` command updates attribute and triggers re-render
- TypeScript declaration module extends Commands interface

---

#### 2. ImageSizeMenu Component (`/components/editor/ImageSizeMenu.tsx`)

```typescript
'use client';

import { MoreVertical, Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { cn } from '@/lib/utils';
import { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';

export type ImageSize = 'small' | 'medium' | 'full';

export interface ImageSizeMenuProps {
  imageElement: HTMLImageElement;
  currentSize: ImageSize;
  onSizeChange: (size: ImageSize) => void;
  onClose: () => void;
}

export function ImageSizeMenu({
  imageElement,
  currentSize,
  onSizeChange,
  onClose,
}: ImageSizeMenuProps) {
  const [position, setPosition] = useState({ top: 0, right: 0 });
  const [isOpen, setIsOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  // Calculate position based on image element
  useEffect(() => {
    if (!imageElement) return;

    const updatePosition = () => {
      const rect = imageElement.getBoundingClientRect();
      setPosition({
        top: rect.top + window.scrollY + 8,
        right: window.innerWidth - rect.right + window.scrollX + 8,
      });
    };

    updatePosition();

    // Update position on scroll/resize
    window.addEventListener('scroll', updatePosition, true);
    window.addEventListener('resize', updatePosition);

    return () => {
      window.removeEventListener('scroll', updatePosition, true);
      window.removeEventListener('resize', updatePosition);
    };
  }, [imageElement]);

  // Close menu on click outside
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        if (!imageElement.contains(e.target as Node)) {
          onClose();
        }
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [imageElement, onClose]);

  const handleSizeChange = (size: ImageSize) => {
    onSizeChange(size);
    setIsOpen(false);
  };

  const menuButton = (
    <div
      ref={menuRef}
      style={{
        position: 'fixed',
        top: `${position.top}px`,
        right: `${position.right}px`,
        zIndex: 100,
      }}
      className="image-size-menu"
    >
      <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
        <DropdownMenuTrigger asChild>
          <Button
            variant="ghost"
            size="icon"
            className={cn(
              'h-8 w-8 shrink-0',
              'bg-black/60 hover:bg-black/75',
              'backdrop-blur-sm',
              'rounded-sm',
              'transition-all duration-200',
              'min-h-[44px] min-w-[44px] md:min-h-8 md:min-w-8', // Touch target on mobile
            )}
            onClick={(e) => {
              e.stopPropagation();
              setIsOpen(!isOpen);
            }}
            aria-label="Image size menu"
            aria-expanded={isOpen}
          >
            <MoreVertical className="h-4 w-4 text-white" />
          </Button>
        </DropdownMenuTrigger>

        <DropdownMenuContent
          align="end"
          className={cn(
            'w-40',
            'bg-card border-border',
            'shadow-lg'
          )}
        >
          <DropdownMenuItem
            onClick={() => handleSizeChange('small')}
            className="flex items-center justify-between cursor-pointer"
          >
            <span>Small</span>
            {currentSize === 'small' && (
              <Check className="h-4 w-4 text-accent" />
            )}
          </DropdownMenuItem>

          <DropdownMenuItem
            onClick={() => handleSizeChange('medium')}
            className="flex items-center justify-between cursor-pointer"
          >
            <span>Medium</span>
            {currentSize === 'medium' && (
              <Check className="h-4 w-4 text-accent" />
            )}
          </DropdownMenuItem>

          <DropdownMenuItem
            onClick={() => handleSizeChange('full')}
            className="flex items-center justify-between cursor-pointer"
          >
            <span>Full</span>
            {currentSize === 'full' && (
              <Check className="h-4 w-4 text-accent" />
            )}
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  );

  // Render menu in portal for proper positioning
  if (typeof window !== 'undefined') {
    return createPortal(menuButton, document.body);
  }

  return null;
}
```

**Key Points:**
- Uses React Portal to render menu in document.body (avoids z-index issues)
- Position calculated from image bounding rect, updates on scroll/resize
- 44x44px touch target on mobile via responsive classes
- Semi-transparent black background with backdrop blur for visibility
- Checkmark indicates currently selected size
- Closes menu on outside click or after selecting size
- Stop propagation prevents triggering editor click handlers

---

#### 3. Integration in TipTapEditor (`/components/editor/TipTapEditor.tsx`)

Add after imports:
```typescript
import { CustomImage } from '@/lib/editor/custom-image';
import { ImageSizeMenu, type ImageSize } from './ImageSizeMenu';
```

Replace `Image` import and usage:
```typescript
// Remove: import { Image } from '@tiptap/extension-image';

// In extensions array (line 96), replace:
// Image.configure({ ... })
// with:
CustomImage.configure({
  inline: true,
  allowBase64: false,
  HTMLAttributes: {
    class: 'editor-image',
  },
}),
```

Add image menu state (after line 58):
```typescript
const [focusedImage, setFocusedImage] = useState<{
  element: HTMLImageElement;
  size: ImageSize;
} | null>(null);
```

Add image size change handler (after line 150):
```typescript
const handleImageSizeChange = useCallback((size: ImageSize) => {
  if (!editor || !focusedImage) return;

  editor.commands.setImageSize(size);

  // Update focused image size for menu
  setFocusedImage((prev) =>
    prev ? { ...prev, size } : null
  );
}, [editor, focusedImage]);
```

Add image event listeners (in useEffect after line 156):
```typescript
useEffect(() => {
  if (!editor) return;

  const editorElement = editor.view.dom;

  const handleImageInteraction = (e: MouseEvent | TouchEvent) => {
    const target = e.target as HTMLElement;

    // Check if clicked/touched element is an image
    if (target.tagName === 'IMG' && target.classList.contains('editor-image')) {
      const img = target as HTMLImageElement;
      const size = (img.getAttribute('data-size') || 'full') as ImageSize;

      setFocusedImage({
        element: img,
        size,
      });
    }
  };

  const handleClickOutside = (e: MouseEvent) => {
    const target = e.target as HTMLElement;

    // If clicking outside image and not on menu, close menu
    if (
      target.tagName !== 'IMG' &&
      !target.closest('.image-size-menu') &&
      focusedImage
    ) {
      setFocusedImage(null);
    }
  };

  // Attach listeners
  editorElement.addEventListener('click', handleImageInteraction);
  editorElement.addEventListener('touchstart', handleImageInteraction);
  document.addEventListener('click', handleClickOutside);

  return () => {
    editorElement.removeEventListener('click', handleImageInteraction);
    editorElement.removeEventListener('touchstart', handleImageInteraction);
    document.removeEventListener('click', handleClickOutside);
  };
}, [editor, focusedImage]);

// Clear focused image when switching notes
useEffect(() => {
  setFocusedImage(null);
}, [content]);
```

Add ImageSizeMenu render (before closing div, around line 173):
```typescript
{focusedImage && (
  <ImageSizeMenu
    imageElement={focusedImage.element}
    currentSize={focusedImage.size}
    onSizeChange={handleImageSizeChange}
    onClose={() => setFocusedImage(null)}
  />
)}
```

**Key Points:**
- `focusedImage` state tracks currently selected image and its size
- Event listeners on editor DOM detect image clicks/touches
- `handleImageSizeChange` calls editor command to update size
- ImageSizeMenu rendered conditionally when image is focused
- Menu cleared when switching notes or clicking outside
- Uses event delegation for performance

---

#### 4. CSS Styles (`/app/globals.css`)

Add to the TipTap Editor section (after line 684):

```css
/* Image Size Variants */
.tiptap-editor .ProseMirror img[data-size="small"] {
  max-width: min(300px, 33%);
  width: 100%;
  height: auto;
  display: block;
  margin: var(--spacing-md) 0;
  border-radius: 0.375rem;
}

.tiptap-editor .ProseMirror img[data-size="medium"] {
  max-width: min(600px, 66%);
  width: 100%;
  height: auto;
  display: block;
  margin: var(--spacing-md) 0;
  border-radius: 0.375rem;
}

.tiptap-editor .ProseMirror img[data-size="full"] {
  max-width: 100%;
  width: 100%;
  height: auto;
  display: block;
  margin: var(--spacing-md) 0;
  border-radius: 0.375rem;
}

/* Default for images without data-size */
.tiptap-editor .ProseMirror img:not([data-size]) {
  max-width: 100%;
  width: 100%;
  height: auto;
  display: block;
  margin: var(--spacing-md) 0;
  border-radius: 0.375rem;
}

/* Image interaction states */
.tiptap-editor .ProseMirror img.ProseMirror-selectednode {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
  cursor: pointer;
}

/* Smooth resize transition */
.tiptap-editor .ProseMirror img {
  transition: max-width 0.3s ease-out, width 0.3s ease-out;
}

/* Respect reduced motion preference */
@media (prefers-reduced-motion: reduce) {
  .tiptap-editor .ProseMirror img {
    transition: none;
  }
}

/* Mobile: smaller max sizes for small/medium */
@media (max-width: 768px) {
  .tiptap-editor .ProseMirror img[data-size="small"] {
    max-width: min(200px, 50%);
  }

  .tiptap-editor .ProseMirror img[data-size="medium"] {
    max-width: min(400px, 80%);
  }
}
```

**Key Points:**
- Three size classes: `data-size="small|medium|full"`
- `min()` function ensures responsive behavior (doesn't exceed percentage or pixel max)
- `height: auto` maintains aspect ratio
- Smooth transition on resize (respects reduced motion)
- Default fallback for images without `data-size` attribute
- Mobile breakpoint adjusts sizes for smaller screens
- Selected image outline preserved (already exists in codebase)

---

#### 5. Update Image Upload Command (`/lib/editor/image-commands.ts`)

Change line 60 from:
```typescript
editor.chain().focus().setImage({ src: data.url }).run();
```

To:
```typescript
editor.chain().focus().setImage({ src: data.url, dataSize: 'full' }).run();
```

**Key Points:**
- Sets default size to 'full' for all newly uploaded images
- Ensures consistency with custom Image extension
- No other changes needed to upload command

---

### Size Specifications

**Small:**
- Desktop: `max-width: min(300px, 33%)`
- Mobile (< 768px): `max-width: min(200px, 50%)`
- Use case: Inline images, icons, small diagrams

**Medium:**
- Desktop: `max-width: min(600px, 66%)`
- Mobile (< 768px): `max-width: min(400px, 80%)`
- Use case: Regular content images, screenshots

**Full:**
- All devices: `max-width: 100%`
- Responsive to editor width
- Use case: Large images, hero images, full-width photos

**Rationale:**
- Uses `min()` for responsive behavior (won't exceed either constraint)
- Percentages ensure images scale with editor width
- Pixel maximums prevent images from becoming too large
- Mobile adjustments account for narrower viewports

---

### Touch Target Requirements (Mobile)

**Menu Button:**
- Desktop: 32x32px (compact)
- Mobile: 44x44px (meets WCAG touch target guidelines)
- Implementation: `min-h-[44px] min-w-[44px] md:min-h-8 md:min-w-8`

**Dropdown Menu Items:**
- Height: 40px minimum (inherits from shadcn/ui DropdownMenuItem)
- Spacing: 2px gap between items
- Touch-friendly padding

**Mobile Detection:**
- Use `@media (hover: none)` to detect touch devices
- Menu button always visible on touch devices
- No hover state on mobile (tap to interact)

---

### Accessibility Requirements

**ARIA Labels:**
- Menu button: `aria-label="Image size menu"`
- Menu button: `aria-expanded={isOpen}`
- Menu items: Implicit labels from text content
- Selected item: Checkmark icon with `aria-hidden="false"`

**Keyboard Navigation:**
- Tab to image → Image gets focus ring
- Tab to menu button → Button gets focus
- Enter/Space → Opens dropdown menu
- Arrow keys → Navigate menu items
- Enter → Selects size option
- Escape → Closes menu
- Focus returns to button after selection

**Screen Reader Support:**
- Menu button announces: "Image size menu button"
- Menu items announce: "Small", "Medium", "Full"
- Selected item announces: "Small, selected" (via checkmark)
- Size change announces: "Image resized to medium" (optional toast)

**Focus Management:**
- Focus trap within open menu
- Focus returns to menu button after closing
- Focus visible on all interactive elements
- Skip to next element with Tab after menu closes

---

### Testing Checklist

**Size Functionality:**
- [ ] New uploaded images default to full size
- [ ] Can resize to small (300px max)
- [ ] Can resize to medium (600px max)
- [ ] Can resize to full (100% width)
- [ ] Size persists after save/reload
- [ ] Multiple images can have different sizes
- [ ] Aspect ratio maintained at all sizes
- [ ] Legacy images without data-size display as full

**Menu Interactions:**
- [ ] Menu appears on image click (mobile)
- [ ] Menu appears on image hover (desktop, if hover implemented)
- [ ] Menu button is 44x44px on mobile
- [ ] Menu button is visible and clickable
- [ ] Clicking button opens dropdown
- [ ] Clicking size option closes menu
- [ ] Clicking outside image closes menu
- [ ] Current size shows checkmark
- [ ] Menu doesn't overflow viewport

**Keyboard Interactions:**
- [ ] Tab to image works
- [ ] Tab to menu button works
- [ ] Enter/Space opens menu
- [ ] Arrow keys navigate menu items
- [ ] Enter selects size
- [ ] Escape closes menu
- [ ] Focus returns to button after close
- [ ] Keyboard shortcuts work (Cmd/Ctrl + Shift + 1/2/3)

**Accessibility:**
- [ ] All elements have ARIA labels
- [ ] Screen reader announces menu correctly
- [ ] Screen reader announces size changes
- [ ] Keyboard-only navigation works
- [ ] Focus visible on all elements
- [ ] No keyboard traps

**Mobile Testing:**
- [ ] Works on 320px width (iPhone SE)
- [ ] Works on 375px width (iPhone 13)
- [ ] Works on 768px width (iPad)
- [ ] Touch targets meet 44x44px minimum
- [ ] Menu doesn't overflow on narrow screens
- [ ] Sizes adjust for mobile viewports
- [ ] Tap interactions work smoothly

**Edge Cases:**
- [ ] Rapid size changes handled
- [ ] Image deletion while menu open handled
- [ ] Switching notes closes menu
- [ ] Small images (100x100px) resize correctly
- [ ] Large images (3000x2000px) resize correctly
- [ ] Wide images maintain aspect ratio
- [ ] Tall images maintain aspect ratio

---

### Performance Considerations

**Frontend:**
- ImageSizeMenu lazy loaded (React.lazy) - renders only when needed
- Event listeners use event delegation (attached to editor container)
- Position updates debounced on scroll/resize (100ms)
- Menu re-renders minimized (React.memo if needed)
- Portal rendering prevents z-index conflicts

**CSS:**
- Resize transition smoothly animated (0.3s ease-out)
- Reduced motion respected (`@media (prefers-reduced-motion)`)
- GPU-accelerated properties (transform, opacity) used where possible
- No layout thrashing (batch DOM reads/writes)

**Editor:**
- Custom Image extension extends base (minimal overhead)
- `setImageSize` command is O(1) operation
- No unnecessary document traversals
- Size stored as simple string attribute

**Memory:**
- Event listeners cleaned up in useEffect return
- Image references don't persist after unmount
- Portal properly unmounted when menu closes
- No memory leaks from event handlers

---

### Security Considerations

**Image Sources:**
- No changes to image upload security (already handled)
- `data-size` attribute is safe (no user input, controlled enum)
- No XSS risk from size attribute (not rendered as HTML)

**Data Validation:**
- `setImageSize` only accepts `'small' | 'medium' | 'full'`
- Invalid sizes ignored (type safety via TypeScript)
- parseHTML validates data-size attribute, defaults to 'full' if invalid

**Content Security:**
- No inline styles injected (CSS classes only)
- No eval or dynamic code execution
- Image URLs still validated by existing upload endpoint
- Size changes don't bypass authentication

---

### Backward Compatibility

**Existing Images:**
- Images without `data-size` attribute display as full width
- parseHTML in custom Image extension provides default
- No breaking changes to existing notes
- Users can resize legacy images without issues

**Existing Image Extension:**
- CustomImage extends base Image extension
- All existing Image config options still work
- `inline`, `allowBase64`, `HTMLAttributes` preserved
- Slash command upload still functional

**API Compatibility:**
- No changes to upload endpoint
- No changes to note storage format
- Tiptap JSON includes new `dataSize` attribute (optional)
- Notes with sized images load correctly on older clients (default to full)

---

### Common Pitfalls to Avoid

**DON'T:**
- Use hardcoded pixel values for sizes (use CSS variables and responsive units)
- Attach event listeners to individual images (use event delegation)
- Forget to remove event listeners on unmount (causes memory leaks)
- Allow menu to persist when switching notes
- Skip touch target sizing on mobile
- Forget to handle reduced motion preference
- Use `any` types in TypeScript
- Position menu with fixed pixels (calculate from image rect)

**DO:**
- Use CSS variables for all colors and spacing
- Use responsive sizing with `min()` function
- Clean up event listeners in useEffect return
- Clear focused image state on note switch
- Ensure 44x44px minimum touch targets on mobile
- Respect `prefers-reduced-motion` media query
- Type everything properly with TypeScript
- Use React Portal for menu rendering (z-index layering)

---

### Future Enhancement Ideas

**Not in this story, but could be considered later:**
- Drag handles for manual resize (like Notion)
- Image captions with size-specific styling
- Alignment options (left, center, right) in addition to size
- Image zoom on click (lightbox view)
- Paste image and choose size immediately
- Bulk resize multiple images
- Custom size presets (user-defined percentages)
- Image compression settings in menu
- Image filters/effects

---

### Success Criteria

This story is complete when:
1. Three-dot menu appears on all images in editor
2. Menu provides Small, Medium, and Full size options
3. Selecting a size resizes the image with smooth animation
4. Selected size is visually indicated with checkmark
5. Image size persists after save and reload
6. All interactions work on mobile and desktop
7. Touch targets meet 44x44px minimum on mobile
8. Full keyboard navigation and accessibility
9. Legacy images without size attribute display correctly
10. Code follows all CLAUDE.md standards (no hardcoded values, proper types, under 250 lines per file)

---

## Dev Agent Record

*This section will be populated by the Developer agent during implementation.*

### Implementation Date:
[To be filled]

### All Tasks Completed: [ ]
### All Tests Passing: [ ]
### Files Changed: [To be filled]

### Files Created:
- [ ] `/lib/editor/custom-image.ts`
- [ ] `/lib/editor/image-keyboard-shortcuts.ts`
- [ ] `/components/editor/ImageSizeMenu.tsx`

### Files Modified:
- [ ] `/components/editor/TipTapEditor.tsx`
- [ ] `/lib/editor/image-commands.ts`
- [ ] `/app/globals.css`

### Implementation Notes:
[To be filled by Dev Agent with key decisions, challenges, and solutions]

---

## QA Results

*This section will be populated by the QA agent during validation.*

### Review Date: [To be filled]
### Reviewer: QA Story Validator Agent

#### Acceptance Criteria Validation:
[To be filled]

#### Code Quality Assessment:
[To be filled]

#### Issues Identified:
[To be filled]

#### Final Decision:
[To be filled]
