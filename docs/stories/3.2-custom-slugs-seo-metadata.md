# Story 3.2: Custom Slugs and SEO Metadata

**Status:** Draft

**Epic:** Epic 3 - Web Publishing Feature

**Dependencies:** Story 3.1 (Basic Page Publishing)

## User Story

As a user, I want to customize the public URL of my published pages and add SEO metadata (title, description, social preview), so that my content ranks well in search engines and looks professional when shared on social media.

## Description

This story enhances the basic publishing feature from Story 3.1 by allowing users to customize their public URLs (slugs) and add SEO-optimized metadata. Users can edit the auto-generated slug to create memorable, branded URLs, and provide custom meta titles and descriptions that appear in search results and social media previews.

This builds directly on Story 3.1's publishing infrastructure by:
- Adding custom slug editing with real-time validation
- Implementing meta title and description fields
- Generating Open Graph meta tags for social sharing
- Handling slug conflicts gracefully
- Providing a preview of how the page will appear in social media shares

**Key Functionality:**
- Editable slug field with validation
- Slug conflict detection and resolution
- Meta title customization (with character count guidance)
- Meta description customization (with character count guidance)
- Open Graph meta tags for Facebook, Twitter, LinkedIn
- Social media preview in publish settings
- Slug uniqueness enforcement
- Reserved slug blocking

## Acceptance Criteria

- [ ] User can edit custom slug in publish settings modal
- [ ] System validates slug format (lowercase, alphanumeric, hyphens only)
- [ ] System prevents duplicate slugs across all published pages
- [ ] Conflicting slugs automatically append numeric suffix suggestion
- [ ] Reserved slugs (api, auth, etc.) are blocked with clear error message
- [ ] User can add custom meta title (max 60 chars recommended, with counter)
- [ ] User can add meta description (max 160 chars recommended, with counter)
- [ ] Published page includes Open Graph meta tags in HTML head
- [ ] Social media previews show correct title, description, and default image
- [ ] Preview of social share appearance shown in publish settings
- [ ] Slug validation is real-time (updates as user types)
- [ ] Existing slugs can be edited (with uniqueness check)
- [ ] SEO metadata fields are optional (fallback to defaults if empty)

## Tasks / Subtasks

### Task 1: Update Publish Settings UI (3.5 hours)
**Estimated Time:** 3.5 hours

- [ ] Create `/components/publish/PublishSettingsModal.tsx` component
- [ ] Define PublishSettingsModalProps interface:
  - `isOpen: boolean`
  - `noteId: string`
  - `noteTitle: string`
  - `currentSlug: string | null`
  - `currentMetaTitle: string | null`
  - `currentMetaDescription: string | null`
  - `isPublished: boolean`
  - `onSave: (settings: PublishSettings) => void`
  - `onClose: () => void`
- [ ] Use shadcn/ui Dialog component for modal
- [ ] Create form layout with sections:
  - **URL Settings Section:**
    - Label: "Public URL"
    - Slug input field with prefix display: `edfolio.app/public/`
    - Real-time validation indicator (checkmark or error icon)
    - Error message display below input
    - Character limit: 100 characters
  - **SEO Metadata Section:**
    - Meta Title input (optional)
    - Character counter: "0/60" (optimal length guidance)
    - Meta Description textarea (optional, 3 rows)
    - Character counter: "0/160" (optimal length guidance)
    - Help text: "This appears in search results and social media previews"
  - **Preview Section:**
    - Visual preview of social media card
    - Shows meta title (or note title fallback)
    - Shows meta description (or auto-excerpt fallback)
    - Shows default OG image placeholder
- [ ] Implement form state management:
  - Use React useState for all fields
  - Initialize with current values from props
  - Track dirty state (unsaved changes)
- [ ] Add form actions:
  - "Save" button (primary, disabled if invalid or not dirty)
  - "Cancel" button (secondary)
  - Show loading spinner during save
- [ ] Use CSS variables for all styling
- [ ] Keep component under 250 lines

### Task 2: Implement Real-Time Slug Validation (2.5 hours)
**Estimated Time:** 2.5 hours

- [ ] Create `/lib/slug-validation.ts` utility file
- [ ] Implement `validateSlugFormat(slug: string): ValidationResult` function:
  - Check length (3-100 characters)
  - Check format (lowercase, alphanumeric, hyphens only)
  - Check for consecutive hyphens
  - Check for leading/trailing hyphens
  - Return: `{ isValid: boolean, error: string | null }`
- [ ] Implement `checkSlugAvailability(slug: string, noteId: string): Promise<AvailabilityResult>` function:
  - Query database for existing PublishedPage with slug
  - If not found → available
  - If found and noteId matches → available (own slug)
  - If found and noteId differs → unavailable
  - Return: `{ available: boolean, suggestion: string | null }`
  - If unavailable, generate suggestion with numeric suffix
- [ ] Add debounced validation in PublishSettingsModal:
  - Use `useDebouncedCallback` from `use-debounce` package (or custom hook)
  - Debounce: 300ms
  - Call validation API on slug change
  - Update validation state (loading → success/error)
  - Display validation result to user
- [ ] Create validation API endpoint: `/app/api/publish/validate-slug/route.ts`
  - POST endpoint
  - Accept: `{ slug: string, noteId: string }`
  - Validate format (call validateSlugFormat)
  - Check reserved slugs
  - Check availability (call checkSlugAvailability)
  - Return: `{ valid: boolean, error?: string, suggestion?: string }`
- [ ] Add visual indicators:
  - Loading: small spinner next to input
  - Valid: green checkmark icon
  - Invalid: red X icon with error message
  - Suggestion: info icon with suggested alternative
- [ ] Keep utility file under 150 lines
- [ ] Add JSDoc comments for all functions

### Task 3: Update Publish API to Accept SEO Metadata (2 hours)
**Estimated Time:** 2 hours

- [ ] Open `/app/api/notes/[noteId]/publish/route.ts`
- [ ] Update POST handler to accept request body:
  - Parse JSON body: `{ customSlug?: string, metaTitle?: string, metaDescription?: string }`
  - Validate customSlug if provided (format, reserved, uniqueness)
  - If customSlug provided, use it; otherwise generate from title
  - Sanitize metaTitle and metaDescription (trim, max lengths)
  - Set `customSlug = true` if user provided custom slug
- [ ] Update PublishedPage creation/update:
  - Include metaTitle, metaDescription, customSlug fields
  - Store all SEO metadata
- [ ] Update response to include saved metadata:
  ```typescript
  {
    data: {
      slug: string,
      publicUrl: string,
      metaTitle: string | null,
      metaDescription: string | null,
    }
  }
  ```
- [ ] Add validation errors:
  - 400 Bad Request if slug format invalid
  - 400 Bad Request if slug reserved
  - 409 Conflict if slug already taken
- [ ] Keep file under 200 lines

### Task 4: Create Update Metadata API Endpoint (1.5 hours)
**Estimated Time:** 1.5 hours

- [ ] Create `/app/api/notes/[noteId]/publish/metadata/route.ts`
- [ ] Implement PATCH handler for updating published page metadata:
  - Validate authentication
  - Verify note ownership
  - Verify page is published (404 if not)
  - Parse body: `{ customSlug?: string, metaTitle?: string, metaDescription?: string }`
  - Validate customSlug (if changing slug)
  - Update PublishedPage record with new metadata
  - Return updated metadata
- [ ] Add error handling:
  - 401, 403, 404 as appropriate
  - 400 for invalid slug format
  - 409 for slug conflicts
  - 500 for database errors
- [ ] Keep file under 150 lines
- [ ] Use try-catch for all operations

### Task 5: Implement Open Graph Meta Tags (2 hours)
**Estimated Time:** 2 hours

- [ ] Create `/components/public-page/PublicPageMeta.tsx` component
- [ ] Define PublicPageMetaProps interface:
  - `title: string`
  - `description: string`
  - `url: string` (canonical URL)
  - `ogImage?: string` (optional, default fallback)
  - `publishedAt: Date`
- [ ] Implement meta tags structure:
  ```typescript
  // Basic meta tags
  <title>{title}</title>
  <meta name="description" content={description} />
  <link rel="canonical" href={url} />

  // Open Graph tags
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:type" content="article" />
  <meta property="og:url" content={url} />
  <meta property="og:image" content={ogImage || defaultOgImage} />
  <meta property="og:site_name" content="Edfolio" />
  <meta property="article:published_time" content={publishedAt.toISOString()} />

  // Twitter Card tags
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={ogImage || defaultOgImage} />
  ```
- [ ] Update `/app/public/[slug]/page.tsx` generateMetadata:
  - Use metaTitle if available, fallback to note.title
  - Use metaDescription if available, fallback to excerpt
  - Include all Open Graph properties
  - Add Twitter Card properties
  - Set canonical URL
- [ ] Create default OG image:
  - Store in `/public/og-default.png`
  - Size: 1200x630px (optimal for social media)
  - Simple branded image with Edfolio logo
  - Use Canva or similar tool to create
- [ ] Keep component under 150 lines

### Task 6: Create Social Preview Component (2.5 hours)
**Estimated Time:** 2.5 hours

- [ ] Create `/components/publish/SocialPreview.tsx` component
- [ ] Define SocialPreviewProps interface:
  - `metaTitle: string`
  - `metaDescription: string`
  - `ogImage: string`
  - `url: string`
- [ ] Implement preview card mockup:
  - **Facebook/LinkedIn Style:**
    - Image at top (1200x630 aspect ratio)
    - Title in bold (1-2 lines, truncate with ellipsis)
    - Description below (2-3 lines, truncate)
    - URL in small text at bottom
  - **Card Styling:**
    - Border: 1px solid var(--border)
    - Border radius: 8px
    - Max width: 500px
    - Background: var(--background)
    - Padding: var(--spacing-sm)
  - **Image Placeholder:**
    - If no ogImage, show default OG image
    - Aspect ratio: 1.91:1 (1200x630)
    - Background: var(--muted)
- [ ] Add tabs for different platform previews (future enhancement):
  - Default: Facebook/LinkedIn preview
  - Future: Twitter, Google Search preview
- [ ] Use CSS variables for all colors and spacing
- [ ] Keep component under 200 lines

### Task 7: Integrate PublishSettingsModal into Editor (2 hours)
**Estimated Time:** 2 hours

- [ ] Modify `/components/editor/PublishButton.tsx`
- [ ] Add state: `const [showSettings, setShowSettings] = useState(false)`
- [ ] Add state for current metadata:
  - `const [metaTitle, setMetaTitle] = useState<string | null>(null)`
  - `const [metaDescription, setMetaDescription] = useState<string | null>(null)`
  - `const [customSlug, setCustomSlug] = useState<string | null>(null)`
- [ ] Update button click behavior:
  - If not published: show PublishSettingsModal (pre-publish configuration)
  - If published: still show PublishSettingsModal (edit settings)
  - Remove direct publish action (now goes through modal)
- [ ] Fetch current metadata on component mount:
  - Call `/api/notes/[noteId]/publish/status` (update to include metadata)
  - Set metadata state
- [ ] Implement handleSaveSettings:
  - If not published: call POST /api/notes/[noteId]/publish with metadata
  - If published: call PATCH /api/notes/[noteId]/publish/metadata
  - On success: close modal, update state, show toast
  - On error: show error toast, keep modal open
- [ ] Render PublishSettingsModal:
  - Pass all current values as props
  - Pass noteId, noteTitle
  - Pass isPublished flag
  - Pass callbacks for save and close
- [ ] Keep file under 250 lines

### Task 8: Update Status Endpoint to Include Metadata (1 hour)
**Estimated Time:** 1 hour

- [ ] Open `/app/api/notes/[noteId]/publish/status/route.ts`
- [ ] Update response to include SEO metadata:
  ```typescript
  {
    isPublished: boolean,
    slug: string | null,
    metaTitle: string | null,
    metaDescription: string | null,
    customSlug: boolean,
  }
  ```
- [ ] Query PublishedPage with all fields:
  - `select: { isPublished, slug, metaTitle, metaDescription, customSlug }`
- [ ] Keep file under 150 lines

### Task 9: Add Slug Editing for Published Pages (1.5 hours)
**Estimated Time:** 1.5 hours

- [ ] In PublishSettingsModal, handle slug editing for published pages:
  - Show current slug in input (editable)
  - Warn user if changing slug: "Changing the URL will break existing links"
  - Add confirmation checkbox: "I understand this will change the public URL"
  - Disable save unless checkbox confirmed (when slug changed)
- [ ] Update metadata endpoint to handle slug changes:
  - Validate new slug (format, reserved, uniqueness)
  - Update slug in database
  - Return new public URL
- [ ] Show warning toast after slug change:
  - "URL updated. Old links will no longer work."
- [ ] Keep changes under 100 additional lines total

### Task 10: Add Character Counters for SEO Fields (1 hour)
**Estimated Time:** 1 hour

- [ ] Create `/components/publish/CharacterCounter.tsx` component
- [ ] Define CharacterCounterProps interface:
  - `current: number` - Current character count
  - `optimal: number` - Optimal length (e.g., 60, 160)
  - `max?: number` - Hard maximum (optional)
  - `label: string` - Field label
- [ ] Implement counter display:
  - Format: "45/60 characters (optimal)"
  - Color coding:
    - Green: within optimal range
    - Yellow: slightly over optimal but under max
    - Red: over max (if max specified)
  - Use CSS variables for colors
- [ ] Integrate into PublishSettingsModal:
  - Add counter below meta title input
  - Add counter below meta description textarea
  - Update counts on input change
- [ ] Keep component under 100 lines

### Task 11: Update PublicPageLayout to Use Metadata (1 hour)
**Estimated Time:** 1 hour

- [ ] Open `/components/public-page/PublicPageLayout.tsx`
- [ ] Update component to accept metadata props:
  - Add `metaTitle?: string` to props
  - Add `metaDescription?: string` to props
- [ ] Update page title rendering:
  - Use metaTitle if provided, fallback to title
- [ ] Update generateMetadata in public page route:
  - Use PublishedPage.metaTitle if available
  - Use PublishedPage.metaDescription if available
  - Include all Open Graph tags
  - Set og:image to default image
- [ ] Ensure meta tags render in HTML head (verify in browser dev tools)
- [ ] Keep changes minimal (under 50 additional lines)

### Task 12: Add Type Definitions for SEO Metadata (30 minutes)
**Estimated Time:** 30 minutes

- [ ] Open `/types/index.ts`
- [ ] Add interfaces for publish settings:
  ```typescript
  /**
   * Settings for publishing a page
   */
  export interface PublishSettings {
    customSlug?: string;
    metaTitle?: string;
    metaDescription?: string;
  }

  /**
   * Result of slug validation
   */
  export interface SlugValidationResult {
    valid: boolean;
    error?: string;
    suggestion?: string;
  }

  /**
   * Props for PublishSettingsModal component
   */
  export interface PublishSettingsModalProps {
    isOpen: boolean;
    noteId: string;
    noteTitle: string;
    currentSlug: string | null;
    currentMetaTitle: string | null;
    currentMetaDescription: string | null;
    isPublished: boolean;
    onSave: (settings: PublishSettings) => void;
    onClose: () => void;
  }

  /**
   * Props for SocialPreview component
   */
  export interface SocialPreviewProps {
    metaTitle: string;
    metaDescription: string;
    ogImage: string;
    url: string;
  }

  /**
   * Props for CharacterCounter component
   */
  export interface CharacterCounterProps {
    current: number;
    optimal: number;
    max?: number;
    label: string;
  }
  ```
- [ ] Export all new types
- [ ] Keep file under 300 lines

### Task 13: Testing & Validation (5 hours)
**Estimated Time:** 5 hours

- [ ] **Slug Validation Testing:**
  - [ ] Test valid slugs:
    - [ ] "my-first-post" → valid
    - [ ] "2024-guide" → valid
    - [ ] "hello-world-123" → valid
  - [ ] Test invalid slugs:
    - [ ] "My Post" (uppercase) → error
    - [ ] "post!" (special char) → error
    - [ ] "my--post" (consecutive hyphens) → error
    - [ ] "-my-post" (leading hyphen) → error
    - [ ] "my-post-" (trailing hyphen) → error
    - [ ] "ab" (too short) → error
    - [ ] "a".repeat(101) (too long) → error
  - [ ] Test reserved slugs:
    - [ ] "api" → blocked with error
    - [ ] "auth" → blocked with error
    - [ ] "admin" → blocked with error
    - [ ] "my-api-guide" → allowed (not reserved)
  - [ ] Test slug uniqueness:
    - [ ] Publish note with slug "test"
    - [ ] Attempt to use "test" again → error with suggestion "test-2"
    - [ ] Attempt "test-2" → error with suggestion "test-3"
- [ ] **Slug Editing Testing:**
  - [ ] Publish page with default slug
  - [ ] Edit slug in settings → save
  - [ ] Verify old URL returns 404
  - [ ] Verify new URL works
  - [ ] Verify warning displayed
  - [ ] Verify confirmation checkbox required
- [ ] **Meta Title/Description Testing:**
  - [ ] Leave fields empty → verify fallback to note title and excerpt
  - [ ] Add custom meta title → verify appears in:
    - [ ] Browser title bar
    - [ ] Social preview
    - [ ] HTML meta tags
  - [ ] Add custom meta description → verify appears in:
    - [ ] Social preview
    - [ ] HTML meta tags
  - [ ] Test character counters:
    - [ ] Type 60 chars in title → counter shows "60/60"
    - [ ] Type 61 chars → counter shows yellow/warning
    - [ ] Type 160 chars in description → counter shows "160/160"
- [ ] **Open Graph Tags Testing:**
  - [ ] Publish page with metadata
  - [ ] View HTML source of public page
  - [ ] Verify all OG tags present:
    - [ ] og:title
    - [ ] og:description
    - [ ] og:type = "article"
    - [ ] og:url (canonical)
    - [ ] og:image
    - [ ] og:site_name = "Edfolio"
  - [ ] Verify Twitter Card tags present
  - [ ] Test with Facebook Sharing Debugger:
    - [ ] https://developers.facebook.com/tools/debug/
    - [ ] Enter public URL, verify preview shows correctly
  - [ ] Test with Twitter Card Validator (if available)
- [ ] **Social Preview Testing:**
  - [ ] Open PublishSettingsModal
  - [ ] Verify preview card renders
  - [ ] Change meta title → preview updates
  - [ ] Change meta description → preview updates
  - [ ] Verify preview matches Facebook/LinkedIn style
  - [ ] Verify default OG image shows
- [ ] **Integration Testing:**
  - [ ] Full workflow:
    - [ ] Create new note
    - [ ] Click Publish
    - [ ] PublishSettingsModal opens
    - [ ] Edit slug, meta title, description
    - [ ] Preview shows changes
    - [ ] Save settings
    - [ ] Verify page published with custom metadata
    - [ ] Visit public URL
    - [ ] Verify metadata in HTML
  - [ ] Edit published page:
    - [ ] Open settings again
    - [ ] Change slug
    - [ ] Confirm warning
    - [ ] Save
    - [ ] Verify old URL 404, new URL works
- [ ] **Error Handling Testing:**
  - [ ] Test all error scenarios:
    - [ ] Reserved slug → clear error message
    - [ ] Duplicate slug → suggestion provided
    - [ ] Invalid format → specific format error
    - [ ] Network failure → retry option
    - [ ] 401/403 errors → auth error message
- [ ] **Build Validation:**
  - [ ] Run `npm run build` → zero errors
  - [ ] Verify no TypeScript errors
  - [ ] Verify no ESLint errors
- [ ] **Code Quality Checks:**
  - [ ] All components under 250 lines
  - [ ] All API routes under 200 lines
  - [ ] All utility files under 150 lines
  - [ ] No `any` types used
  - [ ] All colors use CSS variables
  - [ ] All spacing uses CSS variables
  - [ ] All imports use `@/` alias

## Dev Notes

### Architecture Overview

This story enhances Story 3.1's publishing infrastructure by adding customization and SEO capabilities. The architecture follows a progressive enhancement pattern:

**Default Behavior (Story 3.1):**
- Auto-generated slug from title
- Default meta tags (title = page title, description = excerpt)
- Basic Open Graph tags

**Enhanced Behavior (Story 3.2):**
- User can customize slug before or after publishing
- User can provide custom meta title and description
- Rich Open Graph tags for optimal social sharing
- Real-time slug validation prevents errors
- Social preview shows how page will appear when shared

**User Flow:**

1. **Pre-Publish Customization:**
   - User clicks "Publish" button
   - PublishSettingsModal opens
   - User sees suggested slug (from title)
   - User can edit slug, add meta title/description
   - Real-time validation ensures slug is valid and available
   - Preview shows how page will appear on social media
   - User saves → page published with custom metadata

2. **Post-Publish Editing:**
   - User clicks "Publish" button on published page
   - Modal opens with current settings
   - User can edit slug (with warning about breaking links)
   - User can edit meta title/description
   - Changes saved → public page updated

**Key Design Decisions:**

1. **Modal-Based Settings:** Instead of inline editing, use a modal for all publish settings. This provides focused UI and space for preview.

2. **Pre-Publish Configuration:** Show settings modal BEFORE first publish, allowing users to customize URL and metadata from the start.

3. **Real-Time Validation:** Validate slug as user types (debounced 300ms) to prevent errors at save time.

4. **Slug Change Warning:** When editing slug of published page, show clear warning about breaking existing links and require confirmation.

5. **Optional Metadata:** All SEO fields are optional with smart fallbacks (title → note title, description → excerpt).

6. **Character Guidance:** Show character counters with optimal lengths (not hard limits) to guide users toward SEO best practices.

### Database Schema Changes

**No new models required.** Story 3.1 already added PublishedPage with `metaTitle`, `metaDescription`, and `customSlug` fields. This story populates and uses those fields.

**Existing Schema (from Story 3.1):**
```prisma
model PublishedPage {
  id              String    @id @default(cuid())
  noteId          String    @unique
  slug            String    @unique
  customSlug      Boolean   @default(false)  // NEW: Used in this story
  isPublished     Boolean   @default(true)
  publishedAt     DateTime  @default(now())
  lastUpdated     DateTime  @updatedAt
  metaTitle       String?   @db.Text         // NEW: Used in this story
  metaDescription String?   @db.Text         // NEW: Used in this story
  ogImage         String?
  viewCount       Int       @default(0)
  lastViewed      DateTime?
  note            Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([noteId])
  @@index([publishedAt])
}
```

**No migration needed** - fields already exist from Story 3.1.

### Slug Validation Implementation

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/lib/slug-validation.ts`

**Validation Rules:**

1. **Format Validation:**
   - Length: 3-100 characters
   - Characters: lowercase letters, numbers, hyphens only
   - No consecutive hyphens (e.g., "my--post")
   - No leading/trailing hyphens
   - Must match regex: `/^[a-z0-9]+(?:-[a-z0-9]+)*$/`

2. **Reserved Slugs:**
   - Blocked: api, auth, admin, public, login, signup, settings, account
   - Case-insensitive check

3. **Uniqueness Check:**
   - Query database for existing PublishedPage with slug
   - Allow if no conflict
   - Allow if conflict is own note (noteId matches)
   - Block if conflict with different note
   - Generate suggestion with numeric suffix if blocked

**Implementation:**

```typescript
import { prisma } from '@/lib/prisma';
import { isReservedSlug } from './slug-generator';

export interface SlugValidationResult {
  valid: boolean;
  error?: string;
  suggestion?: string;
}

/**
 * Validate slug format and rules
 */
export function validateSlugFormat(slug: string): SlugValidationResult {
  // Length check
  if (slug.length < 3) {
    return {
      valid: false,
      error: 'Slug must be at least 3 characters long',
    };
  }

  if (slug.length > 100) {
    return {
      valid: false,
      error: 'Slug must be 100 characters or less',
    };
  }

  // Format check
  const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
  if (!slugRegex.test(slug)) {
    return {
      valid: false,
      error: 'Slug must be lowercase alphanumeric with hyphens only',
    };
  }

  // Reserved check
  if (isReservedSlug(slug)) {
    return {
      valid: false,
      error: 'This URL is reserved and cannot be used',
    };
  }

  return { valid: true };
}

/**
 * Check if slug is available (not taken by another note)
 */
export async function checkSlugAvailability(
  slug: string,
  noteId: string
): Promise<SlugValidationResult> {
  const existing = await prisma.publishedPage.findUnique({
    where: { slug },
    select: { noteId: true },
  });

  if (!existing) {
    return { valid: true };
  }

  if (existing.noteId === noteId) {
    // Own slug - allowed
    return { valid: true };
  }

  // Taken by another note - generate suggestion
  let suffix = 2;
  let suggestion = `${slug}-${suffix}`;

  while (suffix < 100) {
    const check = await prisma.publishedPage.findUnique({
      where: { slug: suggestion },
    });

    if (!check) {
      break;
    }

    suffix++;
    suggestion = `${slug}-${suffix}`;
  }

  return {
    valid: false,
    error: 'This URL is already taken',
    suggestion,
  };
}
```

**API Endpoint for Validation:**

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/app/api/publish/validate-slug/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { validateSlugFormat, checkSlugAvailability } from '@/lib/slug-validation';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { slug, noteId } = await request.json();

    // Format validation
    const formatResult = validateSlugFormat(slug);
    if (!formatResult.valid) {
      return NextResponse.json(formatResult);
    }

    // Availability check
    const availabilityResult = await checkSlugAvailability(slug, noteId);
    return NextResponse.json(availabilityResult);
  } catch (error) {
    console.error('Slug validation error:', error);
    return NextResponse.json(
      { valid: false, error: 'Validation failed' },
      { status: 500 }
    );
  }
}
```

### PublishSettingsModal Component

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/components/publish/PublishSettingsModal.tsx`

**Component Structure:**

```typescript
'use client';

import { useState, useCallback } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Loader2, CheckCircle, XCircle, AlertCircle } from 'lucide-react';
import { useDebouncedCallback } from 'use-debounce';
import { SocialPreview } from './SocialPreview';
import { CharacterCounter } from './CharacterCounter';
import { PublishSettingsModalProps } from '@/types';
import { generateSlugFromTitle } from '@/lib/slug-generator';

export function PublishSettingsModal({
  isOpen,
  noteId,
  noteTitle,
  currentSlug,
  currentMetaTitle,
  currentMetaDescription,
  isPublished,
  onSave,
  onClose,
}: PublishSettingsModalProps) {
  // Form state
  const [slug, setSlug] = useState(currentSlug || generateSlugFromTitle(noteTitle));
  const [metaTitle, setMetaTitle] = useState(currentMetaTitle || '');
  const [metaDescription, setMetaDescription] = useState(currentMetaDescription || '');

  // Validation state
  const [slugValidation, setSlugValidation] = useState<{
    status: 'idle' | 'validating' | 'valid' | 'invalid';
    error?: string;
    suggestion?: string;
  }>({ status: 'idle' });

  // Dirty state
  const isDirty =
    slug !== currentSlug ||
    metaTitle !== (currentMetaTitle || '') ||
    metaDescription !== (currentMetaDescription || '');

  // Slug changed warning
  const slugChanged = isPublished && slug !== currentSlug;
  const [confirmSlugChange, setConfirmSlugChange] = useState(false);

  // Debounced slug validation
  const validateSlug = useDebouncedCallback(async (value: string) => {
    setSlugValidation({ status: 'validating' });

    try {
      const response = await fetch('/api/publish/validate-slug', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: value, noteId }),
      });

      const result = await response.json();

      if (result.valid) {
        setSlugValidation({ status: 'valid' });
      } else {
        setSlugValidation({
          status: 'invalid',
          error: result.error,
          suggestion: result.suggestion,
        });
      }
    } catch (error) {
      setSlugValidation({
        status: 'invalid',
        error: 'Validation failed',
      });
    }
  }, 300);

  const handleSlugChange = useCallback(
    (value: string) => {
      setSlug(value);
      if (value.length >= 3) {
        validateSlug(value);
      }
    },
    [validateSlug]
  );

  const handleSave = () => {
    onSave({
      customSlug: slug,
      metaTitle: metaTitle || undefined,
      metaDescription: metaDescription || undefined,
    });
  };

  const canSave =
    isDirty &&
    slugValidation.status === 'valid' &&
    (!slugChanged || confirmSlugChange);

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {isPublished ? 'Edit Publish Settings' : 'Publish Page'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-[var(--spacing-lg)]">
          {/* URL Settings */}
          <div>
            <Label htmlFor="slug">Public URL</Label>
            <div className="flex items-center gap-[var(--spacing-sm)] mt-[var(--spacing-xs)]">
              <span className="text-sm text-[var(--muted)]">edfolio.app/public/</span>
              <div className="flex-1 relative">
                <Input
                  id="slug"
                  value={slug}
                  onChange={(e) => handleSlugChange(e.target.value)}
                  placeholder="my-page-url"
                />
                <div className="absolute right-2 top-1/2 -translate-y-1/2">
                  {slugValidation.status === 'validating' && (
                    <Loader2 className="h-4 w-4 animate-spin text-[var(--muted)]" />
                  )}
                  {slugValidation.status === 'valid' && (
                    <CheckCircle className="h-4 w-4 text-green-500" />
                  )}
                  {slugValidation.status === 'invalid' && (
                    <XCircle className="h-4 w-4 text-red-500" />
                  )}
                </div>
              </div>
            </div>
            {slugValidation.error && (
              <p className="text-sm text-red-500 mt-[var(--spacing-xs)]">
                {slugValidation.error}
                {slugValidation.suggestion && (
                  <> Try: <span className="font-mono">{slugValidation.suggestion}</span></>
                )}
              </p>
            )}
            {slugChanged && (
              <div className="mt-[var(--spacing-sm)] p-[var(--spacing-sm)] bg-yellow-50 border border-yellow-200 rounded">
                <div className="flex items-start gap-[var(--spacing-sm)]">
                  <AlertCircle className="h-5 w-5 text-yellow-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-yellow-900">
                      Warning: Changing the URL will break existing links
                    </p>
                    <label className="flex items-center gap-2 mt-2">
                      <input
                        type="checkbox"
                        checked={confirmSlugChange}
                        onChange={(e) => setConfirmSlugChange(e.target.checked)}
                      />
                      <span className="text-sm text-yellow-800">
                        I understand this will change the public URL
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* SEO Metadata */}
          <div>
            <Label htmlFor="metaTitle">Meta Title (Optional)</Label>
            <Input
              id="metaTitle"
              value={metaTitle}
              onChange={(e) => setMetaTitle(e.target.value)}
              placeholder={noteTitle}
              maxLength={120}
              className="mt-[var(--spacing-xs)]"
            />
            <CharacterCounter
              current={metaTitle.length}
              optimal={60}
              label="title"
            />
          </div>

          <div>
            <Label htmlFor="metaDescription">Meta Description (Optional)</Label>
            <Textarea
              id="metaDescription"
              value={metaDescription}
              onChange={(e) => setMetaDescription(e.target.value)}
              placeholder="Describe your page for search engines and social media..."
              rows={3}
              maxLength={320}
              className="mt-[var(--spacing-xs)]"
            />
            <CharacterCounter
              current={metaDescription.length}
              optimal={160}
              label="description"
            />
            <p className="text-xs text-[var(--muted)] mt-[var(--spacing-xs)]">
              This appears in search results and social media previews
            </p>
          </div>

          {/* Social Preview */}
          <div>
            <Label>Social Media Preview</Label>
            <SocialPreview
              metaTitle={metaTitle || noteTitle}
              metaDescription={metaDescription || 'Read this article on Edfolio.'}
              ogImage="/og-default.png"
              url={`edfolio.app/public/${slug}`}
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button onClick={handleSave} disabled={!canSave}>
            {isPublished ? 'Save Changes' : 'Publish'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Key Features:**
- Real-time slug validation with debouncing
- Visual validation indicators (spinner, checkmark, X)
- Slug change warning for published pages
- Character counters for SEO fields
- Social media preview
- Smart defaults (auto-generated slug, fallback to note title)

### Open Graph Meta Tags

**Complete meta tags structure for public pages:**

```typescript
// In generateMetadata function
export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const publishedPage = await prisma.publishedPage.findUnique({
    where: { slug: params.slug },
    include: {
      note: {
        select: { title: true, content: true },
      },
    },
  });

  if (!publishedPage || !publishedPage.isPublished) {
    return { title: 'Page Not Found' };
  }

  const title = publishedPage.metaTitle || publishedPage.note.title;
  const description =
    publishedPage.metaDescription ||
    extractExcerpt(publishedPage.note.content, 160);
  const url = `${process.env.NEXT_PUBLIC_BASE_URL}/public/${publishedPage.slug}`;
  const ogImage =
    publishedPage.ogImage || `${process.env.NEXT_PUBLIC_BASE_URL}/og-default.png`;

  return {
    title,
    description,
    openGraph: {
      title,
      description,
      url,
      siteName: 'Edfolio',
      type: 'article',
      publishedTime: publishedPage.publishedAt.toISOString(),
      images: [
        {
          url: ogImage,
          width: 1200,
          height: 630,
          alt: title,
        },
      ],
    },
    twitter: {
      card: 'summary_large_image',
      title,
      description,
      images: [ogImage],
    },
    alternates: {
      canonical: url,
    },
  };
}
```

### Social Preview Component

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/components/publish/SocialPreview.tsx`

```typescript
'use client';

import { SocialPreviewProps } from '@/types';

export function SocialPreview({
  metaTitle,
  metaDescription,
  ogImage,
  url,
}: SocialPreviewProps) {
  return (
    <div className="mt-[var(--spacing-sm)]">
      <div className="max-w-md border border-[var(--border)] rounded-lg overflow-hidden bg-[var(--background)]">
        {/* Image */}
        <div className="aspect-[1.91/1] bg-[var(--muted)] relative">
          <img
            src={ogImage}
            alt="Preview"
            className="w-full h-full object-cover"
          />
        </div>

        {/* Content */}
        <div className="p-[var(--spacing-sm)]">
          <p className="text-xs text-[var(--muted)] mb-[var(--spacing-xs)] truncate">
            {url}
          </p>
          <h3 className="font-semibold text-[var(--foreground)] line-clamp-2 mb-[var(--spacing-xs)]">
            {metaTitle}
          </h3>
          <p className="text-sm text-[var(--muted)] line-clamp-3">
            {metaDescription}
          </p>
        </div>
      </div>
      <p className="text-xs text-[var(--muted)] mt-[var(--spacing-xs)]">
        This is how your page will appear when shared on Facebook, LinkedIn, and Twitter.
      </p>
    </div>
  );
}
```

### Character Counter Component

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/components/publish/CharacterCounter.tsx`

```typescript
'use client';

import { CharacterCounterProps } from '@/types';

export function CharacterCounter({
  current,
  optimal,
  max,
  label,
}: CharacterCounterProps) {
  const isOptimal = current <= optimal;
  const isOverMax = max !== undefined && current > max;

  let color = 'var(--muted)';
  if (isOverMax) {
    color = 'red';
  } else if (!isOptimal && current > optimal) {
    color = 'orange';
  } else if (current > optimal * 0.8) {
    color = 'green';
  }

  return (
    <p className="text-xs mt-[var(--spacing-xs)]" style={{ color }}>
      {current}/{optimal} characters
      {isOptimal && ' (optimal)'}
      {!isOptimal && !isOverMax && ` (${current - optimal} over optimal)`}
      {isOverMax && ' (exceeds maximum!)'}
    </p>
  );
}
```

### API Endpoint Updates

**1. Update POST /api/notes/[noteId]/publish to accept metadata:**

```typescript
// In POST handler
const body = await request.json();
const { customSlug, metaTitle, metaDescription } = body;

// Determine slug
let slug: string;
if (customSlug) {
  // Validate custom slug
  const validation = validateSlugFormat(customSlug);
  if (!validation.valid) {
    return NextResponse.json(
      { error: validation.error },
      { status: 400 }
    );
  }
  slug = customSlug;
} else {
  // Generate from title
  const baseSlug = generateSlugFromTitle(note.title);
  slug = await generateUniqueSlug(baseSlug, noteId);
}

// Create/update PublishedPage
const publishedPage = await prisma.publishedPage.upsert({
  where: { noteId },
  create: {
    noteId,
    slug,
    customSlug: !!customSlug,
    metaTitle: metaTitle || null,
    metaDescription: metaDescription || null,
    isPublished: true,
  },
  update: {
    slug,
    customSlug: !!customSlug,
    metaTitle: metaTitle || null,
    metaDescription: metaDescription || null,
    isPublished: true,
    publishedAt: new Date(),
  },
});
```

**2. Create PATCH /api/notes/[noteId]/publish/metadata:**

**File Path:** `/Users/darrencoxon/Dropbox/Coxon team folder/coding_projects_25/edfolio/app/api/notes/[noteId]/publish/metadata/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/prisma';
import { validateSlugFormat } from '@/lib/slug-validation';

export async function PATCH(
  request: NextRequest,
  { params }: { params: { noteId: string } }
) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const noteId = params.noteId;
    const { customSlug, metaTitle, metaDescription } = await request.json();

    // Verify note ownership
    const note = await prisma.note.findUnique({
      where: { id: noteId },
      include: {
        folio: { select: { ownerId: true } },
        published: true,
      },
    });

    if (!note) {
      return NextResponse.json({ error: 'Note not found' }, { status: 404 });
    }

    if (note.folio.ownerId !== session.user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    if (!note.published || !note.published.isPublished) {
      return NextResponse.json(
        { error: 'Page is not published' },
        { status: 404 }
      );
    }

    // Validate slug if changed
    if (customSlug && customSlug !== note.published.slug) {
      const validation = validateSlugFormat(customSlug);
      if (!validation.valid) {
        return NextResponse.json(
          { error: validation.error },
          { status: 400 }
        );
      }

      // Check uniqueness
      const existing = await prisma.publishedPage.findUnique({
        where: { slug: customSlug },
      });

      if (existing && existing.noteId !== noteId) {
        return NextResponse.json(
          { error: 'Slug already taken' },
          { status: 409 }
        );
      }
    }

    // Update metadata
    const updated = await prisma.publishedPage.update({
      where: { noteId },
      data: {
        slug: customSlug || note.published.slug,
        customSlug: customSlug ? true : note.published.customSlug,
        metaTitle: metaTitle || null,
        metaDescription: metaDescription || null,
      },
    });

    return NextResponse.json({
      data: {
        slug: updated.slug,
        publicUrl: `/public/${updated.slug}`,
        metaTitle: updated.metaTitle,
        metaDescription: updated.metaDescription,
      },
    });
  } catch (error) {
    console.error('Update metadata error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### Testing Strategy

**Manual Testing:**

1. **Slug Validation:**
   - Open PublishSettingsModal
   - Type various slugs and verify validation
   - Test reserved slugs → error
   - Test invalid formats → error
   - Test duplicate slugs → error with suggestion

2. **Metadata Editing:**
   - Add meta title → verify preview updates
   - Add meta description → verify preview updates
   - Verify character counters work
   - Save and visit public page → verify meta tags in HTML

3. **Slug Editing:**
   - Publish page with default slug
   - Edit slug → verify warning appears
   - Confirm change → verify old URL 404, new URL works

4. **Social Sharing:**
   - Publish page with custom metadata
   - Test Facebook Sharing Debugger
   - Verify preview shows correct title, description, image

**Facebook Sharing Debugger:**
- URL: https://developers.facebook.com/tools/debug/
- Enter public page URL
- Verify preview matches social preview in modal

### Known Limitations

**Current Implementation:**
- Default OG image only (no custom image upload) - future enhancement
- Single social preview style (Facebook/LinkedIn) - Twitter/Google preview future
- No slug history/redirects - old slugs immediately 404 when changed
- Character counters are guidance only (no hard limits except database field limits)

**Future Enhancements (Out of Scope):**
- Custom OG image upload
- Auto-generated OG images (page screenshot)
- Multiple social preview styles (Twitter, Google Search)
- Slug redirect management (301 redirects from old to new slug)
- A/B testing for meta titles/descriptions
- SEO score/suggestions

### Timeline Estimate

**Total estimated time: 25 hours**

Breakdown:
- PublishSettingsModal: 3.5 hours
- Real-time slug validation: 2.5 hours
- Update publish API: 2 hours
- Metadata update endpoint: 1.5 hours
- Open Graph meta tags: 2 hours
- Social preview component: 2.5 hours
- Integrate into editor: 2 hours
- Update status endpoint: 1 hour
- Slug editing for published pages: 1.5 hours
- Character counters: 1 hour
- Update PublicPageLayout: 1 hour
- Type definitions: 0.5 hours
- Testing & validation: 5 hours

**Recommendation:** This story can be completed in 3-3.5 days. It builds cleanly on Story 3.1's foundation.

### Code Quality Checklist

Before marking story as "Review", Developer Agent MUST verify:

- [ ] No hardcoded colors (all use CSS variables)
- [ ] No hardcoded spacing (all use CSS variables)
- [ ] No `any` types in TypeScript
- [ ] All components under 250 lines
- [ ] All API routes under 200 lines
- [ ] All utility files under 150 lines
- [ ] Real-time validation works correctly
- [ ] All error states tested and handled
- [ ] Social preview renders correctly
- [ ] Open Graph tags present in public page HTML
- [ ] Character counters update in real-time
- [ ] Build succeeds with zero errors
- [ ] No TypeScript or ESLint errors
- [ ] All imports use `@/` alias

## Definition of Done

- [ ] PublishSettingsModal component created and functional
- [ ] Real-time slug validation implemented with debouncing
- [ ] Custom slug editing works for new and published pages
- [ ] Meta title and description fields functional with character counters
- [ ] Open Graph meta tags added to all public pages
- [ ] Social media preview shows in publish settings
- [ ] Slug uniqueness enforced across all pages
- [ ] Reserved slugs blocked with clear errors
- [ ] Slug change warning for published pages
- [ ] Facebook Sharing Debugger shows correct preview
- [ ] All acceptance criteria met and tested
- [ ] Build succeeds with zero errors
- [ ] Code follows all CLAUDE.md standards
