# Story 2.2: Backend AI Service Integration

**Status:** Review

## User Story

As a developer, I want to establish a secure connection to our chosen AI service, so that the application can send text for processing.

## Description

This story implements the backend infrastructure for connecting to Scaleway AI Generative APIs, ensuring UK/EU data residency compliance. It includes API route setup, authentication, error handling, and a basic test endpoint to verify the connection is working. Scaleway's Generative APIs are 100% European-hosted (France, Paris datacenter) and GDPR-compliant.

## Acceptance Criteria

- [x] A Next.js API route is created for AI service requests
- [x] The API route successfully connects to Scaleway AI Europe endpoint (https://api.scaleway.ai/v1)
- [x] All requests and data processing occur within UK/EU regions (GDPR compliant)
- [x] Proper error handling is implemented for API failures
- [x] Authentication and API key management is secure (using environment variables)
- [x] A test endpoint verifies the AI connection is working
- [x] Rate limiting and basic security measures are in place
- [x] The integration uses Scaleway's OpenAI-compatible API format
- [x] Environment variables are documented in .env.example

## Tasks / Subtasks

### Task 1: Set up Environment Configuration (1 hour)
- [x] Add Scaleway environment variables to `.env.example`:
  - `SCW_ACCESS_KEY` (Scaleway access key)
  - `SCW_SECRET_KEY` (Scaleway secret key - used for API authentication)
  - `SCW_DEFAULT_ORGANIZATION_ID` (Scaleway organization ID)
  - `SCW_DEFAULT_PROJECT_ID` (Scaleway project ID)
  - `SCW_REGION` (default: "fr-par" for France/Paris)
- [x] Verify environment variables are loaded correctly in development

### Task 2: Create Scaleway AI Client Utility (2 hours)
- [x] Create `/lib/ai/scaleway-client.ts` utility file
- [x] Implement authenticated request function to Scaleway API
- [x] Add TypeScript interfaces for Scaleway API request/response types
- [x] Implement error handling for common API errors (401, 429, 500, etc.)
- [x] Add timeout configuration (30 second default)
- [x] Include retry logic for transient failures (max 3 retries with exponential backoff)

### Task 3: Create API Route for AI Test Endpoint (2 hours)
- [x] Create `/app/api/ai/test/route.ts` API route
- [x] Implement POST handler that accepts a test message
- [x] Validate authentication (ensure user is logged in)
- [x] Call Scaleway API with a simple test prompt
- [x] Return response in standardized format: `{ data: { text: string }, message?: string }`
- [x] Implement comprehensive error handling with appropriate HTTP status codes

### Task 4: Implement Rate Limiting (1.5 hours)
- [x] Create rate limiting utility in `/lib/ai/rate-limiter.ts`
- [x] Implement per-user rate limiting (e.g., 10 requests per minute)
- [x] Store rate limit data in memory (using Map with TTL)
- [x] Return 429 status with retry-after header when limit exceeded
- [x] Add rate limit headers to all AI API responses (X-RateLimit-Limit, X-RateLimit-Remaining)

### Task 5: Write Integration Tests (2 hours)
- [x] Create test file `/app/api/ai/test/route.test.ts`
- [x] Mock Scaleway API responses
- [x] Test successful API call
- [x] Test authentication failure
- [x] Test rate limiting
- [x] Test error handling (API errors, network failures)
- [x] Test timeout handling

### Task 6: Documentation and Verification (0.5 hours)
- [x] Document Scaleway API integration in code comments
- [x] Verify all environment variables are in `.env.example`
- [x] Test manually with curl or Postman
- [x] Verify GDPR compliance (data stays in EU)
- [x] Update story file with implementation notes

## Dev Notes

### Scaleway AI Integration Overview

**Provider:** Scaleway Generative APIs (EU-based, GDPR-compliant)
**Region:** France, Paris (fr-par) - ALL data remains in EU
**API Compatibility:** OpenAI-compatible API format
**Base URL:** `https://api.scaleway.ai/v1`

### Required Environment Variables

Add these to `.env` and `.env.example`:

```bash
# Scaleway AI Configuration
SCW_ACCESS_KEY="your-scaleway-access-key"
SCW_SECRET_KEY="your-scaleway-secret-key"
SCW_DEFAULT_ORGANIZATION_ID="your-organization-id"
SCW_DEFAULT_PROJECT_ID="your-project-id"
SCW_REGION="fr-par"  # France, Paris datacenter
```

**Security Note:** Only `SCW_SECRET_KEY` is used for API authentication. Never expose this in client code.

### File Structure

```
lib/
├── ai/
│   ├── scaleway-client.ts      # Scaleway API client utility
│   ├── rate-limiter.ts          # Rate limiting utility
│   └── types.ts                 # TypeScript interfaces for AI requests/responses

app/api/ai/
├── test/
│   ├── route.ts                 # Test endpoint for AI connection
│   └── route.test.ts            # Integration tests
```

### Scaleway API Authentication

Scaleway uses Bearer token authentication with the secret key:

```typescript
headers: {
  'Authorization': `Bearer ${process.env.SCW_SECRET_KEY}`,
  'Content-Type': 'application/json'
}
```

### API Request Format (OpenAI-Compatible)

```typescript
// POST https://api.scaleway.ai/v1/chat/completions
{
  "model": "llama-3.1-8b-instruct",  // or other supported models
  "messages": [
    {
      "role": "user",
      "content": "Your text here"
    }
  ],
  "temperature": 0.7,  // optional, default 0.7
  "max_tokens": 1000   // optional, max response length
}
```

### API Response Format

```typescript
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1234567890,
  "model": "llama-3.1-8b-instruct",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Response text here"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 20,
    "total_tokens": 30
  }
}
```

### Scaleway Client Implementation (`lib/ai/scaleway-client.ts`)

**Key Requirements:**
1. Use singleton pattern (similar to Prisma client)
2. Implement exponential backoff retry logic
3. Add request timeout (30 seconds default)
4. Type-safe request/response interfaces
5. Comprehensive error handling

**TypeScript Interfaces:**

```typescript
// lib/ai/types.ts
export interface ScalewayMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

export interface ScalewayChatRequest {
  model: string;
  messages: ScalewayMessage[];
  temperature?: number;
  max_tokens?: number;
  top_p?: number;
  stream?: boolean;
}

export interface ScalewayChatResponse {
  id: string;
  object: string;
  created: number;
  model: string;
  choices: Array<{
    index: number;
    message: {
      role: string;
      content: string;
    };
    finish_reason: string;
  }>;
  usage: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}

export interface ScalewayError {
  error: {
    message: string;
    type: string;
    code?: string;
  };
}
```

**Error Handling:**

```typescript
// Map Scaleway API errors to user-friendly messages
const ERROR_MESSAGES: Record<number, string> = {
  401: 'AI service authentication failed',
  429: 'Too many requests. Please try again later.',
  500: 'AI service is temporarily unavailable',
  503: 'AI service is temporarily unavailable',
};
```

### API Route Implementation (`app/api/ai/test/route.ts`)

**Structure:**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { scalewayClient } from '@/lib/ai/scaleway-client';
import { checkRateLimit } from '@/lib/ai/rate-limiter';

export async function POST(request: NextRequest) {
  try {
    // 1. Validate authentication
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    // 2. Check rate limit
    const rateLimitResult = checkRateLimit(session.user.id);
    if (!rateLimitResult.allowed) {
      return NextResponse.json(
        { error: 'Rate limit exceeded' },
        {
          status: 429,
          headers: {
            'X-RateLimit-Limit': rateLimitResult.limit.toString(),
            'X-RateLimit-Remaining': '0',
            'Retry-After': rateLimitResult.retryAfter.toString()
          }
        }
      );
    }

    // 3. Parse and validate input
    const body = await request.json();
    const { message } = body;

    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: 'Invalid message' },
        { status: 400 }
      );
    }

    // 4. Call Scaleway AI
    const result = await scalewayClient.chat({
      model: 'llama-3.1-8b-instruct',
      messages: [
        { role: 'user', content: message }
      ],
      temperature: 0.7,
      max_tokens: 1000
    });

    // 5. Return response
    return NextResponse.json(
      {
        data: {
          text: result.choices[0].message.content,
          usage: result.usage
        }
      },
      {
        headers: {
          'X-RateLimit-Limit': rateLimitResult.limit.toString(),
          'X-RateLimit-Remaining': rateLimitResult.remaining.toString()
        }
      }
    );

  } catch (error) {
    console.error('AI test endpoint error:', error);

    // Handle specific error types
    if (error instanceof Error && 'status' in error) {
      const statusCode = (error as any).status;
      return NextResponse.json(
        { error: ERROR_MESSAGES[statusCode] || 'AI request failed' },
        { status: statusCode }
      );
    }

    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### Rate Limiting Implementation (`lib/ai/rate-limiter.ts`)

**Requirements:**
- Per-user rate limiting
- In-memory storage with TTL
- 10 requests per minute per user (configurable)
- Return remaining count and retry-after time

**Structure:**

```typescript
interface RateLimitEntry {
  count: number;
  resetTime: number;
}

const rateLimitMap = new Map<string, RateLimitEntry>();

const RATE_LIMIT = 10; // requests per minute
const WINDOW_MS = 60 * 1000; // 1 minute

export function checkRateLimit(userId: string): {
  allowed: boolean;
  limit: number;
  remaining: number;
  retryAfter?: number;
} {
  const now = Date.now();
  const entry = rateLimitMap.get(userId);

  // Clean up expired entries periodically
  if (Math.random() < 0.01) {
    cleanupExpiredEntries(now);
  }

  if (!entry || entry.resetTime < now) {
    // No entry or expired - create new window
    rateLimitMap.set(userId, {
      count: 1,
      resetTime: now + WINDOW_MS
    });
    return {
      allowed: true,
      limit: RATE_LIMIT,
      remaining: RATE_LIMIT - 1
    };
  }

  if (entry.count >= RATE_LIMIT) {
    // Rate limit exceeded
    return {
      allowed: false,
      limit: RATE_LIMIT,
      remaining: 0,
      retryAfter: Math.ceil((entry.resetTime - now) / 1000)
    };
  }

  // Increment count
  entry.count++;
  return {
    allowed: true,
    limit: RATE_LIMIT,
    remaining: RATE_LIMIT - entry.count
  };
}

function cleanupExpiredEntries(now: number) {
  for (const [key, value] of rateLimitMap.entries()) {
    if (value.resetTime < now) {
      rateLimitMap.delete(key);
    }
  }
}
```

### Testing Strategy

**Manual Testing with curl:**

```bash
# Test the AI endpoint
curl -X POST http://localhost:3000/api/ai/test \
  -H "Content-Type: application/json" \
  -H "Cookie: your-auth-cookie" \
  -d '{"message": "Hello, this is a test message"}'

# Expected response:
{
  "data": {
    "text": "AI response here",
    "usage": {
      "prompt_tokens": 10,
      "completion_tokens": 20,
      "total_tokens": 30
    }
  }
}
```

**Integration Tests:**

Test all scenarios:
1. ✅ Successful request with valid authentication
2. ❌ Unauthenticated request (401)
3. ❌ Invalid input (400)
4. ❌ Rate limit exceeded (429)
5. ❌ Scaleway API error (500/503)
6. ❌ Network timeout

### GDPR Compliance Verification

**Checklist:**
- [ ] Verify Scaleway region is set to "fr-par" (France, Paris)
- [ ] Confirm no data is sent to US-based services
- [ ] Verify API endpoint is `https://api.scaleway.ai/v1` (EU-hosted)
- [ ] Document data residency in code comments
- [ ] Test that all API calls go to EU endpoints

**Data Flow:**
1. User text is sent from client to Next.js API route (same server)
2. Next.js API route sends text to Scaleway AI (France datacenter)
3. Response flows back through the same path
4. No data leaves EU at any point

### Available Scaleway Models

For this story, use `llama-3.1-8b-instruct` as the default model. Other models available:
- `llama-3.1-8b-instruct` - Fast, general-purpose
- `llama-3.1-70b-instruct` - Higher quality, slower
- `mixtral-8x7b-instruct` - Good balance

Model selection will be configurable in future stories.

### Error Scenarios to Handle

1. **Authentication Errors (401):**
   - Invalid or missing SCW_SECRET_KEY
   - Expired credentials

2. **Rate Limiting (429):**
   - Scaleway API rate limits
   - Our application rate limits

3. **Server Errors (500/503):**
   - Scaleway API downtime
   - Network connectivity issues

4. **Timeout Errors:**
   - Request takes longer than 30 seconds
   - Network latency issues

5. **Validation Errors (400):**
   - Missing or invalid request parameters
   - Malformed JSON

### Performance Considerations

- **Timeout:** Set to 30 seconds to prevent hanging requests
- **Retry Logic:** Max 3 retries with exponential backoff (1s, 2s, 4s)
- **Rate Limiting:** 10 requests per minute per user (prevents abuse)
- **Caching:** Not applicable for this story (future enhancement)

### Security Best Practices

1. **Never expose API keys in client code**
2. **Always validate authentication before AI calls**
3. **Sanitize user input** (prevent prompt injection)
4. **Implement rate limiting** (prevent abuse)
5. **Log errors** (but not sensitive data)
6. **Use HTTPS only** (enforced by Next.js in production)

### Dependencies

**No new npm packages required** - Use native fetch API for HTTP requests.

If you need OpenAI SDK compatibility:
```bash
pnpm add openai
```

Then configure it to use Scaleway endpoint:
```typescript
import OpenAI from 'openai';

const client = new OpenAI({
  apiKey: process.env.SCW_SECRET_KEY,
  baseURL: 'https://api.scaleway.ai/v1'
});
```

However, for this story, **use native fetch** to minimize dependencies.

### Code Quality Checklist

Before marking this story as "Review":

- [ ] No hardcoded API keys or secrets
- [ ] All environment variables in `.env.example`
- [ ] TypeScript types defined (no `any`)
- [ ] Error handling for all API calls
- [ ] Rate limiting implemented and tested
- [ ] Integration tests written and passing
- [ ] Authentication verified on all endpoints
- [ ] GDPR compliance verified (EU region)
- [ ] Code under 200 lines per file
- [ ] All imports use `@/` alias

### Future Enhancements (Not in this story)

- Streaming responses for real-time output
- Multiple model support with dynamic selection
- Persistent rate limiting (using database or Redis)
- Request/response logging for analytics
- Cost tracking per user

---

## QA Results

_To be completed by QA Agent_

## Dev Agent Record

**Implementation Date:** October 21, 2025
**All tasks completed:** ✓
**All tests passing:** ✓
**Files Changed:** 6 files created

### Complete File List:

**Files Created:**
- `.env.example` (modified - added Scaleway AI environment variables)
- `lib/ai/types.ts` - TypeScript type definitions for Scaleway AI API
- `lib/ai/scaleway-client.ts` - Scaleway AI client utility with retry logic and error handling
- `lib/ai/rate-limiter.ts` - Per-user rate limiting utility
- `app/api/ai/test/route.ts` - AI test endpoint API route
- `app/api/ai/test/route.test.ts` - Comprehensive integration tests

**Files Modified:**
- `.env.example` - Added Scaleway AI configuration with GDPR compliance comments

### Implementation Summary:

All tasks from Story 2.2 have been successfully completed:

1. **Environment Configuration**: Added all required Scaleway environment variables to `.env.example` with clear documentation and GDPR compliance notes.

2. **TypeScript Type Definitions**: Created comprehensive type interfaces for Scaleway API requests/responses in `lib/ai/types.ts`, ensuring type safety throughout the integration.

3. **Scaleway AI Client**: Implemented a robust client utility with:
   - Singleton pattern (similar to Prisma client)
   - Exponential backoff retry logic (max 3 retries)
   - 30-second timeout configuration
   - Comprehensive error handling for all HTTP status codes
   - Type-safe request/response interfaces
   - Custom ScalewayAPIError class for better error handling

4. **Rate Limiting**: Created an in-memory rate limiter with:
   - Per-user tracking (10 requests per minute)
   - Automatic cleanup of expired entries
   - TTL-based sliding window implementation
   - Proper rate limit headers in responses
   - Helper functions for testing (resetRateLimit, getRateLimitStatus)

5. **API Test Endpoint**: Implemented `/app/api/ai/test` route with:
   - Authentication validation using NextAuth
   - Input validation (message length, type checking)
   - Rate limit checking
   - Scaleway API integration
   - Standardized response format
   - Comprehensive error handling for all scenarios

6. **Integration Tests**: Created extensive test suite covering:
   - Authentication validation (2 tests)
   - Input validation (4 tests)
   - Rate limiting (2 tests)
   - Successful AI requests (1 test)
   - Error handling (6 tests covering 401, 429, 500, 503, 408, and generic errors)
   - All 15 tests passing

### Code Quality Verification:

- [x] No hardcoded colors or spacing values (N/A for backend)
- [x] All CSS uses variables from `globals.css` (N/A for backend)
- [x] No `any` types in TypeScript
- [x] All components under 250 lines (longest file: scaleway-client.ts at ~200 lines)
- [x] Prisma migrations generated and committed (N/A - no database changes)
- [x] API routes have error handling
- [x] Components have proper TypeScript interfaces
- [x] Tests written for new functionality
- [x] No console.logs in production code (only in error handlers for debugging)
- [x] All imports use `@/` alias for consistency
- [x] Environment variables documented in `.env.example`

### GDPR Compliance:

- [x] Scaleway region set to "fr-par" (France, Paris datacenter)
- [x] All API calls go to `https://api.scaleway.ai/v1` (EU-hosted)
- [x] No data transmission to US servers
- [x] Data residency documented in code comments
- [x] GDPR compliance noted in `.env.example`

### Testing Results:

All 15 integration tests passing:
```
Test Suites: 1 passed, 1 total
Tests:       15 passed, 15 total
```

Test coverage includes:
- Authentication scenarios
- Input validation edge cases
- Rate limiting behavior
- Successful AI requests
- All error scenarios (401, 429, 500, 503, 408, generic)

### Notes:

1. **Native Fetch API**: Used native fetch API as specified in Dev Notes, avoiding external dependencies like the OpenAI SDK.

2. **Singleton Pattern**: Scaleway client follows the same singleton pattern as Prisma client for consistency.

3. **Error Messages**: All error messages are user-friendly and don't expose internal implementation details.

4. **Rate Limiting**: Currently in-memory; future stories may implement persistent storage with Redis or database.

5. **Default Model**: Using `llama-3.1-8b-instruct` as the default model as specified in Dev Notes.

6. **Security**: API keys are never exposed in client code and are only accessed via environment variables on the server.

### Ready for QA Review:

This story is complete and ready for QA testing. The QA agent should:
1. Verify all environment variables are properly documented
2. Test the `/api/ai/test` endpoint with valid Scaleway credentials
3. Verify rate limiting works correctly
4. Confirm GDPR compliance (EU data residency)
5. Run the test suite to ensure all tests pass
